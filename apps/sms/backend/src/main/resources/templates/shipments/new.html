<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}"
      lang="ja">
<head>
    <title>出荷登録</title>
</head>
<body>
<div layout:fragment="content">
    <h1 class="page-title">出荷登録</h1>

    <!-- アクションボタン -->
    <div class="action-buttons">
        <a th:href="@{/shipments}" class="btn btn-outline-secondary">戻る</a>
    </div>

    <form th:action="@{/shipments}" th:object="${form}" method="post">
        <!-- 出荷ヘッダー -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">出荷情報</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- 出荷日 -->
                    <div class="col-md-3">
                        <label class="form-label required">出荷日</label>
                        <input type="date" th:field="*{shipmentDate}"
                               class="form-control" th:classappend="${#fields.hasErrors('shipmentDate')} ? 'is-invalid'">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('shipmentDate')}"
                             th:errors="*{shipmentDate}"></div>
                    </div>

                    <!-- 受注参照 -->
                    <div class="col-md-4">
                        <label class="form-label">受注番号</label>
                        <select th:field="*{orderId}" class="form-select">
                            <option value="">選択してください</option>
                            <option th:each="order : ${orders}"
                                    th:value="${order.id}"
                                    th:text="${order.orderNumber + ' - ' + order.customerCode}">
                            </option>
                        </select>
                    </div>

                    <!-- 顧客 -->
                    <div class="col-md-4">
                        <label class="form-label required">顧客</label>
                        <select th:field="*{customerCode}"
                                class="form-select" th:classappend="${#fields.hasErrors('customerCode')} ? 'is-invalid'">
                            <option value="">選択してください</option>
                            <option th:each="cust : ${customers}"
                                    th:value="${cust.partnerCode}"
                                    th:text="${cust.partnerCode + ' - ' + cust.partnerName}">
                            </option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('customerCode')}"
                             th:errors="*{customerCode}"></div>
                    </div>

                    <!-- 顧客枝番 -->
                    <div class="col-md-2">
                        <label class="form-label">枝番</label>
                        <input type="text" th:field="*{customerBranchNumber}"
                               class="form-control" placeholder="00">
                    </div>

                    <!-- 届け先名 -->
                    <div class="col-md-5">
                        <label class="form-label">届け先名</label>
                        <input type="text" th:field="*{shippingDestinationName}" class="form-control">
                    </div>

                    <!-- 届け先郵便番号 -->
                    <div class="col-md-2">
                        <label class="form-label">郵便番号</label>
                        <input type="text" th:field="*{shippingDestinationPostalCode}"
                               class="form-control" placeholder="123-4567">
                    </div>

                    <!-- 届け先住所1 -->
                    <div class="col-md-5">
                        <label class="form-label">住所1</label>
                        <input type="text" th:field="*{shippingDestinationAddress1}" class="form-control">
                    </div>

                    <!-- 届け先住所2 -->
                    <div class="col-md-5">
                        <label class="form-label">住所2</label>
                        <input type="text" th:field="*{shippingDestinationAddress2}" class="form-control">
                    </div>

                    <!-- 倉庫コード -->
                    <div class="col-md-3">
                        <label class="form-label">倉庫コード</label>
                        <input type="text" th:field="*{warehouseCode}" class="form-control">
                    </div>

                    <!-- 備考 -->
                    <div class="col-md-12">
                        <label class="form-label">備考</label>
                        <textarea th:field="*{remarks}" class="form-control" rows="2"
                                  th:classappend="${#fields.hasErrors('remarks')} ? 'is-invalid'"></textarea>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('remarks')}"
                             th:errors="*{remarks}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 出荷明細 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">出荷明細</h5>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        hx-get="/shipments/add-detail-row"
                        hx-target="#detail-rows"
                        hx-swap="beforeend"
                        hx-vals='js:{"index": document.querySelectorAll("#detail-rows tr").length}'>
                    行追加
                </button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped mb-0 detail-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">商品</th>
                            <th style="width: 20%">商品名</th>
                            <th style="width: 10%">出荷数量</th>
                            <th style="width: 8%">単位</th>
                            <th style="width: 12%">単価</th>
                            <th style="width: 12%">金額</th>
                            <th style="width: 8%"></th>
                        </tr>
                    </thead>
                    <tbody id="detail-rows">
                        <tr th:each="detail, stat : ${form.details}" th:id="'row-' + ${stat.index}">
                            <td>
                                <input type="hidden" th:name="'details[' + ${stat.index} + '].orderDetailId'"
                                       th:value="${detail.orderDetailId}">
                                <select th:name="'details[' + ${stat.index} + '].productCode'"
                                        class="form-select product-select"
                                        onchange="updateProductInfo(this)">
                                    <option value="">選択</option>
                                    <option th:each="prod : ${products}"
                                            th:value="${prod.productCode}"
                                            th:text="${prod.productCode + ' - ' + prod.productName}"
                                            th:data-name="${prod.productName}"
                                            th:data-price="${prod.sellingPrice}"
                                            th:selected="${detail.productCode == prod.productCode}">
                                    </option>
                                </select>
                            </td>
                            <td>
                                <input type="text" th:name="'details[' + ${stat.index} + '].productName'"
                                       th:value="${detail.productName}"
                                       class="form-control product-name" readonly>
                            </td>
                            <td>
                                <input type="number" th:name="'details[' + ${stat.index} + '].shippedQuantity'"
                                       th:value="${detail.shippedQuantity}"
                                       class="form-control text-end quantity-input" min="1" step="1"
                                       onchange="calculateAmount(this)">
                            </td>
                            <td>
                                <input type="text" th:name="'details[' + ${stat.index} + '].unit'"
                                       th:value="${detail.unit}"
                                       class="form-control unit-input">
                            </td>
                            <td>
                                <input type="number" th:name="'details[' + ${stat.index} + '].unitPrice'"
                                       th:value="${detail.unitPrice}"
                                       class="form-control text-end price-input" min="0" step="1"
                                       onchange="calculateAmount(this)">
                            </td>
                            <td>
                                <input type="text" class="form-control text-end amount-display" readonly
                                       th:value="${detail.shippedQuantity != null and detail.unitPrice != null ? detail.shippedQuantity * detail.unitPrice : 0}">
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="removeRow(this)">削除</button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="5" class="text-end fw-bold">合計</td>
                            <td>
                                <input type="text" id="total-amount" class="form-control text-end fw-bold" readonly value="0">
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- ボタン -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">登録</button>
            <a th:href="@{/shipments}" class="btn btn-outline-secondary btn-lg">キャンセル</a>
        </div>
    </form>
</div>

<th:block layout:fragment="scripts">
<script th:inline="javascript">
    // 商品選択時に商品情報を更新
    function updateProductInfo(select) {
        const row = select.closest('tr');
        const option = select.options[select.selectedIndex];

        if (option.value) {
            row.querySelector('.product-name').value = option.dataset.name || '';
            row.querySelector('.price-input').value = option.dataset.price || 0;
            row.querySelector('.unit-input').value = '個';
        } else {
            row.querySelector('.product-name').value = '';
            row.querySelector('.price-input').value = 0;
        }
        calculateAmount(select);
    }

    // 金額を計算
    function calculateAmount(input) {
        const row = input.closest('tr');
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const amount = quantity * price;
        row.querySelector('.amount-display').value = amount.toLocaleString();
        calculateTotal();
    }

    // 合計を計算
    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.amount-display').forEach(input => {
            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
            total += value;
        });
        document.getElementById('total-amount').value = total.toLocaleString();
    }

    // 行を削除
    function removeRow(button) {
        const tbody = document.getElementById('detail-rows');
        if (tbody.querySelectorAll('tr').length > 1) {
            button.closest('tr').remove();
            reindexRows();
            calculateTotal();
        } else {
            alert('最低1行は必要です');
        }
    }

    // 行のインデックスを再設定
    function reindexRows() {
        document.querySelectorAll('#detail-rows tr').forEach((row, index) => {
            row.id = 'row-' + index;
            row.querySelectorAll('[name]').forEach(input => {
                input.name = input.name.replace(/details\[\d+\]/, 'details[' + index + ']');
            });
        });
    }

    // 初期計算
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.quantity-input').forEach(input => {
            calculateAmount(input);
        });
    });

    // htmx イベント後の処理
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'detail-rows') {
            // 新しく追加された行に対して初期化処理
            const newRow = event.detail.target.lastElementChild;
            if (newRow) {
                calculateAmount(newRow.querySelector('.quantity-input'));
            }
        }
    });
</script>
</th:block>
</body>
</html>
