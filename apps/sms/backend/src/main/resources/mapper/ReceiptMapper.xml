<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.sms.infrastructure.out.persistence.mapper.ReceiptMapper">

    <resultMap id="ReceiptResultMap" type="com.example.sms.domain.model.receipt.Receipt">
        <id property="id" column="ID"/>
        <result property="receiptNumber" column="入金番号"/>
        <result property="receiptDate" column="入金日"/>
        <result property="customerCode" column="顧客コード"/>
        <result property="customerBranchNumber" column="顧客枝番"/>
        <result property="receiptMethod" column="入金方法"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.ReceiptMethodTypeHandler"/>
        <result property="receiptAmount" column="入金金額"/>
        <result property="appliedAmount" column="消込済金額"/>
        <result property="unappliedAmount" column="未消込金額"/>
        <result property="bankFee" column="手数料"/>
        <result property="payerName" column="振込名義"/>
        <result property="bankName" column="銀行名"/>
        <result property="accountNumber" column="口座番号"/>
        <result property="status" column="ステータス"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler"/>
        <result property="remarks" column="備考"/>
        <result property="version" column="バージョン"/>
        <result property="createdAt" column="作成日時"/>
        <result property="createdBy" column="作成者"/>
        <result property="updatedAt" column="更新日時"/>
        <result property="updatedBy" column="更新者"/>
        <collection property="applications" ofType="com.example.sms.domain.model.receipt.ReceiptApplication"
                    select="findApplicationsByReceiptId" column="ID"/>
    </resultMap>

    <resultMap id="ReceiptApplicationResultMap" type="com.example.sms.domain.model.receipt.ReceiptApplication">
        <id property="id" column="ID"/>
        <result property="receiptId" column="入金ID"/>
        <result property="lineNumber" column="行番号"/>
        <result property="invoiceId" column="請求ID"/>
        <result property="applicationDate" column="消込日"/>
        <result property="appliedAmount" column="消込金額"/>
        <result property="remarks" column="備考"/>
        <result property="version" column="バージョン"/>
        <result property="createdAt" column="作成日時"/>
    </resultMap>

    <!-- 入金（ヘッダ）+ 入金消込明細のネスト ResultMap（JOINによる一括取得用） -->
    <resultMap id="receiptWithApplicationsResultMap" type="com.example.sms.domain.model.receipt.Receipt">
        <id property="id" column="r_id"/>
        <result property="receiptNumber" column="r_入金番号"/>
        <result property="receiptDate" column="r_入金日"/>
        <result property="customerCode" column="r_顧客コード"/>
        <result property="customerBranchNumber" column="r_顧客枝番"/>
        <result property="receiptMethod" column="r_入金方法"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.ReceiptMethodTypeHandler"/>
        <result property="receiptAmount" column="r_入金金額"/>
        <result property="appliedAmount" column="r_消込済金額"/>
        <result property="unappliedAmount" column="r_未消込金額"/>
        <result property="bankFee" column="r_手数料"/>
        <result property="payerName" column="r_振込名義"/>
        <result property="bankName" column="r_銀行名"/>
        <result property="accountNumber" column="r_口座番号"/>
        <result property="status" column="r_ステータス"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler"/>
        <result property="remarks" column="r_備考"/>
        <result property="version" column="r_バージョン"/>
        <result property="createdAt" column="r_作成日時"/>
        <result property="createdBy" column="r_作成者"/>
        <result property="updatedAt" column="r_更新日時"/>
        <result property="updatedBy" column="r_更新者"/>
        <!-- 入金消込明細との1:N関連 -->
        <collection property="applications" ofType="com.example.sms.domain.model.receipt.ReceiptApplication"
                    resultMap="receiptApplicationNestedResultMap"/>
    </resultMap>

    <!-- 入金消込明細のネスト ResultMap -->
    <resultMap id="receiptApplicationNestedResultMap" type="com.example.sms.domain.model.receipt.ReceiptApplication">
        <id property="id" column="a_id"/>
        <result property="receiptId" column="a_入金ID"/>
        <result property="lineNumber" column="a_行番号"/>
        <result property="invoiceId" column="a_請求ID"/>
        <result property="applicationDate" column="a_消込日"/>
        <result property="appliedAmount" column="a_消込金額"/>
        <result property="remarks" column="a_備考"/>
        <result property="version" column="a_バージョン"/>
        <result property="createdAt" column="a_作成日時"/>
    </resultMap>

    <insert id="insertHeader" parameterType="com.example.sms.domain.model.receipt.Receipt"
            useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO "入金データ" (
            "入金番号", "入金日", "顧客コード", "顧客枝番", "入金方法",
            "入金金額", "消込済金額", "未消込金額", "手数料",
            "振込名義", "銀行名", "口座番号", "ステータス", "備考",
            "作成日時", "作成者", "更新日時", "更新者", "バージョン"
        ) VALUES (
            #{receiptNumber}, #{receiptDate}, #{customerCode}, #{customerBranchNumber},
            #{receiptMethod, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptMethodTypeHandler}::入金方法,
            #{receiptAmount}, #{appliedAmount}, #{unappliedAmount}, #{bankFee},
            #{payerName}, #{bankName}, #{accountNumber},
            #{status, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler}::入金ステータス,
            #{remarks}, CURRENT_TIMESTAMP, #{createdBy}, CURRENT_TIMESTAMP, #{updatedBy}, 1
        )
    </insert>

    <insert id="insertApplication" parameterType="com.example.sms.domain.model.receipt.ReceiptApplication"
            useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO "入金消込明細" (
            "入金ID", "行番号", "請求ID", "消込日", "消込金額",
            "備考", "作成日時", "バージョン"
        ) VALUES (
            #{receiptId}, #{lineNumber}, #{invoiceId}, #{applicationDate}, #{appliedAmount},
            #{remarks}, CURRENT_TIMESTAMP, 1
        )
    </insert>

    <select id="findById" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ" WHERE "ID" = #{id}
    </select>

    <select id="findByReceiptNumber" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ" WHERE "入金番号" = #{receiptNumber}
    </select>

    <select id="findByCustomerCode" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ"
        WHERE "顧客コード" = #{customerCode}
        ORDER BY "入金日" DESC, "入金番号"
    </select>

    <select id="findByStatus" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ"
        WHERE "ステータス" = #{status, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler}::入金ステータス
        ORDER BY "入金日" DESC, "入金番号"
    </select>

    <select id="findByReceiptDateBetween" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ"
        WHERE "入金日" BETWEEN #{from} AND #{to}
        ORDER BY "入金日" DESC, "入金番号"
    </select>

    <select id="sumReceiptsByCustomerAndDateRange" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM("入金金額"), 0)
        FROM "入金データ"
        WHERE "顧客コード" = #{customerCode}
        AND "入金日" BETWEEN #{from} AND #{to}
    </select>

    <select id="findAll" resultMap="ReceiptResultMap">
        SELECT * FROM "入金データ" ORDER BY "入金日" DESC, "入金番号"
    </select>

    <select id="findApplicationsByReceiptId" resultMap="ReceiptApplicationResultMap">
        SELECT * FROM "入金消込明細"
        WHERE "入金ID" = #{receiptId}
        ORDER BY "行番号"
    </select>

    <!-- JOIN による一括取得クエリ（入金番号指定） -->
    <select id="findWithApplicationsByReceiptNumber" resultMap="receiptWithApplicationsResultMap">
        SELECT
            r."ID" AS r_id,
            r."入金番号" AS r_入金番号,
            r."入金日" AS r_入金日,
            r."顧客コード" AS r_顧客コード,
            r."顧客枝番" AS r_顧客枝番,
            r."入金方法" AS r_入金方法,
            r."入金金額" AS r_入金金額,
            r."消込済金額" AS r_消込済金額,
            r."未消込金額" AS r_未消込金額,
            r."手数料" AS r_手数料,
            r."振込名義" AS r_振込名義,
            r."銀行名" AS r_銀行名,
            r."口座番号" AS r_口座番号,
            r."ステータス" AS r_ステータス,
            r."備考" AS r_備考,
            r."バージョン" AS r_バージョン,
            r."作成日時" AS r_作成日時,
            r."作成者" AS r_作成者,
            r."更新日時" AS r_更新日時,
            r."更新者" AS r_更新者,
            a."ID" AS a_id,
            a."入金ID" AS a_入金ID,
            a."行番号" AS a_行番号,
            a."請求ID" AS a_請求ID,
            a."消込日" AS a_消込日,
            a."消込金額" AS a_消込金額,
            a."備考" AS a_備考,
            a."バージョン" AS a_バージョン,
            a."作成日時" AS a_作成日時
        FROM "入金データ" r
        LEFT JOIN "入金消込明細" a
            ON r."ID" = a."入金ID"
        WHERE r."入金番号" = #{receiptNumber}
        ORDER BY a."行番号"
    </select>

    <!-- JOIN による一括取得クエリ（ID指定） -->
    <select id="findByIdWithApplications" resultMap="receiptWithApplicationsResultMap">
        SELECT
            r."ID" AS r_id,
            r."入金番号" AS r_入金番号,
            r."入金日" AS r_入金日,
            r."顧客コード" AS r_顧客コード,
            r."顧客枝番" AS r_顧客枝番,
            r."入金方法" AS r_入金方法,
            r."入金金額" AS r_入金金額,
            r."消込済金額" AS r_消込済金額,
            r."未消込金額" AS r_未消込金額,
            r."手数料" AS r_手数料,
            r."振込名義" AS r_振込名義,
            r."銀行名" AS r_銀行名,
            r."口座番号" AS r_口座番号,
            r."ステータス" AS r_ステータス,
            r."備考" AS r_備考,
            r."バージョン" AS r_バージョン,
            r."作成日時" AS r_作成日時,
            r."作成者" AS r_作成者,
            r."更新日時" AS r_更新日時,
            r."更新者" AS r_更新者,
            a."ID" AS a_id,
            a."入金ID" AS a_入金ID,
            a."行番号" AS a_行番号,
            a."請求ID" AS a_請求ID,
            a."消込日" AS a_消込日,
            a."消込金額" AS a_消込金額,
            a."備考" AS a_備考,
            a."バージョン" AS a_バージョン,
            a."作成日時" AS a_作成日時
        FROM "入金データ" r
        LEFT JOIN "入金消込明細" a
            ON r."ID" = a."入金ID"
        WHERE r."ID" = #{id}
        ORDER BY a."行番号"
    </select>

    <!-- バージョン取得（楽観ロック用） -->
    <select id="findVersionById" resultType="java.lang.Integer">
        SELECT "バージョン" FROM "入金データ" WHERE "ID" = #{id}
    </select>

    <update id="updateHeader" parameterType="com.example.sms.domain.model.receipt.Receipt">
        UPDATE "入金データ" SET
            "入金日" = #{receiptDate},
            "顧客コード" = #{customerCode},
            "顧客枝番" = #{customerBranchNumber},
            "入金方法" = #{receiptMethod, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptMethodTypeHandler}::入金方法,
            "入金金額" = #{receiptAmount},
            "消込済金額" = #{appliedAmount},
            "未消込金額" = #{unappliedAmount},
            "手数料" = #{bankFee},
            "振込名義" = #{payerName},
            "銀行名" = #{bankName},
            "口座番号" = #{accountNumber},
            "ステータス" = #{status, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler}::入金ステータス,
            "備考" = #{remarks},
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者" = #{updatedBy},
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{id}
    </update>

    <!-- 楽観ロック対応の更新（バージョンチェック付き） -->
    <update id="updateWithOptimisticLock" parameterType="com.example.sms.domain.model.receipt.Receipt">
        UPDATE "入金データ" SET
            "入金日" = #{receiptDate},
            "顧客コード" = #{customerCode},
            "顧客枝番" = #{customerBranchNumber},
            "入金方法" = #{receiptMethod, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptMethodTypeHandler}::入金方法,
            "入金金額" = #{receiptAmount},
            "消込済金額" = #{appliedAmount},
            "未消込金額" = #{unappliedAmount},
            "手数料" = #{bankFee},
            "振込名義" = #{payerName},
            "銀行名" = #{bankName},
            "口座番号" = #{accountNumber},
            "ステータス" = #{status, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler}::入金ステータス,
            "備考" = #{remarks},
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者" = #{updatedBy},
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{id}
        AND "バージョン" = #{version}
    </update>

    <update id="updateAmounts">
        UPDATE "入金データ" SET
            "消込済金額" = #{appliedAmount},
            "未消込金額" = #{unappliedAmount},
            "更新日時" = CURRENT_TIMESTAMP,
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{receiptId}
    </update>

    <update id="updateStatus">
        UPDATE "入金データ" SET
            "ステータス" = #{status, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.ReceiptStatusTypeHandler}::入金ステータス,
            "更新日時" = CURRENT_TIMESTAMP,
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{receiptId}
    </update>

    <delete id="deleteApplicationsByReceiptId">
        DELETE FROM "入金消込明細" WHERE "入金ID" = #{receiptId}
    </delete>

    <delete id="deleteById">
        DELETE FROM "入金データ" WHERE "ID" = #{id}
    </delete>

    <delete id="deleteAllApplications">
        TRUNCATE TABLE "入金消込明細" CASCADE
    </delete>

    <delete id="deleteAll">
        TRUNCATE TABLE "入金データ" CASCADE
    </delete>
</mapper>
