<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.sms.infrastructure.out.persistence.mapper.CustomerMapper">

    <resultMap id="CustomerResultMap" type="com.example.sms.domain.model.partner.Customer">
        <result property="customerCode" column="顧客コード"/>
        <result property="customerBranchNumber" column="顧客枝番"/>
        <result property="customerCategory" column="顧客区分"/>
        <result property="billingCode" column="請求先コード"/>
        <result property="billingBranchNumber" column="請求先枝番"/>
        <result property="collectionCode" column="回収先コード"/>
        <result property="collectionBranchNumber" column="回収先枝番"/>
        <result property="customerName" column="顧客名"/>
        <result property="customerNameKana" column="顧客名カナ"/>
        <result property="ourRepresentativeCode" column="自社担当者コード"/>
        <result property="customerRepresentativeName" column="顧客担当者名"/>
        <result property="customerDepartmentName" column="顧客部門名"/>
        <result property="customerPostalCode" column="顧客郵便番号"/>
        <result property="customerPrefecture" column="顧客都道府県"/>
        <result property="customerAddress1" column="顧客住所1"/>
        <result property="customerAddress2" column="顧客住所2"/>
        <result property="customerPhone" column="顧客電話番号"/>
        <result property="customerFax" column="顧客FAX番号"/>
        <result property="customerEmail" column="顧客メールアドレス"/>
        <result property="billingType" column="顧客請求区分"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.BillingTypeTypeHandler"/>
        <result property="closingDay1" column="顧客締日1"/>
        <result property="paymentMonth1" column="顧客支払月1"/>
        <result property="paymentDay1" column="顧客支払日1"/>
        <result property="paymentMethod1" column="顧客支払方法1"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler"/>
        <result property="closingDay2" column="顧客締日2"/>
        <result property="paymentMonth2" column="顧客支払月2"/>
        <result property="paymentDay2" column="顧客支払日2"/>
        <result property="paymentMethod2" column="顧客支払方法2"
                typeHandler="com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler"/>
        <result property="createdAt" column="作成日時"/>
        <result property="createdBy" column="作成者名"/>
        <result property="updatedAt" column="更新日時"/>
        <result property="updatedBy" column="更新者名"/>
    </resultMap>

    <!-- PostgreSQL 用 INSERT -->
    <insert id="insert" parameterType="com.example.sms.domain.model.partner.Customer" databaseId="postgresql">
        INSERT INTO "顧客マスタ" (
            "顧客コード", "顧客枝番", "顧客区分", "請求先コード", "請求先枝番",
            "回収先コード", "回収先枝番", "顧客名", "顧客名カナ", "自社担当者コード",
            "顧客担当者名", "顧客部門名", "顧客郵便番号", "顧客都道府県", "顧客住所1",
            "顧客住所2", "顧客電話番号", "顧客FAX番号", "顧客メールアドレス", "顧客請求区分",
            "顧客締日1", "顧客支払月1", "顧客支払日1", "顧客支払方法1",
            "顧客締日2", "顧客支払月2", "顧客支払日2", "顧客支払方法2",
            "作成日時", "作成者名", "更新日時", "更新者名"
        ) VALUES (
            #{customerCode}, #{customerBranchNumber}, #{customerCategory}, #{billingCode}, #{billingBranchNumber},
            #{collectionCode}, #{collectionBranchNumber}, #{customerName}, #{customerNameKana}, #{ourRepresentativeCode},
            #{customerRepresentativeName}, #{customerDepartmentName}, #{customerPostalCode}, #{customerPrefecture}, #{customerAddress1},
            #{customerAddress2}, #{customerPhone}, #{customerFax}, #{customerEmail},
            #{billingType, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.BillingTypeTypeHandler}::請求区分,
            #{closingDay1}, #{paymentMonth1}, #{paymentDay1},
            #{paymentMethod1, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler}::支払方法,
            #{closingDay2}, #{paymentMonth2}, #{paymentDay2},
            #{paymentMethod2, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler}::支払方法,
            CURRENT_TIMESTAMP, #{createdBy}, CURRENT_TIMESTAMP, #{updatedBy}
        )
    </insert>

    <!-- H2 用 INSERT -->
    <insert id="insert" parameterType="com.example.sms.domain.model.partner.Customer" databaseId="h2">
        INSERT INTO "顧客マスタ" (
            "顧客コード", "顧客枝番", "顧客区分", "請求先コード", "請求先枝番",
            "回収先コード", "回収先枝番", "顧客名", "顧客名カナ", "自社担当者コード",
            "顧客担当者名", "顧客部門名", "顧客郵便番号", "顧客都道府県", "顧客住所1",
            "顧客住所2", "顧客電話番号", "顧客FAX番号", "顧客メールアドレス", "顧客請求区分",
            "顧客締日1", "顧客支払月1", "顧客支払日1", "顧客支払方法1",
            "顧客締日2", "顧客支払月2", "顧客支払日2", "顧客支払方法2",
            "作成日時", "作成者名", "更新日時", "更新者名"
        ) VALUES (
            #{customerCode}, #{customerBranchNumber}, #{customerCategory}, #{billingCode}, #{billingBranchNumber},
            #{collectionCode}, #{collectionBranchNumber}, #{customerName}, #{customerNameKana}, #{ourRepresentativeCode},
            #{customerRepresentativeName}, #{customerDepartmentName}, #{customerPostalCode}, #{customerPrefecture}, #{customerAddress1},
            #{customerAddress2}, #{customerPhone}, #{customerFax}, #{customerEmail},
            #{billingType, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.BillingTypeTypeHandler},
            #{closingDay1}, #{paymentMonth1}, #{paymentDay1},
            #{paymentMethod1, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler},
            #{closingDay2}, #{paymentMonth2}, #{paymentDay2},
            #{paymentMethod2, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler},
            CURRENT_TIMESTAMP, #{createdBy}, CURRENT_TIMESTAMP, #{updatedBy}
        )
    </insert>

    <select id="findByCodeAndBranch" resultMap="CustomerResultMap">
        SELECT * FROM "顧客マスタ"
        WHERE "顧客コード" = #{customerCode}
          AND "顧客枝番" = #{branchNumber}
    </select>

    <select id="findByCode" resultMap="CustomerResultMap">
        SELECT * FROM "顧客マスタ"
        WHERE "顧客コード" = #{customerCode}
        ORDER BY "顧客枝番"
    </select>

    <select id="findAll" resultMap="CustomerResultMap">
        SELECT * FROM "顧客マスタ"
        ORDER BY "顧客コード", "顧客枝番"
    </select>

    <select id="findWithPagination" resultMap="CustomerResultMap">
        SELECT * FROM "顧客マスタ"
        <where>
            <if test="keyword != null and keyword != ''">
                (LOWER("顧客コード") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("顧客名") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("顧客名カナ") LIKE LOWER('%' || #{keyword} || '%'))
            </if>
        </where>
        ORDER BY "顧客コード", "顧客枝番"
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(*) FROM "顧客マスタ"
        <where>
            <if test="keyword != null and keyword != ''">
                (LOWER("顧客コード") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("顧客名") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("顧客名カナ") LIKE LOWER('%' || #{keyword} || '%'))
            </if>
        </where>
    </select>

    <!-- PostgreSQL 用 UPDATE -->
    <update id="update" parameterType="com.example.sms.domain.model.partner.Customer" databaseId="postgresql">
        UPDATE "顧客マスタ" SET
            "顧客区分" = #{customerCategory},
            "請求先コード" = #{billingCode},
            "請求先枝番" = #{billingBranchNumber},
            "回収先コード" = #{collectionCode},
            "回収先枝番" = #{collectionBranchNumber},
            "顧客名" = #{customerName},
            "顧客名カナ" = #{customerNameKana},
            "自社担当者コード" = #{ourRepresentativeCode},
            "顧客担当者名" = #{customerRepresentativeName},
            "顧客部門名" = #{customerDepartmentName},
            "顧客郵便番号" = #{customerPostalCode},
            "顧客都道府県" = #{customerPrefecture},
            "顧客住所1" = #{customerAddress1},
            "顧客住所2" = #{customerAddress2},
            "顧客電話番号" = #{customerPhone},
            "顧客FAX番号" = #{customerFax},
            "顧客メールアドレス" = #{customerEmail},
            "顧客請求区分" = #{billingType, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.BillingTypeTypeHandler}::請求区分,
            "顧客締日1" = #{closingDay1},
            "顧客支払月1" = #{paymentMonth1},
            "顧客支払日1" = #{paymentDay1},
            "顧客支払方法1" = #{paymentMethod1, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler}::支払方法,
            "顧客締日2" = #{closingDay2},
            "顧客支払月2" = #{paymentMonth2},
            "顧客支払日2" = #{paymentDay2},
            "顧客支払方法2" = #{paymentMethod2, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler}::支払方法,
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者名" = #{updatedBy}
        WHERE "顧客コード" = #{customerCode}
          AND "顧客枝番" = #{customerBranchNumber}
    </update>

    <!-- H2 用 UPDATE -->
    <update id="update" parameterType="com.example.sms.domain.model.partner.Customer" databaseId="h2">
        UPDATE "顧客マスタ" SET
            "顧客区分" = #{customerCategory},
            "請求先コード" = #{billingCode},
            "請求先枝番" = #{billingBranchNumber},
            "回収先コード" = #{collectionCode},
            "回収先枝番" = #{collectionBranchNumber},
            "顧客名" = #{customerName},
            "顧客名カナ" = #{customerNameKana},
            "自社担当者コード" = #{ourRepresentativeCode},
            "顧客担当者名" = #{customerRepresentativeName},
            "顧客部門名" = #{customerDepartmentName},
            "顧客郵便番号" = #{customerPostalCode},
            "顧客都道府県" = #{customerPrefecture},
            "顧客住所1" = #{customerAddress1},
            "顧客住所2" = #{customerAddress2},
            "顧客電話番号" = #{customerPhone},
            "顧客FAX番号" = #{customerFax},
            "顧客メールアドレス" = #{customerEmail},
            "顧客請求区分" = #{billingType, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.BillingTypeTypeHandler},
            "顧客締日1" = #{closingDay1},
            "顧客支払月1" = #{paymentMonth1},
            "顧客支払日1" = #{paymentDay1},
            "顧客支払方法1" = #{paymentMethod1, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler},
            "顧客締日2" = #{closingDay2},
            "顧客支払月2" = #{paymentMonth2},
            "顧客支払日2" = #{paymentDay2},
            "顧客支払方法2" = #{paymentMethod2, typeHandler=com.example.sms.infrastructure.out.persistence.typehandler.PaymentMethodTypeHandler},
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者名" = #{updatedBy}
        WHERE "顧客コード" = #{customerCode}
          AND "顧客枝番" = #{customerBranchNumber}
    </update>

    <delete id="deleteByCodeAndBranch">
        DELETE FROM "顧客マスタ"
        WHERE "顧客コード" = #{customerCode}
          AND "顧客枝番" = #{branchNumber}
    </delete>

    <!-- PostgreSQL 用 TRUNCATE -->
    <delete id="deleteAll" databaseId="postgresql">
        TRUNCATE TABLE "顧客マスタ" CASCADE
    </delete>

    <!-- H2 用 DELETE ALL -->
    <delete id="deleteAll" databaseId="h2">
        DELETE FROM "顧客マスタ"
    </delete>
</mapper>
