<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.sms.infrastructure.out.persistence.mapper.PurchaseMapper">

    <resultMap id="PurchaseResultMap" type="com.example.sms.domain.model.purchase.Purchase">
        <id property="id" column="ID"/>
        <result property="purchaseNumber" column="仕入番号"/>
        <result property="receivingId" column="入荷ID"/>
        <result property="supplierCode" column="仕入先コード"/>
        <result property="supplierBranchNumber" column="仕入先枝番"/>
        <result property="purchaseDate" column="仕入日"/>
        <result property="totalAmount" column="仕入合計金額"/>
        <result property="taxAmount" column="税額"/>
        <result property="remarks" column="備考"/>
        <result property="createdAt" column="作成日時"/>
        <result property="createdBy" column="作成者"/>
        <result property="updatedAt" column="更新日時"/>
        <result property="updatedBy" column="更新者"/>
        <result property="version" column="バージョン"/>
        <collection property="details" ofType="com.example.sms.domain.model.purchase.PurchaseDetail"
                    select="findDetailsByPurchaseId" column="ID"/>
    </resultMap>

    <resultMap id="PurchaseDetailResultMap" type="com.example.sms.domain.model.purchase.PurchaseDetail">
        <id property="id" column="ID"/>
        <result property="purchaseId" column="仕入ID"/>
        <result property="lineNumber" column="仕入行番号"/>
        <result property="productCode" column="商品コード"/>
        <result property="purchaseQuantity" column="仕入数量"/>
        <result property="unitPrice" column="仕入単価"/>
        <result property="purchaseAmount" column="仕入金額"/>
        <result property="remarks" column="備考"/>
        <result property="createdAt" column="作成日時"/>
        <result property="updatedAt" column="更新日時"/>
    </resultMap>

    <!-- 仕入（ヘッダ）+ 仕入明細のネスト ResultMap（JOINによる一括取得用） -->
    <resultMap id="purchaseWithDetailsResultMap" type="com.example.sms.domain.model.purchase.Purchase">
        <id property="id" column="p_id"/>
        <result property="purchaseNumber" column="p_仕入番号"/>
        <result property="receivingId" column="p_入荷ID"/>
        <result property="supplierCode" column="p_仕入先コード"/>
        <result property="supplierBranchNumber" column="p_仕入先枝番"/>
        <result property="purchaseDate" column="p_仕入日"/>
        <result property="totalAmount" column="p_仕入合計金額"/>
        <result property="taxAmount" column="p_税額"/>
        <result property="remarks" column="p_備考"/>
        <result property="version" column="p_バージョン"/>
        <result property="createdAt" column="p_作成日時"/>
        <result property="createdBy" column="p_作成者"/>
        <result property="updatedAt" column="p_更新日時"/>
        <result property="updatedBy" column="p_更新者"/>
        <!-- 仕入明細との1:N関連 -->
        <collection property="details" ofType="com.example.sms.domain.model.purchase.PurchaseDetail"
                    resultMap="purchaseDetailNestedResultMap"/>
    </resultMap>

    <!-- 仕入明細のネスト ResultMap -->
    <resultMap id="purchaseDetailNestedResultMap" type="com.example.sms.domain.model.purchase.PurchaseDetail">
        <id property="id" column="pd_id"/>
        <result property="purchaseId" column="pd_仕入ID"/>
        <result property="lineNumber" column="pd_仕入行番号"/>
        <result property="productCode" column="pd_商品コード"/>
        <result property="purchaseQuantity" column="pd_仕入数量"/>
        <result property="unitPrice" column="pd_仕入単価"/>
        <result property="purchaseAmount" column="pd_仕入金額"/>
        <result property="remarks" column="pd_備考"/>
        <result property="createdAt" column="pd_作成日時"/>
        <result property="updatedAt" column="pd_更新日時"/>
    </resultMap>

    <insert id="insertHeader" parameterType="com.example.sms.domain.model.purchase.Purchase"
            useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO "仕入データ" (
            "仕入番号", "入荷ID", "仕入先コード", "仕入先枝番", "仕入日",
            "仕入合計金額", "税額", "備考",
            "作成日時", "作成者", "更新日時", "更新者", "バージョン"
        ) VALUES (
            #{purchaseNumber}, #{receivingId}, #{supplierCode}, #{supplierBranchNumber}, #{purchaseDate},
            #{totalAmount}, #{taxAmount}, #{remarks},
            CURRENT_TIMESTAMP, #{createdBy}, CURRENT_TIMESTAMP, #{updatedBy}, 1
        )
    </insert>

    <insert id="insertDetail" parameterType="com.example.sms.domain.model.purchase.PurchaseDetail"
            useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO "仕入明細データ" (
            "仕入ID", "仕入行番号", "商品コード", "仕入数量", "仕入単価",
            "仕入金額", "備考",
            "作成日時", "更新日時"
        ) VALUES (
            #{purchaseId}, #{lineNumber}, #{productCode}, #{purchaseQuantity}, #{unitPrice},
            #{purchaseAmount}, #{remarks},
            CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    </insert>

    <select id="findById" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ" WHERE "ID" = #{id}
    </select>

    <select id="findByPurchaseNumber" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ" WHERE "仕入番号" = #{purchaseNumber}
    </select>

    <select id="findByReceivingId" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ"
        WHERE "入荷ID" = #{receivingId}
        ORDER BY "仕入日" DESC, "仕入番号"
    </select>

    <select id="findBySupplierCode" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ"
        WHERE "仕入先コード" = #{supplierCode}
        ORDER BY "仕入日" DESC, "仕入番号"
    </select>

    <select id="findByPurchaseDateBetween" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ"
        WHERE "仕入日" BETWEEN #{from} AND #{to}
        ORDER BY "仕入日" DESC, "仕入番号"
    </select>

    <select id="findAll" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ" ORDER BY "仕入日" DESC, "仕入番号"
    </select>

    <select id="findWithPagination" resultMap="PurchaseResultMap">
        SELECT * FROM "仕入データ"
        <where>
            <if test="keyword != null and keyword != ''">
                (LOWER("仕入番号") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("仕入先コード") LIKE LOWER('%' || #{keyword} || '%'))
            </if>
        </where>
        ORDER BY "仕入日" DESC, "仕入番号"
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(*) FROM "仕入データ"
        <where>
            <if test="keyword != null and keyword != ''">
                (LOWER("仕入番号") LIKE LOWER('%' || #{keyword} || '%')
                 OR LOWER("仕入先コード") LIKE LOWER('%' || #{keyword} || '%'))
            </if>
        </where>
    </select>

    <select id="findDetailsByPurchaseId" resultMap="PurchaseDetailResultMap">
        SELECT * FROM "仕入明細データ"
        WHERE "仕入ID" = #{purchaseId}
        ORDER BY "仕入行番号"
    </select>

    <!-- JOIN による一括取得クエリ（仕入番号指定） -->
    <select id="findWithDetailsByPurchaseNumber" resultMap="purchaseWithDetailsResultMap">
        SELECT
            p."ID" AS p_id,
            p."仕入番号" AS p_仕入番号,
            p."入荷ID" AS p_入荷ID,
            p."仕入先コード" AS p_仕入先コード,
            p."仕入先枝番" AS p_仕入先枝番,
            p."仕入日" AS p_仕入日,
            p."仕入合計金額" AS p_仕入合計金額,
            p."税額" AS p_税額,
            p."備考" AS p_備考,
            p."バージョン" AS p_バージョン,
            p."作成日時" AS p_作成日時,
            p."作成者" AS p_作成者,
            p."更新日時" AS p_更新日時,
            p."更新者" AS p_更新者,
            pd."ID" AS pd_id,
            pd."仕入ID" AS pd_仕入ID,
            pd."仕入行番号" AS pd_仕入行番号,
            pd."商品コード" AS pd_商品コード,
            pd."仕入数量" AS pd_仕入数量,
            pd."仕入単価" AS pd_仕入単価,
            pd."仕入金額" AS pd_仕入金額,
            pd."備考" AS pd_備考,
            pd."作成日時" AS pd_作成日時,
            pd."更新日時" AS pd_更新日時
        FROM "仕入データ" p
        LEFT JOIN "仕入明細データ" pd
            ON p."ID" = pd."仕入ID"
        WHERE p."仕入番号" = #{purchaseNumber}
        ORDER BY pd."仕入行番号"
    </select>

    <!-- JOIN による一括取得クエリ（ID指定） -->
    <select id="findByIdWithDetails" resultMap="purchaseWithDetailsResultMap">
        SELECT
            p."ID" AS p_id,
            p."仕入番号" AS p_仕入番号,
            p."入荷ID" AS p_入荷ID,
            p."仕入先コード" AS p_仕入先コード,
            p."仕入先枝番" AS p_仕入先枝番,
            p."仕入日" AS p_仕入日,
            p."仕入合計金額" AS p_仕入合計金額,
            p."税額" AS p_税額,
            p."備考" AS p_備考,
            p."バージョン" AS p_バージョン,
            p."作成日時" AS p_作成日時,
            p."作成者" AS p_作成者,
            p."更新日時" AS p_更新日時,
            p."更新者" AS p_更新者,
            pd."ID" AS pd_id,
            pd."仕入ID" AS pd_仕入ID,
            pd."仕入行番号" AS pd_仕入行番号,
            pd."商品コード" AS pd_商品コード,
            pd."仕入数量" AS pd_仕入数量,
            pd."仕入単価" AS pd_仕入単価,
            pd."仕入金額" AS pd_仕入金額,
            pd."備考" AS pd_備考,
            pd."作成日時" AS pd_作成日時,
            pd."更新日時" AS pd_更新日時
        FROM "仕入データ" p
        LEFT JOIN "仕入明細データ" pd
            ON p."ID" = pd."仕入ID"
        WHERE p."ID" = #{id}
        ORDER BY pd."仕入行番号"
    </select>

    <!-- バージョン取得（楽観ロック用） -->
    <select id="findVersionById" resultType="java.lang.Integer">
        SELECT "バージョン" FROM "仕入データ" WHERE "ID" = #{id}
    </select>

    <update id="updateHeader" parameterType="com.example.sms.domain.model.purchase.Purchase">
        UPDATE "仕入データ" SET
            "入荷ID" = #{receivingId},
            "仕入先コード" = #{supplierCode},
            "仕入先枝番" = #{supplierBranchNumber},
            "仕入日" = #{purchaseDate},
            "仕入合計金額" = #{totalAmount},
            "税額" = #{taxAmount},
            "備考" = #{remarks},
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者" = #{updatedBy},
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{id}
    </update>

    <!-- 楽観ロック対応の更新（バージョンチェック付き） -->
    <update id="updateWithOptimisticLock" parameterType="com.example.sms.domain.model.purchase.Purchase">
        UPDATE "仕入データ" SET
            "入荷ID" = #{receivingId},
            "仕入先コード" = #{supplierCode},
            "仕入先枝番" = #{supplierBranchNumber},
            "仕入日" = #{purchaseDate},
            "仕入合計金額" = #{totalAmount},
            "税額" = #{taxAmount},
            "備考" = #{remarks},
            "更新日時" = CURRENT_TIMESTAMP,
            "更新者" = #{updatedBy},
            "バージョン" = "バージョン" + 1
        WHERE "ID" = #{id}
        AND "バージョン" = #{version}
    </update>

    <update id="updateDetail" parameterType="com.example.sms.domain.model.purchase.PurchaseDetail">
        UPDATE "仕入明細データ" SET
            "商品コード" = #{productCode},
            "仕入数量" = #{purchaseQuantity},
            "仕入単価" = #{unitPrice},
            "仕入金額" = #{purchaseAmount},
            "備考" = #{remarks},
            "更新日時" = CURRENT_TIMESTAMP
        WHERE "ID" = #{id}
    </update>

    <delete id="deleteDetailsByPurchaseId">
        DELETE FROM "仕入明細データ" WHERE "仕入ID" = #{purchaseId}
    </delete>

    <delete id="deleteById">
        DELETE FROM "仕入データ" WHERE "ID" = #{id}
    </delete>

    <delete id="deleteAllDetails">
        TRUNCATE TABLE "仕入明細データ" CASCADE
    </delete>

    <delete id="deleteAll">
        TRUNCATE TABLE "仕入データ" CASCADE
    </delete>
</mapper>
