
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="基幹業務システム（販売管理・財務会計・生産管理）のデータベース設計を体系的に解説">
      
      
        <meta name="author" content="k2works">
      
      
      
        <link rel="prev" href="../chapter17-orm/">
      
      
        <link rel="next" href="../chapter19-orm/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>第18章 勘定科目残高の設計【ORM版】 - 実践データベース設計：基幹業務システム編</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#18orm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="実践データベース設計：基幹業務システム編" class="md-header__button md-logo" aria-label="実践データベース設計：基幹業務システム編" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            実践データベース設計：基幹業務システム編
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第18章 勘定科目残高の設計【ORM版】
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/practical-database-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    practical-database-design
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  実践データベース設計

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="実践データベース設計：基幹業務システム編" class="md-nav__button md-logo" aria-label="実践データベース設計：基幹業務システム編" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    実践データベース設計：基幹業務システム編
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/practical-database-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    practical-database-design
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    実践データベース設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    実践データベース設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../techstack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技術スタック
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../outline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    アウトライン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    執筆ワークフロー
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" >
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第1部 基幹業務システムの全体像
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    第1部 基幹業務システムの全体像
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章 基幹業務システムとは
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章 基幹業務システムの業務領域
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章 業務フローの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_6" >
        
          
          <label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第2部 販売管理システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    第2部 販売管理システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章 販売管理システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章 マスタ情報の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章 受注・出荷・売上の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章 債権管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章 調達管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章 在庫管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章 債務管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章 共通処理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章 販売管理データ設計（B社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_7" >
        
          
          <label class="md-nav__link" for="__nav_1_7" id="__nav_1_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第3部 財務会計システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    第3部 財務会計システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章 財務会計システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章 勘定科目の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章 仕訳の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章 自動仕訳の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章 勘定科目残高の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章 赤黒とログの設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章 財務会計データ設計（D社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_8" >
        
          
          <label class="md-nav__link" for="__nav_1_8" id="__nav_1_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第4部 生産管理システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    第4部 生産管理システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章 生産管理システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章 マスタ情報の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章 生産計画の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第25章 購買管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第26章 外注委託管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第27章 工程管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第28章 在庫管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第29章 品質管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第30章 製造原価管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第31章 生産管理データ設計（E社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第32章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_9" >
        
          
          <label class="md-nav__link" for="__nav_1_9" id="__nav_1_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第5部 エンタープライズインテグレーション
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    第5部 エンタープライズインテグレーション
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter33.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第33章 システム統合の概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter34.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第34章 メッセージングパターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter35.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第35章 システム間連携パターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter36.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第36章 マスタデータ管理（MDM）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter37.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第37章 イベント駆動アーキテクチャ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter38.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第38章 API設計とサービス連携
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter39.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第39章 データ連携の実装パターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_10" >
        
          
          <label class="md-nav__link" for="__nav_1_10" id="__nav_1_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 販売管理システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 販売管理システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_11" >
        
          
          <label class="md-nav__link" for="__nav_1_11" id="__nav_1_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 財務会計システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 財務会計システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_12" >
        
          
          <label class="md-nav__link" for="__nav_1_12" id="__nav_1_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 生産管理システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 生産管理システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_13" checked>
        
          
          <label class="md-nav__link" for="__nav_1_13" id="__nav_1_13_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 財務会計システムORM実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 財務会計システムORM実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章 財務会計システムの全体像【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章 勘定科目の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章 仕訳の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章 自動仕訳の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第18章 勘定科目残高の設計【ORM版】
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章 勘定科目残高の設計【ORM版】
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#181" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.1 日次勘定科目残高の設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.1 日次勘定科目残高の設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        日次残高管理の目的
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        複合主キーによる多次元管理
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#182-mybatis" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.2 MyBatis 版との実装比較
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.2 MyBatis 版との実装比較">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        データアクセス層の比較
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flyway" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flyway マイグレーション
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#183-jpa" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.3 JPA エンティティの実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.3 JPA エンティティの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#embeddable" class="md-nav__link">
    <span class="md-ellipsis">
      
        複合主キークラス（@Embeddable）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entity" class="md-nav__link">
    <span class="md-ellipsis">
      
        日次勘定科目残高 Entity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection" class="md-nav__link">
    <span class="md-ellipsis">
      
        日計表行用 Projection インターフェース
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#184-tdd" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.4 TDD による日次残高テーブルの実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.4 TDD による日次残高テーブルの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        リポジトリのテスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#185-jparepository" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.5 JpaRepository インターフェース
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.5 JpaRepository インターフェース">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        日次勘定科目残高 Repository
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#186" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.6 月次勘定科目残高の設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.6 月次勘定科目残高の設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        月次残高管理の目的
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#er" class="md-nav__link">
    <span class="md-ellipsis">
      
        月次勘定科目残高テーブルの ER 図
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#187-jpa" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.7 月次残高の JPA エンティティ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.7 月次残高の JPA エンティティ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        複合主キークラス
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entity_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        月次勘定科目残高 Entity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        合計残高試算表行用 Projection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#188" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.8 残高更新サービスの実装
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#189" class="md-nav__link">
    <span class="md-ellipsis">
      
        18.9 まとめ：設計のポイント
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.9 まとめ：設計のポイント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        複合主キーによる多次元管理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert" class="md-nav__link">
    <span class="md-ellipsis">
      
        UPSERT による効率的な残高更新
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projection による集計結果のマッピング
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mybatis" class="md-nav__link">
    <span class="md-ellipsis">
      
        MyBatis 版との比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        次章予告
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章 赤黒とログの設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章 財務会計データ設計（D社事例）【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章 APIサービスの実装【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_14" >
        
          
          <label class="md-nav__link" for="__nav_1_14" id="__nav_1_14_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    付録
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    付録
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/er-diagrams.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    A 全体ER図
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/table-definitions.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    B テーブル定義一覧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/glossary.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C 用語集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_15" >
        
          
          <label class="md-nav__link" for="__nav_1_15" id="__nav_1_15_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    データベース
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_15">
            <span class="md-nav__icon md-icon"></span>
            
  
    データベース
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../assets/schemaspy-output/sms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SchemaSpy ER図（SMS）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="18orm">第18章：勘定科目残高の設計（ORM版）<a class="headerlink" href="#18orm" title="Permanent link">&para;</a></h1>
<p>会計システムにおける残高管理の基盤となる「勘定科目別残高テーブル」を TDD で設計していきます。日次・月次の残高管理と、帳票出力に必要なテーブル構造を実装します。</p>
<p>JPA 版では、@EmbeddedId による複合主キー、@Query による集計クエリ、Projection インターフェースを活用します。</p>
<hr />
<h2 id="181">18.1 日次勘定科目残高の設計<a class="headerlink" href="#181" title="Permanent link">&para;</a></h2>
<h3 id="_1">日次残高管理の目的<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>日次勘定科目残高は、日々の仕訳処理に連動して更新される残高情報を管理します。日計表の出力やリアルタイムな残高把握に使用します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Njc1cHg7aGVpZ2h0OjQ5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY3NSA0OTgiIHdpZHRoPSI2NzVweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMjYwODU7JiMyNzQyNTsmIzI3NTMxOyYjMzk2NDA7JiMzMTY0OTsmIzI5NzAyOyYjMTIzOTg7JiMyNDQ0MTsmIzIxMTA2OzwvdGl0bGU+PGRlZnMvPjxnPjxnIGNsYXNzPSJ0aXRsZSIgZGF0YS1zb3VyY2UtbGluZT0iMSI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIyNjcuNjY1MyIgeT0iMjIuOTk1MSI+JiMyNjA4NTsmIzI3NDI1OyYjMjc1MzE7JiMzOTY0MDsmIzMxNjQ5OyYjMjk3MDI7JiMxMjM5ODsmIzI0NDQxOyYjMjExMDY7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBqb3VybmFsLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJqb3VybmFsIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfam91cm5hbCI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI3My4zIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzMwIiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjE0NC4wMDAxIiB5PSI1OS4yOTIiPiYjMjAxODE7JiMzNTM3OTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBiYWxhbmNlLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJiYWxhbmNlIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImNsdXN0ZXJfYmFsYW5jZSI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIxODkuMTQiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzYiIHg9IjIxNSIgeT0iMTY2LjU5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjU1LjAwMDEiIHk9IjE4MS41OTIiPiYjMjc1MzE7JiMzOTY0MDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciByZXBvcnQtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InJlcG9ydCIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iY2x1c3Rlcl9yZXBvcnQiPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1OCIgeD0iMjA4IiB5PSI0MTkuMjg2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIzNTkuMDAwMSIgeT0iNDM0LjI4MiI+JiMyNDExNTsmIzMxMDgwOyYjMjA5ODY7JiMyMTE0Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgajEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iajEiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2oxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijc1Ljk5OTgiIHg9IjIzIiB5PSI3OS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMzMiIHk9Ijk1LjI5MiI+JiMyMDE4MTsmIzM1Mzc5OyYjMjA4Mzc7JiMyMTE0Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgajItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iajIiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X2oyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijc1Ljk5OTgiIHg9IjEzNCIgeT0iNzkuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjE0NCIgeT0iOTUuMjkyIj4mIzIwMTgxOyYjMzUzNzk7JiMyNTIxNTsmIzM1NDY5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBqMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJqMyIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfajMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzUuOTk5OCIgeD0iMjQ1IiB5PSI3OS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjU1IiB5PSI5NS4yOTIiPiYjMjAxODE7JiMzNTM3OTsmIzM2NTc4OyYjMzUzNTI7PC90ZXh0PjwvZz48IS0tZW50aXR5IGIxLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImIxIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfYjEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjIzMSIgeT0iMjAxLjU5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyNDEiIHk9IjIxNy41OTIiPiYjMjYwODU7JiMyNzQyNTsmIzI3NTMxOyYjMzk2NDA7JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBiMi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJiMiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X2IyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMy45OTk2IiB4PSIyMzEiIHk9IjMxNy40NDY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMjQxIiB5PSIzMzMuNDQyIj4mIzI2Mzc2OyYjMjc0MjU7JiMyNzUzMTsmIzM5NjQwOyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcjEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icjEiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9yMSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI2MS45OTk4IiB4PSI0ODgiIHk9IjQ1NC4yODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEuOTk5OCIgeD0iNDk4IiB5PSI0NzAuMjgyIj4mIzI2MDg1OyYjMzUzMzY7JiMzNDkyMDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcjItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icjIiIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9yMiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMTcuOTk5NiIgeD0iMjI0IiB5PSI0NTQuMjg2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjIzNCIgeT0iNDcwLjI4MiI+JiMyMTUxMjsmIzM1MzM2OyYjMjc1MzE7JiMzOTY0MDsmIzM1NDMwOyYjMzE2Mzk7JiMzNDkyMDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcjMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icjMiIGRhdGEtc291cmNlLWxpbmU9IjE3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9yMyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3NS45OTk4IiB4PSIzNzciIHk9IjQ1NC4yODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMzg3IiB5PSI0NzAuMjgyIj4mIzM2MDAxOyYjMjEyMDk7JiMzNTU3NjsmIzM0OTIwOzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjE4IiBkYXRhLXNvdXJjZS1saW5lPSIyNyIgZGF0YS11aWQ9ImVudDAwMTkiIGlkPSJlbnRpdHlfR01OMTgiPjxwYXRoIGQ9Ik0zNjkuNSwzMDAuODg2OSBMMzY5LjUsMzU2LjI4NTMgQTAsMCAwIDAgMCAzNjkuNSwzNTYuMjg1MyBMNTcyLjUwMDIsMzU2LjI4NTMgQTAsMCAwIDAgMCA1NzIuNTAwMiwzNTYuMjg1MyBMNTcyLjUwMDIsMzEwLjg4NjkgTDU2Mi41MDAyLDMwMC44ODY5IEw0MzAuMjEsMzAwLjg4NjkgTDMwMC4zNSwyMjQuMjQ2OSBMNDIyLjIxLDMwMC44ODY5IEwzNjkuNSwzMDAuODg2OSBBMCwwIDAgMCAwIDM2OS41LDMwMC44ODY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNTYyLjUwMDIsMzAwLjg4NjkgTDU2Mi41MDAyLDMxMC44ODY5IEw1NzIuNTAwMiwzMTAuODg2OSBMNTYyLjUwMDIsMzAwLjg4NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNy4wMDAxIiB4PSIzNzUuNSIgeT0iMzE3Ljk1MzgiPiYjMjYwODU7JiMyNzQyNTsmIzIxMjA4OyYjMjM0NTA7JiMzMTE4NTsmIzMwNDQ2OyYjMjc1MzE7JiMzOTY0MDsmIzEyMzk5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDMuMDAwMiIgeD0iMzc1LjUiIHk9IjMzMy4wODY2Ij4mIzIwMTgxOyYjMzUzNzk7JiMyMDgzNzsmIzIxMTQ3OyYjMjYxNzg7JiMxMjM5NTsmIzIxMzYzOyYjMjQyMzE7JiMxMjM5NTsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4Mi4wMDAyIiB4PSIzNzUuNSIgeT0iMzQ4LjIxOTQiPiYjMTI1MjI7JiMxMjQ1MDsmIzEyNTIzOyYjMTI0Nzk7JiMxMjQ1MjsmIzEyNTEyOyYjMTIzOTQ7JiMyNzUzMTsmIzM5NjQwOyYjMjUyMjY7JiMyNTU2OTsmIzEyNDM0OyYjMjM0NTU7JiMyOTY5NDs8L3RleHQ+PC9nPjwhLS1saW5rIGozIHRvIGIxLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImozIiBkYXRhLWVudGl0eS0yPSJiMSIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJsbmsxMyIgaWQ9ImxpbmtfajNfYjEiPjxwYXRoIGQ9Ik0yODMsMTAxLjcwNjkgQzI4MywxMjQuMzE2OSAyODMsMTcyLjI2NjkgMjgzLDE5NS4xNjY5IiBmaWxsPSJub25lIiBpZD0iajMtdG8tYjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI4MywyMDEuMTY2OSwyODcsMTkyLjE2NjksMjgzLDE5Ni4xNjY5LDI3OSwxOTIuMTY2OSwyODMsMjAxLjE2NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSIyODQiIHk9IjE0Ni42NjM4Ij4mIzIxMzYzOyYjMjYxNzg7JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PCEtLWxpbmsgYjEgdG8gYjItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYjEiIGRhdGEtZW50aXR5LTI9ImIyIiBkYXRhLXNvdXJjZS1saW5lPSIyMSIgZGF0YS11aWQ9ImxuazE0IiBpZD0ibGlua19iMV9iMiI+PHBhdGggZD0iTTI4MywyMjQuMjQ2OSBDMjgzLDI0NS45MzY5IDI4MywyODkuNDQ2OSAyODMsMzExLjEwNjkiIGZpbGw9Im5vbmUiIGlkPSJiMS10by1iMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjgzLDMxNy4xMDY5LDI4NywzMDguMTA2OSwyODMsMzEyLjEwNjksMjc5LDMwOC4xMDY5LDI4MywzMTcuMTA2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjI4NCIgeT0iMjY2Ljk1MzgiPiYjMjYzNzY7JiMyNjQxMTsmIzM4NTk4OyYjMzUzMzY7PC90ZXh0PjwvZz48IS0tbGluayBiMSB0byByMS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJiMSIgZGF0YS1lbnRpdHktMj0icjEiIGRhdGEtc291cmNlLWxpbmU9IjIyIiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX2IxX3IxIj48cGF0aCBkPSJNMzM1LjIyLDIyMC45NDY5IEM0MTQuNTEsMjMzLjA2NjkgNTU5LjMxLDI2MC4yNzY5IDU5MCwzMDAuODg2OSBDNjI4LjQ0LDM1MS43NjY5IDU2My4zNzcyLDQyMi41MjEgNTM0LjgwNzIsNDQ5LjgzMSIgZmlsbD0ibm9uZSIgaWQ9ImIxLXRvLXIxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1MzAuNDcsNDUzLjk3NjksNTM5LjczOTgsNDUwLjY0OTUsNTM0LjA4NDMsNDUwLjUyMTksNTM0LjIxMTksNDQ0Ljg2NjUsNTMwLjQ3LDQ1My45NzY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuMDAwMSIgeD0iNjAyLjMzIiB5PSIzMzMuMTUzOCI+JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7JiMyMTQ0MjsmIzI5MDMxOzwvdGV4dD48L2c+PCEtLWxpbmsgYjIgdG8gcjItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYjIiIGRhdGEtZW50aXR5LTI9InIyIiBkYXRhLXNvdXJjZS1saW5lPSIyMyIgZGF0YS11aWQ9ImxuazE2IiBpZD0ibGlua19iMl9yMiI+PHBhdGggZD0iTTI4MywzNDAuMTc2OSBDMjgzLDM2NS4zNzY5IDI4Myw0MjIuNzQ2OSAyODMsNDQ3LjkwNjkiIGZpbGw9Im5vbmUiIGlkPSJiMi10by1yMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjgzLDQ1My45MDY5LDI4Nyw0NDQuOTA2OSwyODMsNDQ4LjkwNjksMjc5LDQ0NC45MDY5LDI4Myw0NTMuOTA2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjAwMDEiIHg9IjI4NCIgeT0iMzk5LjM1MzgiPiYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMjE0NDI7JiMyOTAzMTs8L3RleHQ+PC9nPjwhLS1saW5rIGIyIHRvIHIzLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImIyIiBkYXRhLWVudGl0eS0yPSJyMyIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJsbmsxNyIgaWQ9ImxpbmtfYjJfcjMiPjxwYXRoIGQ9Ik0yOTkuNjEsMzQwLjA2NjkgQzMxNS41OSwzNTAuNjA2OSAzMzkuOTIsMzY3Ljg5NjkgMzU4LDM4Ni4yODY5IEMzNzkuMzEsNDA3Ljk2NjkgMzk1LjgzNjUsNDMyLjk0NjMgNDA1LjUzNjUsNDQ4LjcxNjMiIGZpbGw9Im5vbmUiIGlkPSJiMi10by1yMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDA4LjY4LDQ1My44MjY5LDQwNy4zNzE4LDQ0NC4wNjUzLDQwNi4wNjA0LDQ0OS41NjgsNDAwLjU1NzcsNDQ4LjI1NjYsNDA4LjY4LDQ1My44MjY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuMDAwMSIgeD0iMzczLjEyIiB5PSIzOTkuMzUzOCI+JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7JiMyMTQ0MjsmIzI5MDMxOzwvdGV4dD48L2c+PCEtLVNSQz1bVlA3REppOTA2NE50eW5HSnpZbWlFblUtSXU1ZzlEWVFNYlY2SFRsbTdtQVFBNjE5ajRJV0tiQ0RrNDFHVVBYblZkV0JmbnJBWVo3a2NaY3RTeV90Wk41aTUxTDhFYUZveDlBV2lWUXhENzFma3VwQzA3LSAtdXplSzA1dDk2Ujl3bjZFZngtS0R5c1F1Q2tBOTU5SkZPNDR4cnJNdjIyejBKalJwc3ExZllFa0UyRXBqNDU5UmlLYko0NmM3aUVNMFVMcjFDazFvZnJRODRVVUR0QnY2WVFuU2JETVNpZ3JELVlUWlNKZGZMX19hcWd5WUY5X0hlT1NoWXJYVkxxdXJ0S1pzQ0FfQU40XzAtN2hTaGw5WlNKcng2ajZXaXV0NEd4QWZZbml6dmktdDkxZ29hODdmejA0TlhWaUdEc1VhUG1hem00eVk4NzRHc2xWempMRmM5SjdHbXAtR05LN3MxeDlNazZOSHFYWm1UQ0lhVnJaYzNtUEtwTDFXTFpDQ3hHSGdYLTdVbjRQbmV1azNFcGctZWF1V25hRmMycVctQ1pUNmZpX0x5TUJDRnBSc285dVdRdTFpZHRTV3duN1AzeVlTUkRQVmh2RU1Zd25oN0RwSnJYVEdyM21Dd3R5MF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<table>
<thead>
<tr>
<th>目的</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>日計表出力</td>
<td>日単位の勘定科目別借方・貸方合計の集計</td>
</tr>
<tr>
<td>リアルタイム残高</td>
<td>仕訳入力と同時に残高を更新</td>
</tr>
<tr>
<td>監査証跡</td>
<td>日付別の取引履歴の保持</td>
</tr>
<tr>
<td>決算仕訳の区別</td>
<td>通常仕訳と決算仕訳の分離管理</td>
</tr>
</tbody>
</table>
<h3 id="_2">複合主キーによる多次元管理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>日次残高テーブルは、以下の6つのカラムで複合主キーを構成します。</p>
<table>
<thead>
<tr>
<th>カラム</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td>起票日</td>
<td>仕訳の起票日</td>
<td>2024-04-01</td>
</tr>
<tr>
<td>勘定科目コード</td>
<td>勘定科目マスタのコード</td>
<td>11110</td>
</tr>
<tr>
<td>補助科目コード</td>
<td>補助的な分類（空文字可）</td>
<td>空文字</td>
</tr>
<tr>
<td>部門コード</td>
<td>部門マスタのコード</td>
<td>10100</td>
</tr>
<tr>
<td>プロジェクトコード</td>
<td>プロジェクト単位管理（空文字可）</td>
<td>P001</td>
</tr>
<tr>
<td>決算仕訳フラグ</td>
<td>決算仕訳か否か</td>
<td>false</td>
</tr>
</tbody>
</table>
<p>この設計により、同じ勘定科目でも以下の粒度で残高を分けて管理できます。</p>
<ul>
<li>部門別の売上高</li>
<li>プロジェクト別の原価</li>
<li>通常仕訳と決算仕訳の分離</li>
</ul>
<hr />
<h2 id="182-mybatis">18.2 MyBatis 版との実装比較<a class="headerlink" href="#182-mybatis" title="Permanent link">&para;</a></h2>
<h3 id="_3">データアクセス層の比較<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>機能</th>
<th>MyBatis 版</th>
<th>JPA 版</th>
</tr>
</thead>
<tbody>
<tr>
<td>複合主キー</td>
<td>Key 内部クラス</td>
<td>@EmbeddedId + @Embeddable</td>
</tr>
<tr>
<td>検索結果マッピング</td>
<td>resultMap + DTO</td>
<td>Projection インターフェース</td>
</tr>
<tr>
<td>UPSERT</td>
<td>XML で INSERT ON CONFLICT</td>
<td>@Query + nativeQuery</td>
</tr>
<tr>
<td>集計クエリ</td>
<td>XML で GROUP BY</td>
<td>Native Query + Projection</td>
</tr>
<tr>
<td>日計表出力</td>
<td>resultMap でマッピング</td>
<td>Projection → DTO 変換</td>
</tr>
</tbody>
</table>
<h3 id="flyway">Flyway マイグレーション<a class="headerlink" href="#flyway" title="Permanent link">&para;</a></h3>
<details>
<summary>V008__create_daily_account_balance_table.sql</summary>

<div class="highlight"><pre><span></span><code><span class="c1">-- 日次勘定科目残高</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;日次勘定科目残高&quot;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="ss">&quot;起票日&quot;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;補助科目コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;部門コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;00000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;プロジェクトコード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;決算仕訳フラグ&quot;</span><span class="w"> </span><span class="nb">SMALLINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;借方金額&quot;</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;貸方金額&quot;</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;作成日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;更新日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="ss">&quot;起票日&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;勘定科目コード&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;補助科目コード&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;部門コード&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;プロジェクトコード&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;決算仕訳フラグ&quot;</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="ss">&quot;fk_日次残高_勘定科目&quot;</span>
<span class="w">        </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;勘定科目コード&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="ss">&quot;勘定科目マスタ&quot;</span><span class="p">(</span><span class="ss">&quot;勘定科目コード&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="ss">&quot;fk_日次残高_部門&quot;</span>
<span class="w">        </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;部門コード&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="ss">&quot;部門マスタ&quot;</span><span class="p">(</span><span class="ss">&quot;部門コード&quot;</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- インデックス</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_日次残高_起票日&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;日次勘定科目残高&quot;</span><span class="p">(</span><span class="ss">&quot;起票日&quot;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_日次残高_勘定科目&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;日次勘定科目残高&quot;</span><span class="p">(</span><span class="ss">&quot;勘定科目コード&quot;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_日次残高_部門&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;日次勘定科目残高&quot;</span><span class="p">(</span><span class="ss">&quot;部門コード&quot;</span><span class="p">);</span>
</code></pre></div>

</details>

<hr />
<h2 id="183-jpa">18.3 JPA エンティティの実装<a class="headerlink" href="#183-jpa" title="Permanent link">&para;</a></h2>
<h3 id="embeddable">複合主キークラス（@Embeddable）<a class="headerlink" href="#embeddable" title="Permanent link">&para;</a></h3>
<details>
<summary>DailyAccountBalanceId.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Column</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Embeddable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Objects</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日次勘定科目残高の複合主キー</span>
<span class="cm"> *</span>
<span class="cm"> * JPA では @EmbeddedId で複合主キーを表現</span>
<span class="cm"> * MyBatis 版では Key 内部クラスを使用していたが、</span>
<span class="cm"> * JPA 版では @Embeddable アノテーション付きクラスで実装</span>
<span class="cm"> *</span>
<span class="cm"> * 注意: equals() と hashCode() の実装が必須</span>
<span class="cm"> */</span>
<span class="nd">@Embeddable</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DailyAccountBalanceId</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;起票日&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">postingDate</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;補助科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">departmentCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;プロジェクトコード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">projectCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;決算仕訳フラグ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">closingJournalFlag</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">equals</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getClass</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">getClass</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">DailyAccountBalanceId</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DailyAccountBalanceId</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">postingDate</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">postingDate</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">accountCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">subAccountCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">departmentCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">departmentCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">projectCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">closingJournalFlag</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">closingJournalFlag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">hash</span><span class="p">(</span><span class="n">postingDate</span><span class="p">,</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">,</span>
<span class="w">                           </span><span class="n">departmentCode</span><span class="p">,</span><span class="w"> </span><span class="n">projectCode</span><span class="p">,</span><span class="w"> </span><span class="n">closingJournalFlag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="entity">日次勘定科目残高 Entity<a class="headerlink" href="#entity" title="Permanent link">&para;</a></h3>
<details>
<summary>DailyAccountBalance.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.department.Department</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日次勘定科目残高 Entity</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では @EmbeddedId で複合主キーを定義</span>
<span class="cm"> * MyBatis 版では単純な POJO + Key 内部クラスだったが、</span>
<span class="cm"> * JPA 版では Entity アノテーションと関連定義が必要</span>
<span class="cm"> */</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;日次勘定科目残高&quot;</span><span class="p">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DailyAccountBalance</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 複合主キー</span>
<span class="cm">     * @EmbeddedId で埋め込みIDを使用</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@EmbeddedId</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">DailyAccountBalanceId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 勘定科目マスタとの関連</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@ManyToOne</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">referencedColumnName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 部門マスタとの関連</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@ManyToOne</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">referencedColumnName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="n">department</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;借方金額&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitAmount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;貸方金額&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditAmount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;作成日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;更新日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">updatedAt</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 残高を計算する（貸借区分に応じて）</span>
<span class="cm">     * @param isDebitAccount 借方勘定かどうか</span>
<span class="cm">     * @return 残高</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculateBalance</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isDebitAccount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDebitAccount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 借方勘定：借方 - 貸方</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">debitAmount</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">creditAmount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 貸方勘定：貸方 - 借方</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">creditAmount</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">debitAmount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 金額を加算する</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addAmounts</span><span class="p">(</span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debit</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">credit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">debit</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">credit</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PrePersist</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PreUpdate</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onUpdate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="projection">日計表行用 Projection インターフェース<a class="headerlink" href="#projection" title="Permanent link">&para;</a></h3>
<details>
<summary>DailyReportLineProjection.java と DailyReportLine.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日計表行の Projection インターフェース</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では Projection インターフェースを使用して</span>
<span class="cm"> * 集計クエリの結果をマッピング</span>
<span class="cm"> * MyBatis 版では resultMap で DTO にマッピングしていた</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DailyReportLineProjection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="nf">getReportDate</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getAccountCode</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getAccountName</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getSubAccountCode</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getSubAccountName</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getDebitTotal</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getCreditTotal</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getBalance</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日計表行 DTO</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DailyReportLine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">reportDate</span><span class="p">;</span><span class="w">         </span><span class="c1">// 対象日</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span><span class="w">           </span><span class="c1">// 勘定科目コード</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span><span class="w">           </span><span class="c1">// 勘定科目名</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">;</span><span class="w">        </span><span class="c1">// 補助科目コード</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subAccountName</span><span class="p">;</span><span class="w">        </span><span class="c1">// 補助科目名</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitTotal</span><span class="p">;</span><span class="w">        </span><span class="c1">// 借方合計</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditTotal</span><span class="p">;</span><span class="w">       </span><span class="c1">// 貸方合計</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span><span class="w">           </span><span class="c1">// 残高</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Projection から DTO を生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">DailyReportLine</span><span class="w"> </span><span class="nf">fromProjection</span><span class="p">(</span><span class="n">DailyReportLineProjection</span><span class="w"> </span><span class="n">projection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DailyReportLine</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">reportDate</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getReportDate</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">accountName</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getSubAccountCode</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">subAccountName</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getSubAccountName</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">debitTotal</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getDebitTotal</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">creditTotal</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getCreditTotal</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">balance</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getBalance</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="184-tdd">18.4 TDD による日次残高テーブルの実装<a class="headerlink" href="#184-tdd" title="Permanent link">&para;</a></h2>
<h3 id="_4">リポジトリのテスト<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<details>
<summary>DailyAccountBalanceRepositoryTest.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance.DailyAccountBalance</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance.DailyAccountBalanceId</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository.DailyAccountBalanceJpaRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.DisplayName</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Nested</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.DynamicPropertyRegistry</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.DynamicPropertySource</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.containers.PostgreSQLContainer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.junit.jupiter.Container</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.*</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日次勘定科目残高リポジトリのテスト</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では @DataJpaTest を使用（MyBatis 版では @MybatisTest）</span>
<span class="cm"> */</span>
<span class="nd">@DataJpaTest</span>
<span class="nd">@AutoConfigureTestDatabase</span><span class="p">(</span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutoConfigureTestDatabase</span><span class="p">.</span><span class="na">Replace</span><span class="p">.</span><span class="na">NONE</span><span class="p">)</span>
<span class="nd">@Testcontainers</span>
<span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;日次勘定科目残高リポジトリのテスト&quot;</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">DailyAccountBalanceRepositoryTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Container</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">PostgreSQLContainer</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PostgreSQLContainer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;postgres:16&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withDatabaseName</span><span class="p">(</span><span class="s">&quot;testdb&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withUsername</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withPassword</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nd">@DynamicPropertySource</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configureProperties</span><span class="p">(</span><span class="n">DynamicPropertyRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.url&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getJdbcUrl</span><span class="p">);</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.username&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getUsername</span><span class="p">);</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.password&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getPassword</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">DailyAccountBalanceJpaRepository</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;日次残高の登録・更新&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">DailyBalanceUpsertTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;新規の日次残高を登録できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldInsertNewDailyBalance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DailyAccountBalanceId</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">postingDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="s">&quot;11110&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 現金</span>
<span class="w">                </span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">departmentCode</span><span class="p">(</span><span class="s">&quot;10100&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">projectCode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">closingJournalFlag</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DailyAccountBalance</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">debitAmount</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;100000&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">creditAmount</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// When</span>
<span class="w">            </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">saved</span><span class="p">).</span><span class="na">isPresent</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">saved</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getDebitAmount</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">isEqualByComparingTo</span><span class="p">(</span><span class="s">&quot;100000&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;既存の日次残高を更新できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldUpdateExistingDailyBalance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given: 初回登録</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DailyAccountBalanceId</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">postingDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="s">&quot;11110&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">departmentCode</span><span class="p">(</span><span class="s">&quot;10100&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">projectCode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">closingJournalFlag</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">balance1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DailyAccountBalance</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">debitAmount</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;100000&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">creditAmount</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">            </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">balance1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// When: 金額を追加</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">saved</span><span class="p">.</span><span class="na">addAmounts</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;50000&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">);</span>
<span class="w">            </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">saved</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then: 合算される</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">updated</span><span class="p">).</span><span class="na">isPresent</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">updated</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getDebitAmount</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">isEqualByComparingTo</span><span class="p">(</span><span class="s">&quot;150000&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;日次残高の検索&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">DailyBalanceSearchTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;日付範囲で日次残高を検索できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldFindBalancesByDateRange</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// When</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">balances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">findByIdPostingDateBetween</span><span class="p">(</span>
<span class="w">                </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">                </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">balances</span><span class="p">).</span><span class="na">allMatch</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">!</span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getPostingDate</span><span class="p">().</span><span class="na">isBefore</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="o">!</span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getPostingDate</span><span class="p">().</span><span class="na">isAfter</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">))</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;勘定科目コードで日次残高を検索できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldFindBalancesByAccountCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// When</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">balances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">findByIdAccountCode</span><span class="p">(</span><span class="s">&quot;11110&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">balances</span><span class="p">).</span><span class="na">allMatch</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getAccountCode</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;11110&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="185-jparepository">18.5 JpaRepository インターフェース<a class="headerlink" href="#185-jparepository" title="Permanent link">&para;</a></h2>
<h3 id="repository">日次勘定科目残高 Repository<a class="headerlink" href="#repository" title="Permanent link">&para;</a></h3>
<details>
<summary>DailyAccountBalanceJpaRepository.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance.DailyAccountBalance</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance.DailyAccountBalanceId</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance.DailyReportLineProjection</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.Modifying</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.Query</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.query.Param</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日次勘定科目残高 JpaRepository</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では JpaRepository を継承</span>
<span class="cm"> * 複合主キーは DailyAccountBalanceId として定義</span>
<span class="cm"> * 集計クエリは @Query + Projection で実装</span>
<span class="cm"> */</span>
<span class="nd">@Repository</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DailyAccountBalanceJpaRepository</span>
<span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">DailyAccountBalance</span><span class="p">,</span><span class="w"> </span><span class="n">DailyAccountBalanceId</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 日付範囲で検索</span>
<span class="cm">     * メソッド名規約で自動生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DailyAccountBalance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByIdPostingDateBetween</span><span class="p">(</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">fromDate</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">toDate</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 起票日で検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DailyAccountBalance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByIdPostingDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="w"> </span><span class="n">postingDate</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 勘定科目コードで検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DailyAccountBalance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByIdAccountCode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 部門コードで検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DailyAccountBalance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByIdDepartmentCode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">departmentCode</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 日計表データ取得</span>
<span class="cm">     * Native Query で集計クエリを実行し、Projection にマッピング</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT</span>
<span class="s">            d.&quot;起票日&quot; as reportDate,</span>
<span class="s">            d.&quot;勘定科目コード&quot; as accountCode,</span>
<span class="s">            a.&quot;勘定科目名&quot; as accountName,</span>
<span class="s">            d.&quot;補助科目コード&quot; as subAccountCode,</span>
<span class="s">            &#39;&#39; as subAccountName,</span>
<span class="s">            SUM(d.&quot;借方金額&quot;) as debitTotal,</span>
<span class="s">            SUM(d.&quot;貸方金額&quot;) as creditTotal,</span>
<span class="s">            CASE</span>
<span class="s">                WHEN a.&quot;貸借区分&quot; = &#39;借方&#39;</span>
<span class="s">                THEN SUM(d.&quot;借方金額&quot;) - SUM(d.&quot;貸方金額&quot;)</span>
<span class="s">                ELSE SUM(d.&quot;貸方金額&quot;) - SUM(d.&quot;借方金額&quot;)</span>
<span class="s">            END as balance</span>
<span class="s">        FROM &quot;日次勘定科目残高&quot; d</span>
<span class="s">        JOIN &quot;勘定科目マスタ&quot; a ON d.&quot;勘定科目コード&quot; = a.&quot;勘定科目コード&quot;</span>
<span class="s">        WHERE d.&quot;起票日&quot; = :reportDate</span>
<span class="s">        GROUP BY d.&quot;起票日&quot;, d.&quot;勘定科目コード&quot;, a.&quot;勘定科目名&quot;,</span>
<span class="s">                 d.&quot;補助科目コード&quot;, a.&quot;貸借区分&quot;</span>
<span class="s">        ORDER BY d.&quot;勘定科目コード&quot;, d.&quot;補助科目コード&quot;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nativeQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DailyReportLineProjection</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getDailyReport</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;reportDate&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">reportDate</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * UPSERT 用のカスタムクエリ</span>
<span class="cm">     * PostgreSQL の ON CONFLICT を使用</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Modifying</span>
<span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        INSERT INTO &quot;日次勘定科目残高&quot; (</span>
<span class="s">            &quot;起票日&quot;, &quot;勘定科目コード&quot;, &quot;補助科目コード&quot;,</span>
<span class="s">            &quot;部門コード&quot;, &quot;プロジェクトコード&quot;, &quot;決算仕訳フラグ&quot;,</span>
<span class="s">            &quot;借方金額&quot;, &quot;貸方金額&quot;, &quot;作成日時&quot;, &quot;更新日時&quot;</span>
<span class="s">        ) VALUES (</span>
<span class="s">            :postingDate, :accountCode, :subAccountCode,</span>
<span class="s">            :departmentCode, :projectCode, :closingJournalFlag,</span>
<span class="s">            :debitAmount, :creditAmount, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP</span>
<span class="s">        )</span>
<span class="s">        ON CONFLICT (</span>
<span class="s">            &quot;起票日&quot;, &quot;勘定科目コード&quot;, &quot;補助科目コード&quot;,</span>
<span class="s">            &quot;部門コード&quot;, &quot;プロジェクトコード&quot;, &quot;決算仕訳フラグ&quot;</span>
<span class="s">        )</span>
<span class="s">        DO UPDATE SET</span>
<span class="s">            &quot;借方金額&quot; = &quot;日次勘定科目残高&quot;.&quot;借方金額&quot; + EXCLUDED.&quot;借方金額&quot;,</span>
<span class="s">            &quot;貸方金額&quot; = &quot;日次勘定科目残高&quot;.&quot;貸方金額&quot; + EXCLUDED.&quot;貸方金額&quot;,</span>
<span class="s">            &quot;更新日時&quot; = CURRENT_TIMESTAMP</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nativeQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;postingDate&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">postingDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;accountCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;subAccountCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;departmentCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">departmentCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;projectCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">projectCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;closingJournalFlag&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">closingJournalFlag</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;debitAmount&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitAmount</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;creditAmount&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditAmount</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="186">18.6 月次勘定科目残高の設計<a class="headerlink" href="#186" title="Permanent link">&para;</a></h2>
<h3 id="_5">月次残高管理の目的<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>月次勘定科目残高は、月単位での残高管理を行い、合計残高試算表や財務諸表の出力に使用します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ5MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODM2cHg7aGVpZ2h0OjQ5MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgzNiA0OTEiIHdpZHRoPSI4MzZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMjYzNzY7JiMyNzQyNTsmIzI3NTMxOyYjMzk2NDA7JiMzMTY0OTsmIzI5NzAyOyYjMTIzOTg7JiMyNDQ0MTsmIzIxMTA2OzwvdGl0bGU+PGRlZnMvPjxnPjxnIGNsYXNzPSJ0aXRsZSIgZGF0YS1zb3VyY2UtbGluZT0iMSI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzNDguMDAwMyIgeT0iMjIuOTk1MSI+JiMyNjM3NjsmIzI3NDI1OyYjMjc1MzE7JiMzOTY0MDsmIzMxNjQ5OyYjMjk3MDI7JiMxMjM5ODsmIzI0NDQxOyYjMjExMDY7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBkYWlseS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iZGFpbHkiIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl9kYWlseSI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI3My4yOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIzMyIgeD0iNyIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI5NS41MDAxIiB5PSI1OS4yOTIiPiYjMjYwODU7JiMyNzQyNTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBtb250aGx5LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJtb250aGx5IiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImNsdXN0ZXJfbW9udGhseSI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIzMTkuMjYiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzYiIHg9IjciIHk9IjE2Ni41ODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjQ3LjAwMDEiIHk9IjE4MS41ODIiPiYjMjYzNzY7JiMyNzQyNTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjbG9zaW5nLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJjbG9zaW5nIiBkYXRhLXNvdXJjZS1saW5lPSIxNCIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJjbHVzdGVyX2Nsb3NpbmciPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjUxMSIgeD0iMzE5IiB5PSIyODEuNTY2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI1MzkuNTAwMiIgeT0iMjk2LjU2MiI+JiMyNDExNTsmIzMxMDgwOyYjMTI1Mzk7JiMyNzc3MDsmIzMxNjM5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBkMS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJkMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJlbnRpdHlfZDEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjIzIiB5PSI3OS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMzMiIHk9Ijk1LjI5MiI+JiMyNjA4NTsmIzI3NDI1OyYjMjc1MzE7JiMzOTY0MDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tZW50aXR5IGQyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImQyIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9kMiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI2MS45OTk4IiB4PSIxNjIiIHk9Ijc5LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS45OTk4IiB4PSIxNzIiIHk9Ijk1LjI5MiI+JiMyNjA4NTsmIzM1MzM2OyYjMzQ5MjA7PC90ZXh0PjwvZz48IS0tZW50aXR5IG0xLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Im0xIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9tMSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMDMuOTk5NiIgeD0iMjMiIHk9IjMxNi41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMzMiIHk9IjMzMi41NjIiPiYjMjYzNzY7JiMyNjQxMTsmIzI3NTMxOyYjMzk2NDA7JiMzMDkwNjsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBtMi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJtMiIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5X20yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMy45OTk2IiB4PSIyMyIgeT0iMjAxLjU4NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIzMyIgeT0iMjE3LjU4MiI+JiMyNjM3NjsmIzI3NDI1OyYjMjc1MzE7JiMzOTY0MDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tZW50aXR5IG0zLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Im0zIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfbTMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzUuOTk5OCIgeD0iMzciIHk9IjQ0Ny41NDY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNDciIHk9IjQ2My41NDIiPiYjMzIzNjg7JiMzNjIzNDsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5IGMxLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImMxIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfYzEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTE3Ljk5OTYiIHg9IjMzNSIgeT0iMzE2LjU2NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIzNDUiIHk9IjMzMi41NjIiPiYjMjE1MTI7JiMzNTMzNjsmIzI3NTMxOyYjMzk2NDA7JiMzNTQzMDsmIzMxNjM5OyYjMzQ5MjA7PC90ZXh0PjwvZz48IS0tZW50aXR5IGMyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImMyIiBkYXRhLXNvdXJjZS1saW5lPSIxNiIgZGF0YS11aWQ9ImVudDAwMTEiIGlkPSJlbnRpdHlfYzIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iODkuOTk5NyIgeD0iNDg4IiB5PSIzMTYuNTY2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjQ5OCIgeT0iMzMyLjU2MiI+JiMyNTYxMzsmIzMwNDEwOyYjMzUzMzY7JiMzMTYzOTsmIzI2MzYwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBjMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjMyIgZGF0YS1zb3VyY2UtbGluZT0iMTciIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5X2MzIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijg5Ljk5OTciIHg9IjYxMyIgeT0iMzE2LjU2NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2MjMiIHk9IjMzMi41NjIiPiYjMzYwMjQ7JiMyMDUxMTsmIzIzNTUwOyYjMjkwMzE7JiMzNDkyMDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYzQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iYzQiIGRhdGEtc291cmNlLWxpbmU9IjE4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9jNCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3NS45OTk4IiB4PSI3MzgiIHk9IjMxNi41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNzQ4IiB5PSIzMzIuNTYyIj4mIzI3NzcwOyYjMzE2Mzk7JiMyMDE4MTsmIzM1Mzc5OzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjIxIiBkYXRhLXNvdXJjZS1saW5lPSIzMCIgZGF0YS11aWQ9ImVudDAwMjIiIGlkPSJlbnRpdHlfR01OMjEiPjxwYXRoIGQ9Ik0xNjIsMjg0Ljg4NjkgTDE2MiwzNzAuNTUwOSBBMCwwIDAgMCAwIDE2MiwzNzAuNTUwOSBMMzAwLjAwMDEsMzcwLjU1MDkgQTAsMCAwIDAgMCAzMDAuMDAwMSwzNzAuNTUwOSBMMzAwLjAwMDEsMjk0Ljg4NjkgTDI5MC4wMDAxLDI4NC44ODY5IEwxNzYuNzUsMjg0Ljg4NjkgTDg5LjY4LDIyNC4zNjY5IEwxNjguNzUsMjg0Ljg4NjkgTDE2MiwyODQuODg2OSBBMCwwIDAgMCAwIDE2MiwyODQuODg2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTI5MC4wMDAxLDI4NC44ODY5IEwyOTAuMDAwMSwyOTQuODg2OSBMMzAwLjAwMDEsMjk0Ljg4NjkgTDI5MC4wMDAxLDI4NC44ODY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuMDAwMSIgeD0iMTY4IiB5PSIzMDEuOTUzOCI+JiMyNjM3NjsmIzI3NDI1OyYjMjEyMDg7JiMyMzQ1MDsmIzMxMTg1OyYjMzA0NDY7JiMyNzUzMTsmIzM5NjQwOyYjMTIzOTk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjAwMDEiIHg9IjE2OCIgeT0iMzE3LjA4NjYiPiYjMTI1Mzk7JiMyNjM3NjsmIzIxMDIxOyYjMjc1MzE7JiMzOTY0MDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjE2OCIgeT0iMzMyLjIxOTQiPiYjMTI1Mzk7JiMyNDQwMzsmIzI2Mzc2OyYjMjA1MTE7JiMyNjA0MTsmIzEyNTM5OyYjMzYwMjQ7JiMyNjA0MTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuMDAwMSIgeD0iMTY4IiB5PSIzNDcuMzUyMiI+JiMxMjUzOTsmIzI2Mzc2OyYjMjY0MTE7JiMyNzUzMTsmIzM5NjQwOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOSIgeD0iMTY4IiB5PSIzNjIuNDg1Ij4mIzEyNDM0OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1saW5rIGQxIHRvIG0yLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImQxIiBkYXRhLWVudGl0eS0yPSJtMiIgZGF0YS1zb3VyY2UtbGluZT0iMjEiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfZDFfbTIiPjxwYXRoIGQ9Ik03NSwxMDEuNjk2OSBDNzUsMTI0LjMwNjkgNzUsMTcyLjI1NjkgNzUsMTk1LjE2NjkiIGZpbGw9Im5vbmUiIGlkPSJkMS10by1tMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzUsMjAxLjE2NjksNzksMTkyLjE2NjksNzUsMTk2LjE2NjksNzEsMTkyLjE2NjksNzUsMjAxLjE2NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSI3NiIgeT0iMTQ2LjY1MzgiPiYjMjYzNzY7JiMyNjQxMTsmIzM4NTk4OyYjMzUzMzY7PC90ZXh0PjwvZz48IS0tbGluayBtMiB0byBtMS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJtMiIgZGF0YS1lbnRpdHktMj0ibTEiIGRhdGEtc291cmNlLWxpbmU9IjIyIiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX20yX20xIj48cGF0aCBkPSJNNzUsMjI0LjE2NjkgQzc1LDI0NS42ODY5IDc1LDI4OC44MTY5IDc1LDMxMC4zMTY5IiBmaWxsPSJub25lIiBpZD0ibTItdG8tbTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9Ijc1LDMxNi4zMTY5LDc5LDMwNy4zMTY5LDc1LDMxMS4zMTY5LDcxLDMwNy4zMTY5LDc1LDMxNi4zMTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIG0xIHRvIG0zLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Im0xIiBkYXRhLWVudGl0eS0yPSJtMyIgZGF0YS1zb3VyY2UtbGluZT0iMjMiIGRhdGEtdWlkPSJsbmsxNiIgaWQ9ImxpbmtfbTFfbTMiPjxwYXRoIGQ9Ik03NSwzMzkuMjc2OSBDNzUsMzYzLjU3NjkgNzUsNDE3LjI1NjkgNzUsNDQxLjM1NjkiIGZpbGw9Im5vbmUiIGlkPSJtMS10by1tMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzUsNDQ3LjM1NjksNzksNDM4LjM1NjksNzUsNDQyLjM1NjksNzEsNDM4LjM1NjksNzUsNDQ3LjM1NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOSIgeD0iNzYiIHk9IjQxMy42MTM4Ij4mIzMyNzE2OyYjMjYzNzY7JiMyMTAyMTs8L3RleHQ+PC9nPjwhLS1saW5rIG0yIHRvIGMxLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Im0yIiBkYXRhLWVudGl0eS0yPSJjMSIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJsbmsxNyIgaWQ9ImxpbmtfbTJfYzEiPjxwYXRoIGQ9Ik0xMjcuMDgsMjIwLjg1NjkgQzE3Ny41NywyMjkuMDY2OSAyNTUuNDgsMjQ1LjIxNjkgMzE4LDI3My41NjY5IEMzNDIuNjMsMjg0Ljc0NjkgMzYzLjA3NywzMDAuMjc2MiAzNzcuMzc3LDMxMi4yOTYyIiBmaWxsPSJub25lIiBpZD0ibTItdG8tYzEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM4MS45NywzMTYuMTU2OSwzNzcuNjU0MywzMDcuMzAzOSwzNzguMTQyNSwzMTIuOTM5NywzNzIuNTA2OCwzMTMuNDI3OSwzODEuOTcsMzE2LjE1NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgbTIgdG8gYzItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ibTIiIGRhdGEtZW50aXR5LTI9ImMyIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19tMl9jMiI+PHBhdGggZD0iTTEyNy40LDIxMi43ODY5IEMyMDUuNTQsMjEzLjI5NjkgMzU1LjY2LDIyMS43NDY5IDQ3MCwyNzMuNTY2OSBDNDkyLjE2LDI4My42MTY5IDUwOC42MzI1LDI5OS4zMTg1IDUxOS45MTI1LDMxMS43MTg1IiBmaWxsPSJub25lIiBpZD0ibTItdG8tYzIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMy45NSwzMTYuMTU2OSw1MjAuODUyNywzMDYuODA3Nyw1MjAuNTg1NCwzMTIuNDU4Myw1MTQuOTM0OSwzMTIuMTkxLDUyMy45NSwzMTYuMTU2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBtMiB0byBjMy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJtMiIgZGF0YS1lbnRpdHktMj0iYzMiIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0ibG5rMTkiIGlkPSJsaW5rX20yX2MzIj48cGF0aCBkPSJNMTI3LjI2LDIxNS44MTY5IEMyNDEuOTMsMjIxLjAyNjkgNTExLjk4LDIzNi44ODY5IDU5NSwyNzMuNTY2OSBDNjE3LjI1LDI4My4zOTY5IDYzMy43MTA5LDI5OS4xNjE5IDY0NC45NjA5LDMxMS42MzE5IiBmaWxsPSJub25lIiBpZD0ibTItdG8tYzMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY0OC45OCwzMTYuMDg2OSw2NDUuOTIxMywzMDYuNzI1LDY0NS42MzA3LDMxMi4zNzQ0LDYzOS45ODE0LDMxMi4wODM4LDY0OC45OCwzMTYuMDg2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBjNCB0byBtMi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjNCIgZGF0YS1lbnRpdHktMj0ibTIiIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0ibG5rMjAiIGlkPSJsaW5rX2M0X20yIj48cGF0aCBkPSJNNzY4LjYxLDMxNi40NjY5IEM3NTguOTcsMzAzLjk5NjkgNzQwLjg3LDI4My4zNjY5IDcyMCwyNzMuNTY2OSBDNjE1LjE1LDIyNC4zMzY5IDI2Ny4zODk2LDIxNS42NjU3IDEzMy4xOTk2LDIxNC4xMjU3IiBmaWxsPSJub25lIiBpZD0iYzQtdG8tbTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEyNy4yLDIxNC4wNTY5LDEzNi4xNTM1LDIxOC4xNTk5LDEzMi4xOTk3LDIxNC4xMTQzLDEzNi4yNDUzLDIxMC4xNjA0LDEyNy4yLDIxNC4wNTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1TUkM9W1JQQkRKaTkwNThOdHluR0p6WW1BaDVwdUJoTWpJNEJSMUJlbm5XR3FPV0xESzJDR1lvNk8wM01HV2MwQ0ZxNFZmaXZDVUdqbEVzc2puanRDRlRfU1MteEM2ME1aZzYzUURVY2FKdnQ2UmpuWEpmeXJRc3hMOFRpTGtQZVpMNThhR3pKb1dBTGVVbTBTa0htMmFTOVk2U2pZZU5ZQ0p2MGFia0g4dmNzZXpLUFJDbXU5RnhmZGNyeFZ2a0tDRWx0VEZLWUh3QXhnY2Q2S3gwejBUbnA2VjV1SnZ2NVpHYUJfbnJfRFgzZlJwUnB0VWo4Vy1vUzJNSXhPbTdSRkRfSHJwUG5zMDRiNWxMcEd5ZDRBcVpIWDJreFlsR20xWW9RSXVZM0Q2c1JMV0dBSE1haWtIWWN5LVA5S1VjSndtSXY2eVNiaVQzQm1fVGV5VUZRMkFwYV9lWXBXVDdlVjlpNXhjRF8ycGdmMVZtSUxHMTJHNlk5UEdEWmRETDM0VjhmcUkxUWpDbDRBRjdEWE11R3F0TDNtV011T2tlaHJHeHlLRmFVWjBfVkNIaFZDU2xaQ1JkTUFfMWlBMzdaOXR2RmpsTC1nejZYaDFMa080WE9YNkJ5UVNpX2stMFQzWVlQWnRfR1JdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<table>
<thead>
<tr>
<th>目的</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>合計残高試算表</td>
<td>月次の勘定科目別借方・貸方・残高の集計</td>
</tr>
<tr>
<td>財務諸表出力</td>
<td>貸借対照表・損益計算書のデータソース</td>
</tr>
<tr>
<td>月次決算</td>
<td>月末残高の確定と繰越処理</td>
</tr>
<tr>
<td>決算仕訳対応</td>
<td>通常仕訳と決算仕訳の分離管理</td>
</tr>
</tbody>
</table>
<h3 id="er">月次勘定科目残高テーブルの ER 図<a class="headerlink" href="#er" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjQ0N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjI4cHg7aGVpZ2h0OjQ0N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDYyOCA0NDciIHdpZHRoPSI2MjhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbGFzcyBNb250aGx5QmFsYW5jZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJNb250aGx5QmFsYW5jZSIgZGF0YS1zb3VyY2UtbGluZT0iMSIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfTW9udGhseUJhbGFuY2UiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjI3LjI2NTYiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5OS41MDU0IiB4PSI3IiB5PSIyMTMuNDgiLz48ZWxsaXBzZSBjeD0iOTYuNTAzIiBjeT0iMjI5LjQ4IiBmaWxsPSIjQUREMUIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0xMDAuNjEyMywyMzUuNDggTDkyLjg5MzYsMjM1LjQ4IEw5Mi44OTM2LDIyMy4wODk0IEwxMDAuNjEyMywyMjMuMDg5NCBMMTAwLjYxMjMsMjI1LjI0NTYgTDk1LjM0NjcsMjI1LjI0NTYgTDk1LjM0NjcsMjI3LjkxNzUgTDEwMC4xMTIzLDIyNy45MTc1IEwxMDAuMTEyMywyMzAuMDczOCBMOTUuMzQ2NywyMzAuMDczOCBMOTUuMzQ2NywyMzMuMzIzOCBMMTAwLjYxMjMsMjMzLjMyMzggTDEwMC42MTIzLDIzNS40OCBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxMTcuMDAzIiB5PSIyMzQuMzI2NyI+JiMyNjM3NjsmIzI3NDI1OyYjMjEyMDg7JiMyMzQ1MDsmIzMxMTg1OyYjMzA0NDY7JiMyNzUzMTsmIzM5NjQwOzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMzA1LjUwNTQiIHkxPSIyNDUuNDgiIHkyPSIyNDUuNDgiLz48ZWxsaXBzZSBjeD0iMTgiIGN5PSIyNTkuMTI4NCIgZmlsbD0iIzAwMDAwMCIgcng9IjMiIHJ5PSIzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxLjk5OTgiIHg9IjI3IiB5PSIyNjIuNDc1MSI+JiMyNzc3MDsmIzMxNjM5OyYjMjYzOTk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwOS43OTIiIHg9IjY4Ljk5OTgiIHk9IjI2Mi40NzUxIj46IElOVEVHRVIgJiMxNzE7UEsmIzE4Nzs8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMjc1LjQyNTMiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy45OTk5IiB4PSIyNyIgeT0iMjc4Ljc3MiI+JiMyNjM3NjsmIzI0MjMwOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuNjY3IiB4PSI1NC45OTk5IiB5PSIyNzguNzcyIj46IFNNQUxMSU5UICYjMTcxO1BLJiMxODc7PC90ZXh0PjxlbGxpcHNlIGN4PSIxOCIgY3k9IjI5MS43MjIyIiBmaWxsPSIjMDAwMDAwIiByeD0iMyIgcnk9IjMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMjciIHk9IjI5NS4wNjg5Ij4mIzIxMjA4OyYjMjM0NTA7JiMzMTE4NTsmIzMwNDQ2OyYjMTI0Njc7JiMxMjU0MDsmIzEyNDg5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzUuNTA1OSIgeD0iMTI0Ljk5OTYiIHk9IjI5NS4wNjg5Ij46IFZBUkNIQVIoNSkgJiMxNzE7UEsmIzE4NzsgJiMxNzE7RksmIzE4Nzs8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzA4LjAxOTEiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIyNyIgeT0iMzExLjM2NTciPiYjMzUwMzY7JiMyMTE2MTsmIzMxMTg1OyYjMzA0NDY7JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NS41OTg2IiB4PSIxMjQuOTk5NiIgeT0iMzExLjM2NTciPjogVkFSQ0hBUigxMCkgJiMxNzE7UEsmIzE4Nzs8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzI0LjMxNTkiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIyNyIgeT0iMzI3LjY2MjYiPiYjMzcwOTY7JiMzODI3MjsmIzEyNDY3OyYjMTI1NDA7JiMxMjQ4OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc1LjUwNTkiIHg9Ijk2Ljk5OTciIHk9IjMyNy42NjI2Ij46IFZBUkNIQVIoNSkgJiMxNzE7UEsmIzE4NzsgJiMxNzE7RksmIzE4Nzs8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzQwLjYxMjgiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMjciIHk9IjM0My45NTk1Ij4mIzEyNTAzOyYjMTI1MjU7JiMxMjQ3MjsmIzEyNDU1OyYjMTI0NjM7JiMxMjQ4ODsmIzEyNDY3OyYjMTI1NDA7JiMxMjQ4OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ1LjU5ODYiIHg9IjE1Mi45OTk1IiB5PSIzNDMuOTU5NSI+OiBWQVJDSEFSKDEwKSAmIzE3MTtQSyYjMTg3OzwvdGV4dD48ZWxsaXBzZSBjeD0iMTgiIGN5PSIzNTYuOTA5NyIgZmlsbD0iIzAwMDAwMCIgcng9IjMiIHJ5PSIzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjI3IiB5PSIzNjAuMjU2NCI+JiMyNzc3MDsmIzMxNjM5OyYjMjAxODE7JiMzNTM3OTsmIzEyNTAxOyYjMTI1MjE7JiMxMjQ2NDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE3LjY2NyIgeD0iMTI0Ljk5OTYiIHk9IjM2MC4yNTY0Ij46IFNNQUxMSU5UICYjMTcxO1BLJiMxODc7PC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI4IiB4Mj0iMzA1LjUwNTQiIHkxPSIzNjcuNTU4MSIgeTI9IjM2Ny41NTgxIi8+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzgxLjIwNjYiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyNyIgeT0iMzg0LjU1MzIiPiYjMjYzNzY7JiMyMTAyMTsmIzI3NTMxOyYjMzk2NDA7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNC4yNDkiIHg9IjgyLjk5OTgiIHk9IjM4NC41NTMyIj46IERFQ0lNQUwoMTMsMCk8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzk3LjUwMzQiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyNyIgeT0iNDAwLjg1MDEiPiYjMjA1MTE7JiMyNjA0MTsmIzM3MzI5OyYjMzg5ODk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNC4yNDkiIHg9IjgyLjk5OTgiIHk9IjQwMC44NTAxIj46IERFQ0lNQUwoMTQsMik8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iNDEzLjgwMDMiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyNyIgeT0iNDE3LjE0NyI+JiMzNjAyNDsmIzI2MDQxOyYjMzczMjk7JiMzODk4OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE0LjI0OSIgeD0iODIuOTk5OCIgeT0iNDE3LjE0NyI+OiBERUNJTUFMKDE0LDIpPC90ZXh0PjxlbGxpcHNlIGN4PSIxOCIgY3k9IjQzMC4wOTcyIiBmaWxsPSIjMDAwMDAwIiByeD0iMyIgcnk9IjMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjciIHk9IjQzMy40NDM5Ij4mIzI2Mzc2OyYjMjY0MTE7JiMyNzUzMTsmIzM5NjQwOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTQuMjQ5IiB4PSI4Mi45OTk4IiB5PSI0MzMuNDQzOSI+OiBERUNJTUFMKDEzLDApPC90ZXh0PjwvZz48IS0tY2xhc3MgRGFpbHlCYWxhbmNlLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkRhaWx5QmFsYW5jZSIgZGF0YS1zb3VyY2UtbGluZT0iMTYiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X0RhaWx5QmFsYW5jZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIxMjkuNDg0NCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTYzLjIwMzciIHg9Ijc1LjE1IiB5PSI3Ii8+PGVsbGlwc2UgY3g9Ijk4Ljc5MTkiIGN5PSIyMyIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMTAyLjkwMTIsMjkgTDk1LjE4MjUsMjkgTDk1LjE4MjUsMTYuNjA5NCBMMTAyLjkwMTIsMTYuNjA5NCBMMTAyLjkwMTIsMTguNzY1NiBMOTcuNjM1NiwxOC43NjU2IEw5Ny42MzU2LDIxLjQzNzUgTDEwMi40MDEyLDIxLjQzNzUgTDEwMi40MDEyLDIzLjU5MzggTDk3LjYzNTYsMjMuNTkzOCBMOTcuNjM1NiwyNi44NDM4IEwxMDIuOTAxMiwyNi44NDM4IEwxMDIuOTAxMiwyOSBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxMTQuNzEyMyIgeT0iMjcuODQ2NyI+JiMyNjA4NTsmIzI3NDI1OyYjMjEyMDg7JiMyMzQ1MDsmIzMxMTg1OyYjMzA0NDY7JiMyNzUzMTsmIzM5NjQwOzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3Ni4xNSIgeDI9IjIzNy4zNTM3IiB5MT0iMzkiIHkyPSIzOSIvPjxlbGxpcHNlIGN4PSI4Ni4xNSIgY3k9IjUyLjY0ODQiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS45OTk4IiB4PSI5NS4xNSIgeT0iNTUuOTk1MSI+JiMzNjIxNTsmIzMxMDgwOyYjMjYwODU7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM0Ljc1MzkiIHg9IjE0MS42IiB5PSI1NS45OTUxIj4mIzE3MTtQSyYjMTg3OzwvdGV4dD48ZWxsaXBzZSBjeD0iODYuMTUiIGN5PSI2OC45NDUzIiBmaWxsPSIjMDAwMDAwIiByeD0iMyIgcnk9IjMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iOTUuMTUiIHk9IjcyLjI5MiI+JiMyMTIwODsmIzIzNDUwOyYjMzExODU7JiMzMDQ0NjsmIzEyNDY3OyYjMTI1NDA7JiMxMjQ4OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzQuNzUzOSIgeD0iMTk3LjU5OTgiIHk9IjcyLjI5MiI+JiMxNzE7UEsmIzE4Nzs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMuMzUwNiIgeD0iOTUuMTUiIHk9Ijg4LjU4ODkiPi4uLjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNzYuMTUiIHgyPSIyMzcuMzUzNyIgeTE9Ijk1Ljg5MDYiIHkyPSI5NS44OTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iODEuMTUiIHk9IjExMi44ODU3Ij4mIzIwNTExOyYjMjYwNDE7JiMzNzMyOTsmIzM4OTg5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI4MS4xNSIgeT0iMTI5LjE4MjYiPiYjMzYwMjQ7JiMyNjA0MTsmIzM3MzI5OyYjMzg5ODk7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01ONSIgZGF0YS1zb3VyY2UtbGluZT0iMjgiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X0dNTjUiPjxwYXRoIGQ9Ik0zNDEuNjIsMjkxLjg1IEwzNDEuNjIsMzIzLjEyIEwzMDYuODcsMzI3LjEyIEwzNDEuNjIsMzMxLjEyIEwzNDEuNjIsMzYyLjM4MTMgQTAsMCAwIDAgMCAzNDEuNjIsMzYyLjM4MTMgTDYyMS44OTAzLDM2Mi4zODEzIEEwLDAgMCAwIDAgNjIxLjg5MDMsMzYyLjM4MTMgTDYyMS44OTAzLDMwMS44NSBMNjExLjg5MDMsMjkxLjg1IEwzNDEuNjIsMjkxLjg1IEEwLDAgMCAwIDAgMzQxLjYyLDI5MS44NSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTYxMS44OTAzLDI5MS44NSBMNjExLjg5MDMsMzAxLjg1IEw2MjEuODkwMywzMDEuODUgTDYxMS44OTAzLDI5MS44NSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY5LjAwMDIiIHg9IjM0Ny42MiIgeT0iMzA4LjkxNjkiPiYjMjc3NzA7JiMzMTYzOTsmIzI2Mzk5OyYjMTI1Mzk7JiMyNjM3NjsmIzI0MjMwOyYjMTIzOTU7JiMxMjQyNDsmIzEyNDI3OyYjMjYzOTk7JiMzODI5MTsmIzMxNjQ5OyYjMjk3MDI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4Mi4wMDAyIiB4PSIzNDcuNjIiIHk9IjMyNC4wNDk3Ij4mIzI2Mzc2OyYjMjEwMjE7JiMyNzUzMTsmIzM5NjQwOyYjMTIzOTk7JiMyMTA2OTsmIzI2Mzc2OyYjMjY0MTE7JiMyNzUzMTsmIzM5NjQwOyYjMTIzNjM7JiMxMjQyNTsmIzMyMzY4OyYjMzYyMzQ7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI1OS4yNzAzIiB4PSIzNDcuNjIiIHk9IjMzOS4xODI1Ij4mIzI2Mzc2OyYjMjY0MTE7JiMyNzUzMTsmIzM5NjQwOyA9ICYjMjYzNzY7JiMyMTAyMTsmIzI3NTMxOyYjMzk2NDA7ICsgJiMyMDUxMTsmIzI2MDQxOyYjMzczMjk7JiMzODk4OTsgLSAmIzM2MDI0OyYjMjYwNDE7JiMzNzMyOTsmIzM4OTg5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDEuMTQzNyIgeD0iMzQ3LjYyIiB5PSIzNTQuMzE1MyI+KCYjMjA1MTE7JiMyNjA0MTsmIzIxMjA4OyYjMjM0NTA7JiMxMjM5ODsmIzIyNTgwOyYjMjE1MTI7KTwvdGV4dD48L2c+PCEtLWxpbmsgRGFpbHlCYWxhbmNlIHRvIE1vbnRobHlCYWxhbmNlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRhaWx5QmFsYW5jZSIgZGF0YS1lbnRpdHktMj0iTW9udGhseUJhbGFuY2UiIGRhdGEtc291cmNlLWxpbmU9IjI1IiBkYXRhLXVpZD0ibG5rNCIgaWQ9ImxpbmtfRGFpbHlCYWxhbmNlX01vbnRobHlCYWxhbmNlIj48cGF0aCBjb2RlTGluZT0iMjUiIGQ9Ik0xNTYuNzUsMTM2LjY4IEMxNTYuNzUsMTU5Ljk5IDE1Ni43NSwxODEuMDkgMTU2Ljc1LDIwNy4zOCIgZmlsbD0ibm9uZSIgaWQ9IkRhaWx5QmFsYW5jZS10by1Nb250aGx5QmFsYW5jZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTU2Ljc1LDIxMy4zOCwxNjAuNzUsMjA0LjM4LDE1Ni43NSwyMDguMzgsMTUyLjc1LDIwNC4zOCwxNTYuNzUsMjEzLjM4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIuMDAwMSIgeD0iMTU3Ljc1IiB5PSIxNzkuNTQ2OSI+JiMyNjM3NjsmIzI2NDExOyYjMzg1OTg7JiMzNTMzNjs8L3RleHQ+PC9nPjwhLS1TUkM9W1pQOVBJbTlYNThSbGxyem53NGVkN0xmbG4wR3BNc1dYQkJnTmlYOTRlVVA2OGlXUGczNDlhZDJYOWFnWUNnbmZOLXRWZDZSeDV5dG1QTm5BWXJTM3lwdmRwaHBsVXM5OThJd2FlS0ROUEZzb2VrTkFjaGZsZEVVRDByTE5TclFqdDA3SExQWEM5T05iSDdlbWNlV2N2c0VtSFpaV0VGdHNwTDFCa2RCNFNKdU9jdmVEWnVHWnVGVEZabVMyTDVUYXhVdEM0TVNjV25DSkRpNmd4Mk9LeHI1d0hvZGhtN0YxSTZXcTY3N3JreHptLXA3U2MzOUY1NnR4dWUtZnhZdXRreU1JZ2JQbmVfdGxlckgyd0doNTVuSkZLUm42SU12ZDJxdFllcnVtZ3BQU0dFYTJuUGtWWjdrenR5ZDhYcEhWMW5pQVh5UGlxak5Udy1ib3F0R3NabEpZZ3hNTGpvZXhKS0lWZnVTSXZqdEJGdUpKZzVCeFJTaXc4UjU2elFOSnR3aVZZaVBSWXBTVmR1dEpnWnQ1U01xcXNhMXVkZFZ5aXl1OFF5QnZld1BiRjF6ZUZKbVZLNUZNbVFQUGJHYjlmZUdPaENJTmJXTDhCUlIwdkZpLUtRaEpNeUhDM0tNeHFQcHpxWWhrNk1oNXNEcWFSMWtPa1RRb0Vzbm9jQ2NYYzNMVVJ5b2RSUzhBQzAzaTk3RzJRbXN5cTZKRUhLTVE0TVBLeFZYMXN2TlRUV1NCdUJadTEwMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<hr />
<h2 id="187-jpa">18.7 月次残高の JPA エンティティ<a class="headerlink" href="#187-jpa" title="Permanent link">&para;</a></h2>
<h3 id="_6">複合主キークラス<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<details>
<summary>MonthlyAccountBalanceId.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Column</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Embeddable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Objects</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 月次勘定科目残高の複合主キー</span>
<span class="cm"> */</span>
<span class="nd">@Embeddable</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MonthlyAccountBalanceId</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;決算期&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">fiscalYear</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;月度&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">month</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;補助科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">departmentCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;プロジェクトコード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">projectCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;決算仕訳フラグ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">closingJournalFlag</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">equals</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getClass</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">getClass</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">MonthlyAccountBalanceId</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MonthlyAccountBalanceId</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">fiscalYear</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">month</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">accountCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">subAccountCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">departmentCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">departmentCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">projectCode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">closingJournalFlag</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="na">closingJournalFlag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">hash</span><span class="p">(</span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">subAccountCode</span><span class="p">,</span>
<span class="w">                           </span><span class="n">departmentCode</span><span class="p">,</span><span class="w"> </span><span class="n">projectCode</span><span class="p">,</span><span class="w"> </span><span class="n">closingJournalFlag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="entity_1">月次勘定科目残高 Entity<a class="headerlink" href="#entity_1" title="Permanent link">&para;</a></h3>
<details>
<summary>MonthlyAccountBalance.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.department.Department</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 月次勘定科目残高 Entity</span>
<span class="cm"> */</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;月次勘定科目残高&quot;</span><span class="p">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MonthlyAccountBalance</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@EmbeddedId</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MonthlyAccountBalanceId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@ManyToOne</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">referencedColumnName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コード&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@ManyToOne</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">referencedColumnName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;部門コード&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="n">department</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;月初残高&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">openingBalance</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;借方金額&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitAmount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;貸方金額&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditAmount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;月末残高&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">closingBalance</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;作成日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;更新日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">updatedAt</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 月末残高を計算する</span>
<span class="cm">     * @param isDebitAccount 借方勘定かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateClosingBalance</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isDebitAccount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDebitAccount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 借方勘定：月初 + 借方 - 貸方</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">closingBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openingBalance</span>
<span class="w">                </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">debitAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">creditAmount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 貸方勘定：月初 + 貸方 - 借方</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">closingBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openingBalance</span>
<span class="w">                </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">creditAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">debitAmount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PrePersist</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">initializeDefaults</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PreUpdate</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onUpdate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeDefaults</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">openingBalance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">openingBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">debitAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">creditAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">closingBalance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">closingBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="projection_1">合計残高試算表行用 Projection<a class="headerlink" href="#projection_1" title="Permanent link">&para;</a></h3>
<details>
<summary>TrialBalanceLineProjection.java と TrialBalanceLine.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 合計残高試算表行の Projection インターフェース</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">TrialBalanceLineProjection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="nf">getFiscalYear</span><span class="p">();</span>
<span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="nf">getMonth</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getAccountCode</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getAccountName</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getBsplType</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getDebitCreditType</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getOpeningBalance</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getDebitTotal</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getCreditTotal</span><span class="p">();</span>
<span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getClosingBalance</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.balance</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 合計残高試算表行 DTO</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TrialBalanceLine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">fiscalYear</span><span class="p">;</span><span class="w">           </span><span class="c1">// 決算期</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">month</span><span class="p">;</span><span class="w">                </span><span class="c1">// 月度</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span><span class="w">           </span><span class="c1">// 勘定科目コード</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span><span class="w">           </span><span class="c1">// 勘定科目名</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">;</span><span class="w">              </span><span class="c1">// BSPL区分</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">;</span><span class="w">       </span><span class="c1">// 貸借区分</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">openingBalance</span><span class="p">;</span><span class="w">    </span><span class="c1">// 月初残高</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitTotal</span><span class="p">;</span><span class="w">        </span><span class="c1">// 借方合計</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditTotal</span><span class="p">;</span><span class="w">       </span><span class="c1">// 貸方合計</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">closingBalance</span><span class="p">;</span><span class="w">    </span><span class="c1">// 月末残高</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Projection から DTO を生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">TrialBalanceLine</span><span class="w"> </span><span class="nf">fromProjection</span><span class="p">(</span><span class="n">TrialBalanceLineProjection</span><span class="w"> </span><span class="n">projection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TrialBalanceLine</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">fiscalYear</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getFiscalYear</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">month</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getMonth</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">accountName</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">bsplType</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getBsplType</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">debitCreditType</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">openingBalance</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getOpeningBalance</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">debitTotal</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getDebitTotal</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">creditTotal</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getCreditTotal</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">closingBalance</span><span class="p">(</span><span class="n">projection</span><span class="p">.</span><span class="na">getClosingBalance</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="188">18.8 残高更新サービスの実装<a class="headerlink" href="#188" title="Permanent link">&para;</a></h2>
<details>
<summary>BalanceUpdateService.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.service</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.DailyAccountBalanceRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.MonthlyAccountBalanceRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.DebitCreditType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.Journal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.JournalDebitCreditDetail</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 残高更新サービス</span>
<span class="cm"> *</span>
<span class="cm"> * 仕訳登録時の残高更新を担当</span>
<span class="cm"> * JPA 版でもビジネスロジックは MyBatis 版と同じ</span>
<span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BalanceUpdateService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DailyAccountBalanceRepository</span><span class="w"> </span><span class="n">dailyBalanceRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MonthlyAccountBalanceRepository</span><span class="w"> </span><span class="n">monthlyBalanceRepository</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳登録に伴う残高更新</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateBalancesForJournal</span><span class="p">(</span><span class="n">Journal</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">postingDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getPostingDate</span><span class="p">();</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">closingFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getClosingEntryFlag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getClosingEntryFlag</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 仕訳の各明細について残高を更新</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getDetails</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">dcDetail</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">detail</span><span class="p">.</span><span class="na">getDebitCreditDetails</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">updateDailyBalance</span><span class="p">(</span><span class="n">postingDate</span><span class="p">,</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">,</span><span class="w"> </span><span class="n">closingFlag</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;残高更新完了: 仕訳伝票番号={}, 起票日={}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">(),</span><span class="w"> </span><span class="n">postingDate</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 日次残高の更新</span>
<span class="cm">     * JPA 版では upsert メソッドで Native Query を使用</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateDailyBalance</span><span class="p">(</span><span class="n">LocalDate</span><span class="w"> </span><span class="n">postingDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">JournalDebitCreditDetail</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">closingFlag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">debitAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DebitCreditType</span><span class="p">.</span><span class="na">DEBIT</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getAmount</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">creditAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DebitCreditType</span><span class="p">.</span><span class="na">CREDIT</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getAmount</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>

<span class="w">        </span><span class="n">dailyBalanceRepository</span><span class="p">.</span><span class="na">upsert</span><span class="p">(</span>
<span class="w">            </span><span class="n">postingDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">            </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getSubAccountCode</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getSubAccountCode</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDepartmentCode</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDepartmentCode</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;00000&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getProjectCode</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getProjectCode</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">closingFlag</span><span class="p">,</span>
<span class="w">            </span><span class="n">debitAmount</span><span class="p">,</span>
<span class="w">            </span><span class="n">creditAmount</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 月次残高の集計</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">aggregateMonthlyBalance</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">fromDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">toDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fromDate</span><span class="p">.</span><span class="na">withDayOfMonth</span><span class="p">(</span><span class="n">fromDate</span><span class="p">.</span><span class="na">lengthOfMonth</span><span class="p">());</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monthlyBalanceRepository</span><span class="p">.</span><span class="na">aggregateFromDaily</span><span class="p">(</span>
<span class="w">            </span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">fromDate</span><span class="p">,</span><span class="w"> </span><span class="n">toDate</span><span class="p">);</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;月次残高集計完了: 決算期={}, 月度={}, 件数={}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 月次残高の繰越処理</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">carryForwardMonthlyBalance</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fromMonth</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">toMonth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monthlyBalanceRepository</span><span class="p">.</span><span class="na">carryForward</span><span class="p">(</span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">fromMonth</span><span class="p">,</span><span class="w"> </span><span class="n">toMonth</span><span class="p">);</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;月次残高繰越完了: 決算期={}, {}月 → {}月, 件数={}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">fiscalYear</span><span class="p">,</span><span class="w"> </span><span class="n">fromMonth</span><span class="p">,</span><span class="w"> </span><span class="n">toMonth</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="189">18.9 まとめ：設計のポイント<a class="headerlink" href="#189" title="Permanent link">&para;</a></h2>
<h3 id="_7">複合主キーによる多次元管理<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>日次残高</strong>：起票日 + 勘定科目 + 補助科目 + 部門 + プロジェクト + 決算仕訳フラグ</li>
<li><strong>月次残高</strong>：決算期 + 月度 + 勘定科目 + 補助科目 + 部門 + プロジェクト + 決算仕訳フラグ</li>
<li>JPA では @EmbeddedId + @Embeddable で複合主キーを表現</li>
</ol>
<h3 id="upsert">UPSERT による効率的な残高更新<a class="headerlink" href="#upsert" title="Permanent link">&para;</a></h3>
<ul>
<li>PostgreSQL の <code>INSERT ON CONFLICT DO UPDATE</code> を使用</li>
<li>JPA では @Query + nativeQuery で Native SQL を実行</li>
<li>既存レコードがあれば金額を加算、なければ新規挿入</li>
</ul>
<h3 id="projection_2">Projection による集計結果のマッピング<a class="headerlink" href="#projection_2" title="Permanent link">&para;</a></h3>
<ul>
<li>Native Query の結果を Projection インターフェースで受け取り</li>
<li>Projection から DTO への変換メソッドを用意</li>
<li>型安全な集計結果の取り扱いが可能</li>
</ul>
<h3 id="mybatis">MyBatis 版との比較<a class="headerlink" href="#mybatis" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>MyBatis 版</th>
<th>JPA 版</th>
</tr>
</thead>
<tbody>
<tr>
<td>複合主キー</td>
<td>Key 内部クラス</td>
<td>@EmbeddedId + @Embeddable</td>
</tr>
<tr>
<td>集計結果マッピング</td>
<td>resultMap + DTO</td>
<td>Projection インターフェース</td>
</tr>
<tr>
<td>UPSERT</td>
<td>XML で INSERT ON CONFLICT</td>
<td>@Query + nativeQuery</td>
</tr>
<tr>
<td>テスト</td>
<td>@MybatisTest</td>
<td>@DataJpaTest</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_8">次章予告<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p><a href="../chapter19-orm/">第19章</a>では、赤黒処理によるデータ訂正方式と、JPA Auditing を使用したログ管理の設計について解説します。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works/practical-database-design" target="_blank" rel="noopener" title="GitHub Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>