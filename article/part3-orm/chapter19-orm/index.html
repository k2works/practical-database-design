
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="基幹業務システム（販売管理・財務会計・生産管理）のデータベース設計を体系的に解説">
      
      
        <meta name="author" content="k2works">
      
      
      
        <link rel="prev" href="../chapter18-orm/">
      
      
        <link rel="next" href="../chapter20-orm/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>第19章 赤黒とログの設計【ORM版】 - 実践データベース設計：基幹業務システム編</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#19orm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="実践データベース設計：基幹業務システム編" class="md-header__button md-logo" aria-label="実践データベース設計：基幹業務システム編" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            実践データベース設計：基幹業務システム編
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第19章 赤黒とログの設計【ORM版】
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/practical-database-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    practical-database-design
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  実践データベース設計

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="実践データベース設計：基幹業務システム編" class="md-nav__button md-logo" aria-label="実践データベース設計：基幹業務システム編" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    実践データベース設計：基幹業務システム編
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/practical-database-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    practical-database-design
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    実践データベース設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    実践データベース設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../techstack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技術スタック
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../outline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    アウトライン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    執筆ワークフロー
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project-setup-instruction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクトセットアップ手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_7" >
        
          
          <label class="md-nav__link" for="__nav_1_7" id="__nav_1_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    デプロイ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    デプロイ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy-sms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SMS デモデプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy-fas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAS デモデプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy-pms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PMS デモデプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_8" >
        
          
          <label class="md-nav__link" for="__nav_1_8" id="__nav_1_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第1部 基幹業務システムの全体像
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    第1部 基幹業務システムの全体像
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章 基幹業務システムとは
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章 基幹業務システムの業務領域
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章 業務フローの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_9" >
        
          
          <label class="md-nav__link" for="__nav_1_9" id="__nav_1_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第2部 販売管理システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    第2部 販売管理システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章 販売管理システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章 マスタ情報の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章 受注・出荷・売上の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章 債権管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章 調達管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章 在庫管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章 債務管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章 共通処理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章 販売管理データ設計（B社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_10" >
        
          
          <label class="md-nav__link" for="__nav_1_10" id="__nav_1_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第3部 財務会計システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    第3部 財務会計システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章 財務会計システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章 勘定科目の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章 仕訳の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章 自動仕訳の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章 勘定科目残高の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章 赤黒とログの設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章 財務会計データ設計（D社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_11" >
        
          
          <label class="md-nav__link" for="__nav_1_11" id="__nav_1_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第4部 生産管理システム
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    第4部 生産管理システム
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章 生産管理システムの全体像
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章 マスタ情報の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章 生産計画の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第25章 購買管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第26章 外注委託管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第27章 工程管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第28章 在庫管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第29章 品質管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第30章 製造原価管理の設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第31章 生産管理データ設計（E社事例）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/chapter32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第32章 APIサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_12" >
        
          
          <label class="md-nav__link" for="__nav_1_12" id="__nav_1_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第5部 エンタープライズインテグレーション
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    第5部 エンタープライズインテグレーション
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter33.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第33章 システム統合の概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter34.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第34章 メッセージングパターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter35.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第35章 システム間連携パターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter36.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第36章 マスタデータ管理（MDM）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter37.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第37章 イベント駆動アーキテクチャ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter38.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第38章 API設計とサービス連携
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/chapter39.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第39章 データ連携の実装パターン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_13" >
        
          
          <label class="md-nav__link" for="__nav_1_13" id="__nav_1_13_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 販売管理システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 販売管理システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study2-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究5 AxonCQRS/ESの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_14" >
        
          
          <label class="md-nav__link" for="__nav_1_14" id="__nav_1_14_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 財務会計システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 財務会計システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study3-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究5 AxonCQRS/ESの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_15" >
        
          
          <label class="md-nav__link" for="__nav_1_15" id="__nav_1_15_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 生産管理システム実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_15">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 生産管理システム実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究1 モノリスサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究2 JavaFXデスクトップアプリケーションの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究3 gRPCサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究4 GraphQLサービスの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../study/study4-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    研究5 AxonCQRS/ESの実装
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_16" checked>
        
          
          <label class="md-nav__link" for="__nav_1_16" id="__nav_1_16_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    研究 財務会計システムORM実装編
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_16_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_16">
            <span class="md-nav__icon md-icon"></span>
            
  
    研究 財務会計システムORM実装編
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章 財務会計システムの全体像【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章 勘定科目の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章 仕訳の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章 自動仕訳の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章 勘定科目残高の設計【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第19章 赤黒とログの設計【ORM版】
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章 赤黒とログの設計【ORM版】
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#191" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.1 赤黒処理の概念
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.1 赤黒処理の概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        赤黒処理とは
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        赤黒処理のメリット
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#192" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.2 赤黒処理のテーブル設計
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#193-mybatis" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.3 MyBatis 版との実装比較
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.3 MyBatis 版との実装比較">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        データアクセス層の比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#194" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.4 赤黒処理サービスの実装
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#195" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.5 ログ管理方式の選択
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.5 ログ管理方式の選択">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        推奨される組み合わせ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#196-jpa-auditing" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6 JPA Auditing による自動タイムスタンプ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.6 JPA Auditing による自動タイムスタンプ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auditing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auditing 設定
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditoraware" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuditorAware 実装（操作者の自動設定）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entity" class="md-nav__link">
    <span class="md-ellipsis">
      
        監査情報を持つ基底 Entity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#197" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.7 マスタ変更ログテーブルの設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.7 マスタ変更ログテーブルの設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flyway" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flyway マイグレーション
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entity_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        変更ログ Entity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enum-converter" class="md-nav__link">
    <span class="md-ellipsis">
      
        操作種別 Enum と Converter
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#198-entitylistener" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.8 EntityListener によるマスタ変更ログの自動記録
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.8 EntityListener によるマスタ変更ログの自動記録">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entitylistener-entity" class="md-nav__link">
    <span class="md-ellipsis">
      
        EntityListener を使用する Entity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#199" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.9 変更ログリポジトリの実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.9 変更ログリポジトリの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jparepository-specification" class="md-nav__link">
    <span class="md-ellipsis">
      
        JpaRepository と Specification
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Specification による動的クエリ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1910" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.10 変更ログリポジトリのテスト
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1911" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.11 まとめ：設計のポイント
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.11 まとめ：設計のポイント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        赤黒処理によるデータ訂正
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        ログ管理方式の使い分け
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jpa-auditing" class="md-nav__link">
    <span class="md-ellipsis">
      
        JPA Auditing による自動化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mybatis" class="md-nav__link">
    <span class="md-ellipsis">
      
        MyBatis 版との比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        次章予告
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章 財務会計データ設計（D社事例）【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章 APIサービスの実装【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22-orm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章 Axon CQRS/ESの実装【ORM版】
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_17" >
        
          
          <label class="md-nav__link" for="__nav_1_17" id="__nav_1_17_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    付録
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_17">
            <span class="md-nav__icon md-icon"></span>
            
  
    付録
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/er-diagrams.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    A 全体ER図
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/table-definitions.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    B テーブル定義一覧
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/glossary.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C 用語集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_18" >
        
          
          <label class="md-nav__link" for="__nav_1_18" id="__nav_1_18_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    データベース
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_18">
            <span class="md-nav__icon md-icon"></span>
            
  
    データベース
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../assets/schemaspy-output/sms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SchemaSpy ER図（SMS）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../assets/schemaspy-output/fas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SchemaSpy ER図（FAS）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../assets/schemaspy-output/pms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SchemaSpy ER図（PMS）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="19orm">第19章：赤黒とログの設計（ORM版）<a class="headerlink" href="#19orm" title="Permanent link">&para;</a></h1>
<p>会計システムにおけるデータ訂正方式（赤黒処理）とログ管理の設計を行います。</p>
<p>JPA 版では、@EntityListeners と AuditingEntityListener を使用した監査証跡の実装を行います。</p>
<hr />
<h2 id="191">19.1 赤黒処理の概念<a class="headerlink" href="#191" title="Permanent link">&para;</a></h2>
<p>会計システムでは、一度登録したデータの「削除」や「更新」を安易に行うことはできません。監査証跡を確保しつつ、データ訂正を行う方式が必要です。</p>
<h3 id="_1">赤黒処理とは<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>赤黒処理とは、誤った仕訳を訂正する際に、元の仕訳を「赤伝（取消伝票）」で打ち消し、正しい仕訳を「黒伝（訂正伝票）」として新規登録する方式です。</p>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjY3NHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDU3cHg7aGVpZ2h0OjY3NHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDQ1NyA2NzQiIHdpZHRoPSI0NTdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMzYxOTY7JiM0MDY1ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzI3OTY5OyYjMTI0Mjg7PC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMTcyLjc1MDMiIHk9IjIyLjk5NTEiPiYjMzYxOTY7JiM0MDY1ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzI3OTY5OyYjMTI0Mjg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBvcmlnaW5hbC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJvcmlnaW5hbCIgZGF0YS1zb3VyY2UtbGluZT0iMyIgaWQ9ImVudDAwMDIiPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMTIxLjg5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjM0IiB4PSIyOC41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9Ijk2LjUwMDIiIHk9IjU5LjI5MiI+JiMyMDgwMzsmIzIwMjUzOyYjMzEwODA7JiM2NTI4ODsmIzM1NDkyOyYjMTI0MjY7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHJlZC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJyZWQiIGRhdGEtc291cmNlLWxpbmU9IjciIGlkPSJlbnQwMDA0Ij48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjEzOC4xOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIzNCIgeD0iMjguNSIgeT0iMjMxLjE4NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMTAzLjUwMDIiIHk9IjI0Ni4xODIiPiYjMzYxOTY7JiMyMDI1MzsmIzY1Mjg4OyYjMjE0NjI7JiMyODA0MDsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgYmxhY2stLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iYmxhY2siIGRhdGEtc291cmNlLWxpbmU9IjExIiBpZD0iZW50MDAwNiI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIxMzguMTgiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMzQiIHg9IjE1NS41IiB5PSI0MzQuMzc2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyMzAuNTAwMiIgeT0iNDQ5LjM3MiI+JiM0MDY1ODsmIzIwMjUzOyYjNjUyODg7JiMzNTMzMDsmIzI3NDkxOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IGoxLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0ib3JpZ2luYWwuajEiIGRhdGEtc291cmNlLWxpbmU9IjQiIGlkPSJlbnQwMDAzIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjU0Ljg5MDYiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2Ni4zNDM0IiB4PSI1Mi4zMyIgeT0iODcuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC45MjQ2IiB4PSI2Mi4zMyIgeT0iMTAzLjI5MiI+JiMyMDE4MTsmIzM1Mzc5OyYjMzAwNTg7JiMyMTQ5NTs6IEowMDAxPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ni4zNDM0IiB4PSI2Mi4zMyIgeT0iMTE5LjU4ODkiPiYjMTIzMDQ7JiMyMDUxMTsmIzI2MDQxOyYjMTIzMDU7JiMyOTY5NDsmIzM3MzI5OyAxMDAsMDAwPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ni4zNDM0IiB4PSI2Mi4zMyIgeT0iMTM1Ljg4NTciPiYjMTIzMDQ7JiMzNjAyNDsmIzI2MDQxOyYjMTIzMDU7JiMyMjc3MDsmIzE5OTc4OyAxMDAsMDAwPC90ZXh0PjwvZz48IS0tZW50aXR5IGoyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0icmVkLmoyIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBpZD0iZW50MDAwNSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI3MS4xODc1IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNjYuMzQzNCIgeD0iNTIuMzMiIHk9IjI3NC4xODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE0LjY1MjEiIHg9IjYyLjMzIiB5PSIyOTAuMTgyIj4mIzIwMTgxOyYjMzUzNzk7JiMzMDA1ODsmIzIxNDk1OzogSjAwMDFSPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ni4zNDM0IiB4PSI2Mi4zMyIgeT0iMzA2LjQ3ODkiPiYjMTIzMDQ7JiMyMDUxMTsmIzI2MDQxOyYjMTIzMDU7JiMyMjc3MDsmIzE5OTc4OyAxMDAsMDAwPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ni4zNDM0IiB4PSI2Mi4zMyIgeT0iMzIyLjc3NTciPiYjMTIzMDQ7JiMzNjAyNDsmIzI2MDQxOyYjMTIzMDU7JiMyOTY5NDsmIzM3MzI5OyAxMDAsMDAwPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjczMDIiIHg9IjYyLjMzIiB5PSIzMzkuMDcyNiI+JiM4MjUxOyYjMzYwMjQ7JiMyMDUxMTsmIzEyNDM0OyYjMjE0NTM7JiMzNjU3ODs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgajMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLXF1YWxpZmllZC1uYW1lPSJibGFjay5qMyIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGlkPSJlbnQwMDA3Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjcxLjE4NzUiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2Ni4zNDM0IiB4PSIxNzkuMzMiIHk9IjQ3Ny4zNzY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjkyNDYiIHg9IjE4OS4zMyIgeT0iNDkzLjM3MiI+JiMyMDE4MTsmIzM1Mzc5OyYjMzAwNTg7JiMyMTQ5NTs6IEowMDAyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ni4zNDM0IiB4PSIxODkuMzMiIHk9IjUwOS42Njg5Ij4mIzEyMzA0OyYjMjA1MTE7JiMyNjA0MTsmIzEyMzA1OyYjMjk2OTQ7JiMzNzMyOTsgMTIwLDAwMDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDYuMzQzNCIgeD0iMTg5LjMzIiB5PSI1MjUuOTY1NyI+JiMxMjMwNDsmIzM2MDI0OyYjMjYwNDE7JiMxMjMwNTsmIzIyNzcwOyYjMTk5Nzg7IDEyMCwwMDA8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODEuNzMwMiIgeD0iMTg5LjMzIiB5PSI1NDIuMjYyNiI+JiM4MjUxOyYjMjc0OTE7JiMxMjM3NTsmIzEyMzU2OyYjMzczMjk7JiMzODk4OTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9IkdNTjEwIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgaWQ9ImVudDAwMTEiPjxwYXRoIGQ9Ik02LDQ3Ny42OTY5IEw2LDU0OC4yMjgxIEwxMzEuMDAwMSw1NDguMjI4MSBMMTMxLjAwMDEsNDg3LjY5NjkgTDEyMS4wMDAxLDQ3Ny42OTY5IEw2LDQ3Ny42OTY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTIxLjAwMDEsNDc3LjY5NjkgTDEyMS4wMDAxLDQ4Ny42OTY5IEwxMzEuMDAwMSw0ODcuNjk2OSBMMTIxLjAwMDEsNDc3LjY5NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MS4wMDAxIiB4PSIxMiIgeT0iNDk0Ljc2MzgiPiYjMzYxOTY7JiMyMDI1MzsmIzEyMzk5OyYjMjA4MDM7JiMyMDI1MzsmIzMxMDgwOyYjMTIzOTg7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMiIgeT0iNTA5Ljg5NjYiPiYjMzYwMjQ7JiMyMDUxMTsmIzEyNDM0OyYjMjM0MzY7JiMyMDg0MDsmIzEyMzk1OyYjMjE0NTM7JiMzNjU3ODs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjEyIiB5PSI1MjUuMDI5NCI+JiMyMDE4MTsmIzM1Mzc5OyYjMzczMjk7JiMzODk4OTsmIzEyMzk4OyYjMjE1MTI7JiMzNTMzNjsmIzEyMzY0OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSIxMiIgeT0iNTQwLjE2MjIiPiYjMTI0NzY7JiMxMjUyNTsmIzEyMzk1OyYjMTIzOTQ7JiMxMjQyNzs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9IkdNTjEzIiBkYXRhLXNvdXJjZS1saW5lPSIyNiIgaWQ9ImVudDAwMTQiPjxwYXRoIGQ9Ik0zMTIuNSw2MjcuNTU2OSBMMzEyLjUsNjY3LjgyMjUgTDQ1MC41MDAxLDY2Ny44MjI1IEw0NTAuNTAwMSw2MzcuNTU2OSBMNDQwLjUwMDEsNjI3LjU1NjkgTDMxMi41LDYyNy41NTY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNDQwLjUwMDEsNjI3LjU1NjkgTDQ0MC41MDAxLDYzNy41NTY5IEw0NTAuNTAwMSw2MzcuNTU2OSBMNDQwLjUwMDEsNjI3LjU1NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuMDAwMSIgeD0iMzE4LjUiIHk9IjY0NC42MjM4Ij4mIzQwNjU4OyYjMjAyNTM7JiMxMjM5OTsmIzI3NDkxOyYjMTIzNzU7JiMxMjM1NjsmIzIwODY5OyYjMjM0ODE7JiMxMjM5MTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjMxOC41IiB5PSI2NTkuNzU2NiI+JiMyNjAzMjsmIzM1MjE1OyYjMTIzOTU7JiMyMDE4MTsmIzM1Mzc5OyYjMTI0MzQ7JiMzNjIxNTsmIzMxMDgwOzwvdGV4dD48L2c+PCEtLWxpbmsgb3JpZ2luYWwgdG8gcmVkLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImVudDAwMDIiIGRhdGEtZW50aXR5LTI9ImVudDAwMDQiIGRhdGEtbGluay10eXBlPSJkZXBlbmRlbmN5IiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgaWQ9ImxuazgiPjxwYXRoIGQ9Ik0yNTQuNSwxNjYuODI3MyBDMjU0LjUsMTY3LjE1NCAyNTQuNSwxNjcuNDgxNiAyNTQuNSwxNjcuODEgQzI1NC41LDE2OC40NjcgMjU0LjUsMTY5LjEyNzQgMjU0LjUsMTY5Ljc5MTIgQzI1NC41LDE3Mi40NDY0IDI1NC41LDE3NS4xNTUyIDI1NC41LDE3Ny45MDY3IEMyNTQuNSwxODguOTEzIDI1NC41LDIwMC42MDQ3IDI1NC41LDIxMi4yOTU2IEMyNTQuNSwyMTguMTQxMSAyNTQuNSwyMjMuOTg2NCAyNTQuNSwyMjkuNzQ1NyBDMjU0LjUsMjMwLjEwNTcgMjU0LjUsMjI0LjQ2NTMgMjU0LjUsMjI0LjgyNDYiIGZpbGw9Im5vbmUiIGlkPSJvcmlnaW5hbC10by1yZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1NC41LDIzMC44MjQ2LDI1OC41LDIyMS44MjQ2LDI1NC41LDIyNS44MjQ2LDI1MC41LDIyMS44MjQ2LDI1NC41LDIzMC44MjQ2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIuMDAwMSIgeD0iMjU1LjUiIHk9IjIwMy4yNTM4Ij4mIzM2MTk2OyYjMjAyNTM7JiMzMDMzMDsmIzM0ODkyOzwvdGV4dD48L2c+PCEtLWxpbmsgcmVkIHRvIGJsYWNrLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImVudDAwMDQiIGRhdGEtZW50aXR5LTI9ImVudDAwMDYiIGRhdGEtbGluay10eXBlPSJkZXBlbmRlbmN5IiBkYXRhLXNvdXJjZS1saW5lPSIxNiIgaWQ9ImxuazkiPjxwYXRoIGQ9Ik0yNjIuNTU2MSwzMTYuMjkwNyBDMjY0LjExMDUsMzE3LjM4ODYgMjY1Ljg1OTMsMzE4LjY0MSAyNjcuNzc0OCwzMjAuMDM5MiBDMjc1LjQzNzIsMzI1LjYzMjIgMjg1Ljc2OTQsMzMzLjU1ODggMjk3LjAxODgsMzQzLjI2MzEgQzMxOS41MTc1LDM2Mi42NzE5IDM0NS42ODUsMzg5LjE5MTkgMzYxLjUsNDE4LjM3NjkgQzM2My45NTM4LDQyMi45MDU2IDM2Ni4xMDY2LDQyNy43MSAzNjcuOTk1Myw0MzIuNjU2OCBDMzY4LjExMzQsNDMyLjk2NiAzNjguMjMwNCw0MzMuMjc1NyAzNjguMzQ2NCw0MzMuNTg2IEMzNjguNDA0NCw0MzMuNzQxMSAzNjYuMzgwMyw0MjguMjY5MiAzNjYuNDM3OCw0MjguNDI0NSIgZmlsbD0ibm9uZSIgaWQ9InJlZC10by1ibGFjayIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY4LjUxOTYsNDM0LjA1MTgsMzY5LjE0ODMsNDI0LjIyMywzNjYuNzg0Nyw0MjkuMzYyNCwzNjEuNjQ1Myw0MjYuOTk4OCwzNjguNTE5Niw0MzQuMDUxOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjM1Ni4yOCIgeT0iNDA2LjQ0MzgiPiYjNDA2NTg7JiMyMDI1MzsmIzMwMzMwOyYjMzQ4OTI7PC90ZXh0PjwvZz48IS0tbGluayByZWQgdG8gR01OMTAtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iZW50MDAwNCIgZGF0YS1lbnRpdHktMj0iZW50MDAxMSIgZGF0YS1saW5rLXR5cGU9ImFzc29jaWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgaWQ9ImxuazEyIj48cGF0aCBkPSJNMjQ0LjEzNjQsMzY5LjY1ODYgQzI0NC4wODIyLDM2OS43NzkzIDI0NC4wMjc4LDM2OS44OTk5IDI0My45NzMsMzcwLjAyMDMgQzI0My44NjM2LDM3MC4yNjExIDI0My43NTMsMzcwLjUwMTQgMjQzLjY0MTIsMzcwLjc0MTEgQzI0My40MTc4LDM3MS4yMjA1IDI0My4xODk4LDM3MS42OTc0IDI0Mi45NTcxLDM3Mi4xNzE4IEMyNDIuNDkxOSwzNzMuMTIwNiAyNDIuMDA4MSwzNzQuMDU5IDI0MS41MDUyLDM3NC45ODQ5IEMyMzkuNDkzMywzNzguNjg4OCAyMzcuMTczNywzODIuMTk0NCAyMzQuNSwzODUuMzc2OSBDMjEyLjExLDQxMi4wMTY5IDE5Mi4wOSwzOTguNTM2OSAxNjMuNSw0MTguMzc2OSBDMTM5LjM0LDQzNS4xMzY5IDExNS43Nyw0NTguMjk2OSA5OC4xNSw0NzcuMzg2OSIgZmlsbD0ibm9uZSIgaWQ9InJlZC1HTU4xMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjwvZz48IS0tbGluayBibGFjayB0byBHTU4xMy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlbnQwMDA2IiBkYXRhLWVudGl0eS0yPSJlbnQwMDE0IiBkYXRhLWxpbmstdHlwZT0iYXNzb2NpYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBpZD0ibG5rMTUiPjxwYXRoIGQ9Ik0zODEuNSw1NzIuNzkxMyBDMzgxLjUsNTczLjE3MzggMzgxLjUsNTczLjU1NjcgMzgxLjUsNTczLjkzOTggQzM4MS41LDU3NC43MDYxIDM4MS41LDU3NS40NzM2IDM4MS41LDU3Ni4yNDE4IEMzODEuNSw1ODIuMzg3MiAzODEuNSw1ODguNTc5NiAzODEuNSw1OTQuNjA3IEMzODEuNSw2MDYuNjYxOSAzODEuNSw2MTguMDU2OSAzODEuNSw2MjcuMDk2OSIgZmlsbD0ibm9uZSIgaWQ9ImJsYWNrLUdNTjEzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjw/cGxhbnR1bWwtc3JjIFZUQkZKeThtNTBWbVVfLUFYaENhT3p1dS0wVHV6RW5ibTJHZVJXZGtQYW9zOEp6NG84MDRaMFRaNDVJMjBHcTYwUlZ1bnJZd2JIRl9XY3pLOEEzWHNqVk56LWN0ckg5UUtpUGlxOWhRTFBmeHlpZlBPbEpTV0s3QzhhOGZFUWY5SVhtczE2V2NGTjdrbENWc3BDY3BKZWtPWFBicDVTM0k2TFBKWU5YMmFQQnU3NE1iTDBtNzlkUURqVC16TWVUUW1wM1U1bUdYVEFXR2xLcHJVeFMtOWRoNWl4d2NrR2VFMlM4RTVFU3JyWF9uNmN0czl3RjJlWk9WUzFuMjVzaU1xODg1OERJZ2tuX3YxSUdibnhPUDNqT0h3dUZNNFBsMFJ6czY2aEdJaXFnajRoQ1ZFNHBTVzQ2NjdDUlFmampqQmMySGYxR3pzSzhKX3V6N3QxQUZrOUIxODZCUzRFQ0ljZ1FENGZWai1oQmJvbUkzVV9EcW1mWDd2enItaWFPSC1Lai1ZVmwyY0ZEX1lxWEhESGI3TDRySkp4NXd2RlNadGFzQ3ItTGxXQy0yTGo3cVlaRzNJb3l5OHlIbG9iY21hUE9YYnBtblllWU8zYWJ0T0lDbkVpSXlIaDhJbV93dUZxRmRDaUhUQzdQdkxQaERxRHdPNkNfOGhSLW45bWtFdWlEMG1HUDNXMnRGXzA0MD8+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_2">赤黒処理のメリット<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>メリット</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査証跡の確保</td>
<td>元の仕訳が残り、訂正履歴が追跡可能</td>
</tr>
<tr>
<td>データ整合性</td>
<td>物理削除を行わないため、参照整合性が維持される</td>
</tr>
<tr>
<td>会計基準準拠</td>
<td>会計原則に則った正当な訂正方法</td>
</tr>
<tr>
<td>残高の自動調整</td>
<td>赤伝により残高が自動的に訂正される</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="192">19.2 赤黒処理のテーブル設計<a class="headerlink" href="#192" title="Permanent link">&para;</a></h2>
<p>仕訳テーブルには、赤黒処理に必要な項目が含まれています。</p>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjIwOHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NTIwcHg7aGVpZ2h0OjIwOHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDUyMCAyMDgiIHdpZHRoPSI1MjBweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbGFzcyBKb3VybmFsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iSm91cm5hbCIgZGF0YS1zb3VyY2UtbGluZT0iMSIgaWQ9ImVudDAwMDIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMTk0LjY3MTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI1NS41OTgzIiB4PSI3IiB5PSI3Ii8+PGVsbGlwc2UgY3g9IjExNi41NDkyIiBjeT0iMjMiIGZpbGw9IiNBREQxQjIiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTEyMC42NTg2LDI5IEwxMTIuOTM5OCwyOSBMMTEyLjkzOTgsMTYuNjA5NCBMMTIwLjY1ODYsMTYuNjA5NCBMMTIwLjY1ODYsMTguNzY1NiBMMTE1LjM5MjksMTguNzY1NiBMMTE1LjM5MjksMjEuNDM3NSBMMTIwLjE1ODYsMjEuNDM3NSBMMTIwLjE1ODYsMjMuNTkzOCBMMTE1LjM5MjksMjMuNTkzOCBMMTE1LjM5MjksMjYuODQzOCBMMTIwLjY1ODYsMjYuODQzOCBMMTIwLjY1ODYsMjkgWiAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy45OTk5IiB4PSIxMzcuMDQ5MiIgeT0iMjcuODQ2NyI+JiMyMDE4MTsmIzM1Mzc5OzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMjYxLjU5ODMiIHkxPSIzOSIgeTI9IjM5Ii8+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJJRV9NQU5EQVRPUlkiPjxlbGxpcHNlIGN4PSIxOCIgY3k9IjUyLjY0ODQiIGZpbGw9IiMwMDAwMDAiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMjciIHk9IjU1Ljk5NTEiPiYjMjAxODE7JiMzNTM3OTsmIzIwMjUzOyYjMzEwODA7JiMzMDA1ODsmIzIxNDk1OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDUuNTk4NiIgeD0iMTEwLjk5OTYiIHk9IjU1Ljk5NTEiPjogVkFSQ0hBUigxMCkgJiMxNzE7UEsmIzE4Nzs8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjgiIHgyPSIyNjEuNTk4MyIgeTE9IjYzLjI5NjkiIHkyPSI2My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEuOTk5OCIgeD0iMTMiIHk9IjgwLjI5MiI+JiMzNjIxNTsmIzMxMDgwOyYjMjYwODU7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxLjk5OTgiIHg9IjEzIiB5PSI5Ni41ODg5Ij4mIzIwODM3OyYjMjExNDc7JiMyNjA4NTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMTMiIHk9IjExMi44ODU3Ij4mIzIwMTgxOyYjMzUzNzk7JiMyMDI1MzsmIzMxMDgwOyYjMjEzMDY7JiMyMDk5ODs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMuMzUwNiIgeD0iMTMiIHk9IjEyOS4xODI2Ij4uLi48L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjEzIiB5PSIxNDUuNDc5NSI+JiMzNjE5NjsmIzIwMjUzOyYjMTI1MDE7JiMxMjUyMTsmIzEyNDY0OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3OC40NjI5IiB4PSI4Mi45OTk3IiB5PSIxNDUuNDc5NSI+OiBTTUFMTElOVDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMTMiIHk9IjE2MS43NzY0Ij4mIzM2MTk2OyYjNDA2NTg7JiMyMDI1MzsmIzMxMDgwOyYjMzAwNTg7JiMyMTQ5NTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzAuNTg3OSIgeD0iOTYuOTk5NiIgeT0iMTYxLjc3NjQiPjogSU5URUdFUjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIxMyIgeT0iMTc4LjA3MzIiPiYjMjAzMTY7JiMyNTEwNDsmIzI2MDg1OyYjMjYxNzg7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjEzIiB5PSIxOTQuMzcwMSI+JiMyNjM1NjsmIzI2MDMyOyYjMjYwODU7JiMyNjE3ODs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9IkdNTjMiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBpZD0iZW50MDAwNCI+PHBhdGggZD0iTTI5Ny44LDQ2LjM3IEwyOTcuOCwxMDAuMzMgTDI2Mi44OSwxMDQuMzMgTDI5Ny44LDEwOC4zMyBMMjk3LjgsMTYyLjI5OTcgQTAsMCAwIDAgMCAyOTcuOCwxNjIuMjk5NyBMNTEzLjgwMDIsMTYyLjI5OTcgQTAsMCAwIDAgMCA1MTMuODAwMiwxNjIuMjk5NyBMNTEzLjgwMDIsNTYuMzcgTDUwMy44MDAyLDQ2LjM3IEwyOTcuOCw0Ni4zNyBBMCwwIDAgMCAwIDI5Ny44LDQ2LjM3IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNTAzLjgwMDIsNDYuMzcgTDUwMy44MDAyLDU2LjM3IEw1MTMuODAwMiw1Ni4zNyBMNTAzLjgwMDIsNDYuMzciIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5LjM4IiB4PSIzMDMuOCIgeT0iNjMuNDM2OSI+JiMzNjE5NjsmIzIwMjUzOyYjMTI1MDE7JiMxMjUyMTsmIzEyNDY0Ozo8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA1LjQyODMiIHg9IjMwMy44IiB5PSI3OC41Njk3Ij4wID0gJiMzNjg5MDsmIzI0MTIwOyYjNjUyODg7JiM0MDY1ODsmIzIwMjUzOyYjNjUyODk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNS40MjgzIiB4PSIzMDMuOCIgeT0iOTMuNzAyNSI+MSA9ICYjMzYxOTY7JiMyMDI1MzsmIzY1Mjg4OyYjMjE0NjI7JiMyODA0MDsmIzY1Mjg5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0LjEzMjMiIHg9IjMwMy44IiB5PSIxMDguODM1MyI+JiMxNjA7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjM4IiB4PSIzMDMuOCIgeT0iMTIzLjk2ODEiPiYjMzYxOTY7JiM0MDY1ODsmIzIwMjUzOyYjMzEwODA7JiMzMDA1ODsmIzIxNDk1Ozo8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk1LjAwMDIiIHg9IjMwMy44IiB5PSIxMzkuMTAxIj4mIzM2MTk2OyYjMjAyNTM7JiMxMjM5ODsmIzIyNTgwOyYjMjE1MTI7JiMxMjI4OTsmIzIwODAzOyYjMjAyNTM7JiMzMTA4MDsmIzEyMzk4OyYjMzAwNTg7JiMyMTQ5NTsmIzEyNDM0OyYjMjY2ODQ7JiMzMjAxMzs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQzLjAwMDIiIHg9IjMwMy44IiB5PSIxNTQuMjMzOCI+JiMzMjAxNjsmIzIwMTg0OyYjMTIzNjk7JiMxMjM5NTsmIzEyNDI0OyYjMTI0MjY7JiMyMzY1MzsmIzI3NTA4OyYjMTI0MzQ7JiMzNjg2MTsmIzM2MzIxOzwvdGV4dD48L2c+PD9wbGFudHVtbC1zcmMgUE96Vkl5OUc2Q1JsdHF6bnlBZUVFRkhNSjkyR19iYzRIVlQyZ3VKT21EUDVIRTBzWjJNNTljWF9CMzFlTzRMWEQ1RlFmMHpwVGl4Y2JMLVhDdk9HVGxVVXRfRXlwX0NVS0w4QW9YNkFrN1IzeHRuNEtGdTBCU2s3SEljX1p1dTE4dW4zbU5Oa0ZSRlpEUHZmak96bjBjc2JTX0VCd1RuQ0YzUUJhaWRyYkxHQWViN21VdHRrT2JTY3FCOTlBd3JXLWhqRnB4LWVTR2cyODAzNlZrLUhLdzh0WUZ2NGo2d0draDZRcGNRTnJaUDNUTUpOZnNrdmJiZDh2QzBUdFo2Wm5rRlBaR1FpUFI1Y3pfVG4wWTM5WWVZQVhUcXoxU2F4YXpfMEw1cTJPY1dFWktndFQzME9FcVJPRE5SRThDdm53RU1PTGZsaXFtV21fM3llQ1NiS3RzWlJlWk0zYjVIUXJhQ0JYdzZCUTdOTVRacGgwWm9odmpoTkhCcWF3V2xIM0E5THdCbDlOWXRreUItN1ZseTFINmFSMVRWXzAwMDA/PjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<hr />
<h2 id="193-mybatis">19.3 MyBatis 版との実装比較<a class="headerlink" href="#193-mybatis" title="Permanent link">&para;</a></h2>
<h3 id="_3">データアクセス層の比較<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>機能</th>
<th>MyBatis 版</th>
<th>JPA 版</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査カラム設定</td>
<td>手動 / Interceptor</td>
<td>@EnableJpaAuditing</td>
</tr>
<tr>
<td>マスタ変更ログ</td>
<td>DB トリガー</td>
<td>@EntityListeners</td>
</tr>
<tr>
<td>ENUM 変換</td>
<td>TypeHandler</td>
<td>AttributeConverter</td>
</tr>
<tr>
<td>動的クエリ</td>
<td>XML <code>&lt;if&gt;</code> タグ</td>
<td>Specification パターン</td>
</tr>
<tr>
<td>一括保存（Cascade）</td>
<td>明示的に各テーブル INSERT</td>
<td>CascadeType.ALL</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="194">19.4 赤黒処理サービスの実装<a class="headerlink" href="#194" title="Permanent link">&para;</a></h2>
<details>
<summary>JournalCorrectionService.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.service</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.JournalRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 赤黒処理サービス</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版でもビジネスロジックは MyBatis 版と同じ</span>
<span class="cm"> * Entity の操作方法が異なる（JPA では Cascade を活用）</span>
<span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalCorrectionService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JournalRepository</span><span class="w"> </span><span class="n">journalRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BalanceUpdateService</span><span class="w"> </span><span class="n">balanceUpdateService</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳を赤黒訂正する</span>
<span class="cm">     * @param originalVoucherNumber 元伝票番号</span>
<span class="cm">     * @param correctedJournal 訂正後の仕訳（黒伝）</span>
<span class="cm">     * @return 赤伝と黒伝の仕訳伝票番号</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CorrectionResult</span><span class="w"> </span><span class="nf">correctJournal</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">originalVoucherNumber</span><span class="p">,</span>
<span class="w">            </span><span class="n">Journal</span><span class="w"> </span><span class="n">correctedJournal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 元伝票を取得</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">findByVoucherNumber</span><span class="p">(</span><span class="n">originalVoucherNumber</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;元伝票が見つかりません: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">originalVoucherNumber</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// 赤伝を作成</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">redSlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createRedSlip</span><span class="p">(</span><span class="n">original</span><span class="p">);</span>
<span class="w">        </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">redSlip</span><span class="p">);</span>
<span class="w">        </span><span class="n">balanceUpdateService</span><span class="p">.</span><span class="na">updateBalancesForJournal</span><span class="p">(</span><span class="n">redSlip</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 黒伝（訂正伝票）を登録</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">correctedJournal</span><span class="p">.</span><span class="na">isBalanced</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;訂正仕訳の貸借が一致しません&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">correctedJournal</span><span class="p">);</span>
<span class="w">        </span><span class="n">balanceUpdateService</span><span class="p">.</span><span class="na">updateBalancesForJournal</span><span class="p">(</span><span class="n">correctedJournal</span><span class="p">);</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;赤黒訂正完了: 元伝票={}, 赤伝={}, 黒伝={}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">originalVoucherNumber</span><span class="p">,</span>
<span class="w">            </span><span class="n">redSlip</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">(),</span>
<span class="w">            </span><span class="n">correctedJournal</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">());</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CorrectionResult</span><span class="p">(</span>
<span class="w">            </span><span class="n">redSlip</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">(),</span>
<span class="w">            </span><span class="n">correctedJournal</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳を取消する（赤伝のみ発行）</span>
<span class="cm">     * @param voucherNumber 取消対象の仕訳伝票番号</span>
<span class="cm">     * @return 赤伝の仕訳伝票番号</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">cancelJournal</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">voucherNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">findByVoucherNumber</span><span class="p">(</span><span class="n">voucherNumber</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;仕訳が見つかりません: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">voucherNumber</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// 既に赤伝が発行されているか確認</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="na">getRedSlipFlag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">original</span><span class="p">.</span><span class="na">getRedSlipFlag</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;この仕訳は既に取消済みです&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 赤伝を作成</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">redSlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createRedSlip</span><span class="p">(</span><span class="n">original</span><span class="p">);</span>
<span class="w">        </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">redSlip</span><span class="p">);</span>
<span class="w">        </span><span class="n">balanceUpdateService</span><span class="p">.</span><span class="na">updateBalancesForJournal</span><span class="p">(</span><span class="n">redSlip</span><span class="p">);</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳取消完了: 元伝票={}, 赤伝={}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">voucherNumber</span><span class="p">,</span><span class="w"> </span><span class="n">redSlip</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">());</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">redSlip</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 赤伝を作成する</span>
<span class="cm">     *</span>
<span class="cm">     * JPA 版では CascadeType.ALL により、</span>
<span class="cm">     * Journal を保存すると details も自動的に保存される</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Journal</span><span class="w"> </span><span class="nf">createRedSlip</span><span class="p">(</span><span class="n">Journal</span><span class="w"> </span><span class="n">original</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 赤伝の仕訳伝票番号を生成（元伝票番号 + R）</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">redVoucherNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;R&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 貸借を反転した明細を作成</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">redDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">JournalDetail</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">original</span><span class="p">.</span><span class="na">getDetails</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">reversedDCDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">JournalDebitCreditDetail</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">dcDetail</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">detail</span><span class="p">.</span><span class="na">getDebitCreditDetails</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">reversed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalDebitCreditDetail</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="na">journalVoucherNumber</span><span class="p">(</span><span class="n">redVoucherNumber</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">lineNumber</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getLineNumber</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">debitCreditLineNumber</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDebitCreditLineNumber</span><span class="p">())</span>
<span class="w">                    </span><span class="c1">// 借方→貸方、貸方→借方に反転</span>
<span class="w">                    </span><span class="p">.</span><span class="na">debitCreditType</span><span class="p">(</span>
<span class="w">                        </span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DebitCreditType</span><span class="p">.</span><span class="na">DEBIT</span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">DebitCreditType</span><span class="p">.</span><span class="na">CREDIT</span>
<span class="w">                            </span><span class="p">:</span><span class="w"> </span><span class="n">DebitCreditType</span><span class="p">.</span><span class="na">DEBIT</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">subAccountCode</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getSubAccountCode</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">departmentCode</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getDepartmentCode</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">amount</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">taxType</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getTaxType</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">taxRate</span><span class="p">(</span><span class="n">dcDetail</span><span class="p">.</span><span class="na">getTaxRate</span><span class="p">())</span>
<span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">                </span><span class="n">reversedDCDetails</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">reversed</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">redDetail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalDetail</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">journalVoucherNumber</span><span class="p">(</span><span class="n">redVoucherNumber</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">lineNumber</span><span class="p">(</span><span class="n">detail</span><span class="p">.</span><span class="na">getLineNumber</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">lineSummary</span><span class="p">(</span><span class="n">detail</span><span class="p">.</span><span class="na">getLineSummary</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;（取消）&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">debitCreditDetails</span><span class="p">(</span><span class="n">reversedDCDetails</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">            </span><span class="n">redDetails</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">redDetail</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Journal</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">journalVoucherNumber</span><span class="p">(</span><span class="n">redVoucherNumber</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">postingDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">entryDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">closingEntryFlag</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="na">getClosingEntryFlag</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">voucherType</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="na">getVoucherType</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">departmentCode</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="na">getDepartmentCode</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">redSlipFlag</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">redBlackVoucherNumber</span><span class="p">(</span><span class="n">extractNumericPart</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="na">getJournalVoucherNumber</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">details</span><span class="p">(</span><span class="n">redDetails</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">extractNumericPart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">voucherNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">voucherNumber</span><span class="p">.</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 訂正結果</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">CorrectionResult</span><span class="p">(</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">redSlipNumber</span><span class="p">,</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">blackSlipNumber</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="195">19.5 ログ管理方式の選択<a class="headerlink" href="#195" title="Permanent link">&para;</a></h2>
<p>会計システムのログ管理には、3つの方式があります。</p>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM0OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzU3cHg7aGVpZ2h0OjM0OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc1NyAzNDgiIHdpZHRoPSI3NTdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMTI1MjU7JiMxMjQ2NDsmIzMxNjQ5OyYjMjk3MDI7JiMyNjA0MTsmIzI0MzM1OyYjMTIzOTg7JiMyNzYwNDsmIzM2NjExOzwvdGl0bGU+PGRlZnMvPjxnPjxnIGNsYXNzPSJ0aXRsZSIgZGF0YS1zb3VyY2UtbGluZT0iMSI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzMDguNzUwMyIgeT0iMjIuOTk1MSI+JiMxMjUyNTsmIzEyNDY0OyYjMzE2NDk7JiMyOTcwMjsmIzI2MDQxOyYjMjQzMzU7JiMxMjM5ODsmIzI3NjA0OyYjMzY2MTE7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBhLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9ImEiIGRhdGEtc291cmNlLWxpbmU9IjMiIGlkPSJlbnQwMDAyIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjEyMS44OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI0NyIgeD0iNyIgeT0iMTE5Ljc5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjMxLjMwNjciIHg9IjE0Ljg0NjYiIHk9IjEzNC43OTIiPiYjMjYwNDE7JiMyNDMzNTtBOiAmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzMzMjU4OyYjMjAzMDc7JiMxMjM5NTsmIzEyNTI1OyYjMTI0NjQ7JiMyNDc3MzsmIzIyNTc3OyYjMTI0MzQ7JiMyNTM0NTsmIzEyMzg4OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgYi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJiIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBpZD0iZW50MDAwNCI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIxMjEuODkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTEiIHg9IjI5NCIgeT0iMTE5Ljc5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc1LjE0MjkiIHg9IjMwMS45Mjg2IiB5PSIxMzQuNzkyIj4mIzI2MDQxOyYjMjQzMzU7QjogJiMzNjE5NjsmIzQwNjU4OyYjMjA5NjY7JiMyOTcwMjsmIzEyNTM5OyYjMzU1NDI7JiMyOTcwMjsmIzIxMDY2OyYjMzg1MDA7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9ImMiIGRhdGEtc291cmNlLWxpbmU9IjExIiBpZD0iZW50MDAwNiI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIxMzguMTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTAiIHg9IjUyNSIgeT0iMTExLjY0NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc0Ljc0NjQiIHg9IjUzMi42MjY4IiB5PSIxMjYuNjQyIj4mIzI2MDQxOyYjMjQzMzU7QzogJiMxMjUyNTsmIzEyNDY0OyYjMTI0ODY7JiMxMjU0MDsmIzEyNTAyOyYjMTI1MjM7JiMxMjM5NTsmIzIwNDQ1OyYjMjMzODQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IGExLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iYS5hMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgaWQ9ImVudDAwMDMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTQuODkwNiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzUuOTk5OCIgeD0iODMiIHk9IjE2Mi43OTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iOTMiIHk9IjE3OC43OTIiPiYjMjAzMTY7JiMyNTEwNDsmIzI2MDg1OyYjMjYxNzg7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjkzIiB5PSIxOTUuMDg4OSI+JiMyNjM1NjsmIzI2MDMyOyYjMjYwODU7JiMyNjE3ODs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iOTMiIHk9IjIxMS4zODU3Ij4mIzI2MzU2OyYjMjYwMzI7JiMzMjc3MzsmIzIxNTE3OzwvdGV4dD48L2c+PCEtLWVudGl0eSBiMS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9ImIuYjEiIGRhdGEtc291cmNlLWxpbmU9IjgiIGlkPSJlbnQwMDA1Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjU0Ljg5MDYiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMy45OTk2IiB4PSIzMjMiIHk9IjE2Mi43OTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMzMzIiB5PSIxNzguNzkyIj4mIzM2MTk2OyYjMjAyNTM7JiMxMjUwMTsmIzEyNTIxOyYjMTI0NjQ7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjMzMyIgeT0iMTk1LjA4ODkiPiYjMzYxOTY7JiM0MDY1ODsmIzIwMjUzOyYjMzEwODA7JiMzMDA1ODsmIzIxNDk1OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIzMzMiIHk9IjIxMS4zODU3Ij4mIzIxMDY2OyYjMzg1MDA7JiMxMjUwMTsmIzEyNTIxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IGMxLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iYy5jMSIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGlkPSJlbnQwMDA3Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjcxLjE4NzUiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMy45OTk2IiB4PSI1NDkiIHk9IjE1NC42NDY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNTU5IiB5PSIxNzAuNjQyIj4mIzI1ODA1OyYjMjAzMTY7JiMzMTI3ODsmIzIxMDI5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1NTkiIHk9IjE4Ni45Mzg5Ij4mIzI1ODA1OyYjMjAzMTY7JiMyMTA2OTsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iNTU5IiB5PSIyMDMuMjM1NyI+JiMyNTgwNTsmIzIwMzE2OyYjMjQ0NjA7JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxLjk5OTgiIHg9IjU1OSIgeT0iMjE5LjUzMjYiPiYjMjU4MDU7JiMyMDMxNjsmIzMyNzczOzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iR01OMTAiIGRhdGEtc291cmNlLWxpbmU9IjE5IiBpZD0iZW50MDAxMSI+PHBhdGggZD0iTTE0Mi4zMiwyODUuODM2OSBMMTQyLjMyLDM0MS4yMzUzIEwzNDkuNjgwOSwzNDEuMjM1MyBMMzQ5LjY4MDksMjk1LjgzNjkgTDMzOS42ODA5LDI4NS44MzY5IEwxNDIuMzIsMjg1LjgzNjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0zMzkuNjgwOSwyODUuODM2OSBMMzM5LjY4MDksMjk1LjgzNjkgTDM0OS42ODA5LDI5NS44MzY5IEwzMzkuNjgwOSwyODUuODM2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjE0OC4zMiIgeT0iMzAyLjkwMzgiPiYjMjYzNjg7JiMxMjQxODsmIzEyNDcxOyYjMTI1MzE7JiMxMjUwMzsmIzEyNTIzOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuMDAwMiIgeD0iMTQ4LjMyIiB5PSIzMTguMDM2NiI+JiMyNjM1NjsmIzI2MDMyOyYjMjM2NTM7JiMyNzUwODsmIzEyMzk5OyYjMjA0NDU7JiMyNTM0NTsmIzEyMzc1OyYjMTIzOTQ7JiMxMjM1Njs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTg2LjM2MDkiIHg9IjE0OC4zMiIgeT0iMzMzLjE2OTQiPkpQQSAmIzEyMzkxOyYjMTIzOTk7IEBFbmFibGVKcGFBdWRpdGluZzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iR01OMTMiIGRhdGEtc291cmNlLWxpbmU9IjI1IiBpZD0iZW50MDAxNCI+PHBhdGggZD0iTTQwNC41LDI5My40MDY5IEw0MDQuNSwzMzMuNjcyNSBMNTI5LjUwMDEsMzMzLjY3MjUgTDUyOS41MDAxLDMwMy40MDY5IEw1MTkuNTAwMSwyOTMuNDA2OSBMNDA0LjUsMjkzLjQwNjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik01MTkuNTAwMSwyOTMuNDA2OSBMNTE5LjUwMDEsMzAzLjQwNjkgTDUyOS41MDAxLDMwMy40MDY5IEw1MTkuNTAwMSwyOTMuNDA2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSI0MTAuNSIgeT0iMzEwLjQ3MzgiPiYjMjAyNTA7JiMzNTMzNjsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzEyMzk1OyYjMjYzNjg7JiMzNjk2OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuMDAwMSIgeD0iNDEwLjUiIHk9IjMyNS42MDY2Ij4mIzMwNDM1OyYjMjY2MTk7JiMzNTM4ODsmIzM2MzIxOyYjMTI0MzQ7JiMzMDkwNjsmIzIwNDQ1OzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iR01OMTYiIGRhdGEtc291cmNlLWxpbmU9IjMwIiBpZD0iZW50MDAxNyI+PHBhdGggZD0iTTYyNS41LDI5My40MDY5IEw2MjUuNSwzMzMuNjcyNSBMNzUwLjUwMDEsMzMzLjY3MjUgTDc1MC41MDAxLDMwMy40MDY5IEw3NDAuNTAwMSwyOTMuNDA2OSBMNjI1LjUsMjkzLjQwNjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03NDAuNTAwMSwyOTMuNDA2OSBMNzQwLjUwMDEsMzAzLjQwNjkgTDc1MC41MDAxLDMwMy40MDY5IEw3NDAuNTAwMSwyOTMuNDA2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkxLjAwMDEiIHg9IjYzMS41IiB5PSIzMTAuNDczOCI+JiMyMzQzNjsmIzIwODQwOyYjMTIzOTQ7JiMyMzY1MzsmIzI3NTA4OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjYzMS41IiB5PSIzMjUuNjA2NiI+JiMxMjUxMDsmIzEyNDczOyYjMTI0Nzk7JiMyNjM1NjsmIzI2MDMyOyYjMTIzOTU7JiMyNjM2ODsmIzM2OTY5OzwvdGV4dD48L2c+PCEtLWxpbmsgYSB0byBiLS0+PCEtLWxpbmsgYiB0byBjLS0+PCEtLWxpbmsgYSB0byBHTU4xMC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlbnQwMDAyIiBkYXRhLWVudGl0eS0yPSJlbnQwMDExIiBkYXRhLWxpbmstdHlwZT0iYXNzb2NpYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjE5IiBpZD0ibG5rMTIiPjxwYXRoIGQ9Ik0yNDYsMjQxLjk0MzYgQzI0NiwyNDIuMjYxMyAyNDYsMjQyLjU3OTQgMjQ2LDI0Mi44OTc4IEMyNDYsMjQzLjUzNDYgMjQ2LDI0NC4xNzI3IDI0NiwyNDQuODExOSBDMjQ2LDI0Ni4wOTA0IDI0NiwyNDcuMzczIDI0NiwyNDguNjU3NyBDMjQ2LDI1MS4yMjY5IDI0NiwyNTMuODA0IDI0NiwyNTYuMzcwMyBDMjQ2LDI2Ni42MzU2IDI0NiwyNzYuNzI5NCAyNDYsMjg1LjQ2NjkiIGZpbGw9Im5vbmUiIGlkPSJhLUdNTjEwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjwhLS1saW5rIGIgdG8gR01OMTMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iZW50MDAwNCIgZGF0YS1lbnRpdHktMj0iZW50MDAxNCIgZGF0YS1saW5rLXR5cGU9ImFzc29jaWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgaWQ9ImxuazE1Ij48cGF0aCBkPSJNNDY3LDI0MS42OTM3IEM0NjcsMjQyLjAzNTUgNDY3LDI0Mi4zNzc3IDQ2NywyNDIuNzIwMyBDNDY3LDI0NC4wOTA4IDQ2NywyNDUuNDY3NiA0NjcsMjQ2Ljg0OCBDNDY3LDI1Mi4zNjk1IDQ2NywyNTcuOTQ3IDQ2NywyNjMuMzk1OSBDNDY3LDI3NC4yOTM4IDQ2NywyODQuNjc2OSA0NjcsMjkzLjA2NjkiIGZpbGw9Im5vbmUiIGlkPSJiLUdNTjEzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjwhLS1saW5rIGMgdG8gR01OMTYtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iZW50MDAwNiIgZGF0YS1lbnRpdHktMj0iZW50MDAxNyIgZGF0YS1saW5rLXR5cGU9ImFzc29jaWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIzMCIgaWQ9ImxuazE4Ij48cGF0aCBkPSJNNjg4LDI0OS45NTg1IEM2ODgsMjUwLjMwNDUgNjg4LDI1MC42NTA2IDY4OCwyNTAuOTk2NyBDNjg4LDI1Mi4zODEyIDY4OCwyNTMuNzY2MyA2ODgsMjU1LjE0OTIgQzY4OCwyNTcuOTE0OSA2ODgsMjYwLjY3MTUgNjg4LDI2My4zOTU5IEM2ODgsMjc0LjI5MzggNjg4LDI4NC42NzY5IDY4OCwyOTMuMDY2OSIgZmlsbD0ibm9uZSIgaWQ9ImMtR01OMTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48L2c+PD9wbGFudHVtbC1zcmMgVEw5REpuZjE2QnhGaHZYbXotMkxLd2RudWljeHpCMVZuS3JxUTcxeFFmZXVFcU1tV0tZcVdqX01MamVMMGNnZzhQUXJfZlh0UHRSdjV4dW9rZ1AxUnBsbGxDX2Raa1R3SW11NXFHRl84a3dWbjhxcnJSb0h1R1JtbFpoX2JlSTJhOTlaVUdPaHU1ZjZ0LU1vMkFZMDJDNl9Jb2dUdzdPQlU1VEpBNTZNdG9fMXRyR3IzbG1xR3VxTFFqMUZuMzlBRGlyNGptVWdzYjJqampocnlxcGpOd2RjblYtZFBCS2k2dEtEY29RVk5uMV9jd045elViZWsyYWhsejBqWTY3SVJVQTdORnl3c2pNMlBZZzhjcjV1MjY4Um4xY3dvcENEbkxkUzNrQmpaam1PdjliNmZha1F1Y05uY1VuWkxJM003bEFCOWVXa1hlX2szY0xsUHVvcUtkNnJMU1YwU1QyTnJKUmM2dl9hVVpzakJmdHpncXRDaTBWRERsUFhxQWM1SFRVczdWUWt2MU9NbEliZzRkRFlQWDcyWWZ2M3BRQmQ1UFRmeUpxclkzZk8xVHk3Vm0zWTN1V01rWU13UTdkUExocWh1RVRlVlZvbE1pMHhtQi1Ha1ZhUzFWdVJSLVlSTU1RT0l5eFMxb0Z0cU5PemJuTThtc3B3ODM4WFBQOGV0NGsyUWZlNE1xN240SnlaeVZ2RlRKbkNXWjBQZEUzQlk3X3lIU3ROY0ltWS1wTFAzajJGRGdjVjlHNW4xRnVEQ2tpMHBfbkZKRlMwPz48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_4">推奨される組み合わせ<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>データ種別</th>
<th>方式</th>
<th>JPA 実装</th>
</tr>
</thead>
<tbody>
<tr>
<td>マスタデータ</td>
<td>A + C</td>
<td>@EnableJpaAuditing + @EntityListeners</td>
</tr>
<tr>
<td>トランザクションデータ</td>
<td>A + B</td>
<td>@EnableJpaAuditing + 赤黒処理</td>
</tr>
<tr>
<td>サマリデータ</td>
<td>A</td>
<td>@EnableJpaAuditing のみ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="196-jpa-auditing">19.6 JPA Auditing による自動タイムスタンプ<a class="headerlink" href="#196-jpa-auditing" title="Permanent link">&para;</a></h2>
<p>JPA 版では、Spring Data JPA の Auditing 機能を使用して、作成日時・更新日時・作成者・更新者を自動的に設定できます。</p>
<h3 id="auditing">Auditing 設定<a class="headerlink" href="#auditing" title="Permanent link">&para;</a></h3>
<details>
<summary>AccountingApplication.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.config.EnableJpaAuditing</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableJpaAuditing</span><span class="w">  </span><span class="c1">// JPA Auditing を有効化</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountingApplication</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">AccountingApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="auditoraware">AuditorAware 実装（操作者の自動設定）<a class="headerlink" href="#auditoraware" title="Permanent link">&para;</a></h3>
<details>
<summary>AuditorAwareImpl.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.config</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.domain.AuditorAware</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 操作者を自動取得する AuditorAware 実装</span>
<span class="cm"> *</span>
<span class="cm"> * Spring Security と連携して、現在ログイン中のユーザーを取得</span>
<span class="cm"> * @CreatedBy, @LastModifiedBy に自動設定される</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditorAwareImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AuditorAware</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCurrentAuditor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getAuthentication</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authentication</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">authentication</span><span class="p">.</span><span class="na">isAuthenticated</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="entity">監査情報を持つ基底 Entity<a class="headerlink" href="#entity" title="Permanent link">&para;</a></h3>
<details>
<summary>BaseEntity.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.common</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Getter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Setter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.CreatedBy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.CreatedDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.LastModifiedBy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.LastModifiedDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.domain.support.AuditingEntityListener</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査情報を持つ基底 Entity</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では @EntityListeners と Auditing アノテーションで</span>
<span class="cm"> * 作成日時・更新日時・作成者・更新者を自動管理</span>
<span class="cm"> *</span>
<span class="cm"> * MyBatis 版では手動で設定していたが、JPA 版では自動化</span>
<span class="cm"> */</span>
<span class="nd">@MappedSuperclass</span>
<span class="nd">@EntityListeners</span><span class="p">(</span><span class="n">AuditingEntityListener</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BaseEntity</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@CreatedDate</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;作成日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@LastModifiedDate</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;更新日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">updatedAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@CreatedBy</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;作成者&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">createdBy</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@LastModifiedBy</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;更新者&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">updatedBy</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="197">19.7 マスタ変更ログテーブルの設計<a class="headerlink" href="#197" title="Permanent link">&para;</a></h2>
<h3 id="flyway">Flyway マイグレーション<a class="headerlink" href="#flyway" title="Permanent link">&para;</a></h3>
<details>
<summary>V010__create_change_log_table.sql</summary>

<div class="highlight"><pre><span></span><code><span class="c1">-- 操作種別</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="err">操作種別</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">);</span>

<span class="c1">-- 変更ログテーブル</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;変更ログ&quot;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="ss">&quot;ログID&quot;</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;テーブル名&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;レコードキー&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;操作種別&quot;</span><span class="w"> </span><span class="err">操作種別</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;操作前データ&quot;</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;操作後データ&quot;</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;操作日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;操作者&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;操作端末&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;備考&quot;</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="c1">-- インデックス</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_変更ログ_テーブル名&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;変更ログ&quot;</span><span class="p">(</span><span class="ss">&quot;テーブル名&quot;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_変更ログ_レコードキー&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;変更ログ&quot;</span><span class="p">(</span><span class="ss">&quot;レコードキー&quot;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;idx_変更ログ_操作日時&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;変更ログ&quot;</span><span class="p">(</span><span class="ss">&quot;操作日時&quot;</span><span class="p">);</span>
</code></pre></div>

</details>

<h3 id="entity_1">変更ログ Entity<a class="headerlink" href="#entity_1" title="Permanent link">&para;</a></h3>
<details>
<summary>ChangeLog.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.converter.OperationTypeConverter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 変更ログ Entity</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では @Entity で定義</span>
<span class="cm"> * @GeneratedValue で自動採番</span>
<span class="cm"> */</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;変更ログ&quot;</span><span class="p">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChangeLog</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Id</span>
<span class="w">    </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ログID&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">logId</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;テーブル名&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">tableName</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;レコードキー&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">recordKey</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Convert</span><span class="p">(</span><span class="n">converter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OperationTypeConverter</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作種別&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">columnDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作種別&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OperationType</span><span class="w"> </span><span class="n">operationType</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作前データ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;JSONB&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beforeData</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作後データ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;JSONB&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">afterData</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作日時&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">operatedAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作者&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">operatedBy</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;操作端末&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">operatedFrom</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;備考&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;TEXT&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">remarks</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@PrePersist</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">operatedAt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">operatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="enum-converter">操作種別 Enum と Converter<a class="headerlink" href="#enum-converter" title="Permanent link">&para;</a></h3>
<details>
<summary>OperationType.java と OperationTypeConverter.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 操作種別 Enum</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">OperationType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">INSERT</span><span class="p">,</span>
<span class="w">    </span><span class="n">UPDATE</span><span class="p">,</span>
<span class="w">    </span><span class="n">DELETE</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.converter</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.OperationType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.AttributeConverter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Converter</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 操作種別 ↔ PostgreSQL ENUM 変換</span>
<span class="cm"> */</span>
<span class="nd">@Converter</span><span class="p">(</span><span class="n">autoApply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OperationTypeConverter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AttributeConverter</span><span class="o">&lt;</span><span class="n">OperationType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">convertToDatabaseColumn</span><span class="p">(</span><span class="n">OperationType</span><span class="w"> </span><span class="n">attribute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">attribute</span><span class="p">.</span><span class="na">name</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">OperationType</span><span class="w"> </span><span class="nf">convertToEntityAttribute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dbData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dbData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">dbData</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="198-entitylistener">19.8 EntityListener によるマスタ変更ログの自動記録<a class="headerlink" href="#198-entitylistener" title="Permanent link">&para;</a></h2>
<p>JPA 版では @EntityListeners を使用して、Entity のライフサイクルイベントをフックし、変更ログを自動的に記録できます。</p>
<details>
<summary>ChangeLogListener.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.listener</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.ChangeLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.OperationType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository.ChangeLogJpaRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * マスタ変更ログを自動記録する EntityListener</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では @EntityListeners で Entity のライフサイクルをフック</span>
<span class="cm"> * MyBatis 版では DB トリガーで実装していた機能を Java コードで実現</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChangeLogListener</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ChangeLogJpaRepository</span><span class="w"> </span><span class="n">changeLogRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setChangeLogRepository</span><span class="p">(</span><span class="n">ChangeLogJpaRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChangeLogListener</span><span class="p">.</span><span class="na">changeLogRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setObjectMapper</span><span class="p">(</span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChangeLogListener</span><span class="p">.</span><span class="na">objectMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostPersist</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postPersist</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">saveChangeLog</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">INSERT</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostUpdate</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postUpdate</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">saveChangeLog</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostRemove</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postRemove</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">saveChangeLog</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">DELETE</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveChangeLog</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationType</span><span class="w"> </span><span class="n">operationType</span><span class="p">,</span>
<span class="w">                               </span><span class="n">Object</span><span class="w"> </span><span class="n">beforeData</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">afterData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">tableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTableName</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">recordKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordKey</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">beforeJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beforeData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">beforeData</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">afterJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">afterData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">afterData</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">changeLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChangeLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">tableName</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">recordKey</span><span class="p">(</span><span class="n">recordKey</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">operationType</span><span class="p">(</span><span class="n">operationType</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">beforeData</span><span class="p">(</span><span class="n">beforeJson</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">afterData</span><span class="p">(</span><span class="n">afterJson</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">operatedAt</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">operatedBy</span><span class="p">(</span><span class="n">getCurrentUser</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="n">changeLogRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">changeLog</span><span class="p">);</span>

<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;変更ログ記録: table={}, key={}, operation={}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">tableName</span><span class="p">,</span><span class="w"> </span><span class="n">recordKey</span><span class="p">,</span><span class="w"> </span><span class="n">operationType</span><span class="p">);</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;変更ログの JSON 変換に失敗しました&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getTableName</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Table</span><span class="w"> </span><span class="n">tableAnnotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">Table</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tableAnnotation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tableAnnotation</span><span class="p">.</span><span class="na">name</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getSimpleName</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getRecordKey</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getCurrentUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getAuthentication</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;system&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="entitylistener-entity">EntityListener を使用する Entity<a class="headerlink" href="#entitylistener-entity" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Account Entity に @EntityListeners を追加</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">)</span>
<span class="nd">@EntityListeners</span><span class="p">(</span><span class="n">ChangeLogListener</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">  </span><span class="c1">// 変更ログを自動記録</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Account</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseEntity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のフィールド</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="199">19.9 変更ログリポジトリの実装<a class="headerlink" href="#199" title="Permanent link">&para;</a></h2>
<h3 id="jparepository-specification">JpaRepository と Specification<a class="headerlink" href="#jparepository-specification" title="Permanent link">&para;</a></h3>
<details>
<summary>ChangeLogJpaRepository.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.ChangeLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.OperationType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.JpaSpecificationExecutor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.Query</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.query.Param</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 変更ログ JpaRepository</span>
<span class="cm"> *</span>
<span class="cm"> * JpaSpecificationExecutor を継承して動的クエリに対応</span>
<span class="cm"> */</span>
<span class="nd">@Repository</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ChangeLogJpaRepository</span>
<span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                </span><span class="n">JpaSpecificationExecutor</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * テーブル名とレコードキーで検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByTableNameAndRecordKeyOrderByOperatedAtDesc</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">tableName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">recordKey</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * テーブル名で検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByTableNameOrderByOperatedAtDesc</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tableName</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 操作種別で検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByOperationTypeOrderByOperatedAtDesc</span><span class="p">(</span><span class="n">OperationType</span><span class="w"> </span><span class="n">operationType</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 期間指定で検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;SELECT c FROM ChangeLog c &quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">           </span><span class="s">&quot;WHERE c.operatedAt BETWEEN :from AND :to &quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">           </span><span class="s">&quot;ORDER BY c.operatedAt DESC&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByDateRange</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">from</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">to</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 操作者で検索</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByOperatedByOrderByOperatedAtDesc</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">operatedBy</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="specification">Specification による動的クエリ<a class="headerlink" href="#specification" title="Permanent link">&para;</a></h3>
<details>
<summary>ChangeLogSpecifications.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.specification</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.ChangeLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.OperationType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 変更ログ検索用 Specification</span>
<span class="cm"> *</span>
<span class="cm"> * JPA 版では Specification パターンで動的クエリを構築</span>
<span class="cm"> * MyBatis 版では XML の &lt;if&gt; タグで動的 SQL を構築していた</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChangeLogSpecifications</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">tableNameEquals</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tableName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">tableName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">equal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tableName&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">tableName</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">recordKeyEquals</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">recordKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">recordKey</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">equal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;recordKey&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">recordKey</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">operationTypeEquals</span><span class="p">(</span><span class="n">OperationType</span><span class="w"> </span><span class="n">operationType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">operationType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">equal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;operationType&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">operationType</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">operatedAtAfter</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">from</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">greaterThanOrEqualTo</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;operatedAt&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">from</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">operatedAtBefore</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">lessThanOrEqualTo</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;operatedAt&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">to</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">ChangeLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">operatedByEquals</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">operatedBy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">operatedBy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cb</span><span class="p">.</span><span class="na">equal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;operatedBy&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">operatedBy</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="1910">19.10 変更ログリポジトリのテスト<a class="headerlink" href="#1910" title="Permanent link">&para;</a></h2>
<details>
<summary>ChangeLogRepositoryTest.java</summary>

<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.ChangeLogRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.ChangeLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.OperationType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Import</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.DynamicPropertyRegistry</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.DynamicPropertySource</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.containers.PostgreSQLContainer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.junit.jupiter.Container</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.*</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 変更ログリポジトリのテスト</span>
<span class="cm"> */</span>
<span class="nd">@DataJpaTest</span>
<span class="nd">@AutoConfigureTestDatabase</span><span class="p">(</span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutoConfigureTestDatabase</span><span class="p">.</span><span class="na">Replace</span><span class="p">.</span><span class="na">NONE</span><span class="p">)</span>
<span class="nd">@Testcontainers</span>
<span class="nd">@Import</span><span class="p">(</span><span class="n">ChangeLogRepositoryImpl</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;変更ログリポジトリ&quot;</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">ChangeLogRepositoryTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Container</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">PostgreSQLContainer</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PostgreSQLContainer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;postgres:16&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withDatabaseName</span><span class="p">(</span><span class="s">&quot;testdb&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withUsername</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">withPassword</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nd">@DynamicPropertySource</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configureProperties</span><span class="p">(</span><span class="n">DynamicPropertyRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.url&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getJdbcUrl</span><span class="p">);</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.username&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getUsername</span><span class="p">);</span>
<span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;spring.datasource.password&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postgres</span><span class="p">::</span><span class="n">getPassword</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ChangeLogRepository</span><span class="w"> </span><span class="n">changeLogRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;登録&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">Insert</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;変更ログを登録できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">canInsertChangeLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">changeLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChangeLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="na">tableName</span><span class="p">(</span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">recordKey</span><span class="p">(</span><span class="s">&quot;11100&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">operationType</span><span class="p">(</span><span class="n">OperationType</span><span class="p">.</span><span class="na">INSERT</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">afterData</span><span class="p">(</span><span class="s">&quot;{\&quot;勘定科目コード\&quot;:\&quot;11100\&quot;,\&quot;勘定科目名\&quot;:\&quot;現金\&quot;}&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">operatedBy</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// Act</span>
<span class="w">            </span><span class="n">changeLogRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">changeLog</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">changeLog</span><span class="p">.</span><span class="na">getLogId</span><span class="p">()).</span><span class="na">isNotNull</span><span class="p">();</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeLogRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">changeLog</span><span class="p">.</span><span class="na">getLogId</span><span class="p">());</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="na">isPresent</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getTableName</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getOperationType</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">OperationType</span><span class="p">.</span><span class="na">INSERT</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;検索&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">Search</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;テーブル名とレコードキーで検索できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">canFindByTableNameAndRecordKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Act</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeLogRepository</span><span class="p">.</span><span class="na">findByTableNameAndRecordKey</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;11100&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="na">allMatch</span><span class="p">(</span><span class="n">log</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">getTableName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">getRecordKey</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;11100&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;複合条件で検索できる&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">canFindByConditions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Act: Specification パターンで動的クエリ</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeLogRepository</span><span class="p">.</span><span class="na">findByConditions</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;勘定科目マスタ&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                    </span><span class="n">OperationType</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="na">allMatch</span><span class="p">(</span><span class="n">log</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">getOperationType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<h2 id="1911">19.11 まとめ：設計のポイント<a class="headerlink" href="#1911" title="Permanent link">&para;</a></h2>
<h3 id="_5">赤黒処理によるデータ訂正<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ol>
<li>物理削除を行わず、赤伝で打ち消し</li>
<li>監査証跡の確保</li>
<li>残高の自動調整</li>
<li>JPA 版では CascadeType.ALL で一括保存</li>
</ol>
<h3 id="_6">ログ管理方式の使い分け<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>データ種別</th>
<th>方式</th>
<th>JPA 実装</th>
</tr>
</thead>
<tbody>
<tr>
<td>マスタデータ</td>
<td>ログテーブル方式</td>
<td>@EntityListeners</td>
</tr>
<tr>
<td>トランザクションデータ</td>
<td>赤黒処理</td>
<td>Cascade 保存</td>
</tr>
<tr>
<td>サマリデータ</td>
<td>更新日時のみ</td>
<td>@EnableJpaAuditing</td>
</tr>
</tbody>
</table>
<h3 id="jpa-auditing">JPA Auditing による自動化<a class="headerlink" href="#jpa-auditing" title="Permanent link">&para;</a></h3>
<ul>
<li>@CreatedDate, @LastModifiedDate で日時自動設定</li>
<li>@CreatedBy, @LastModifiedBy で操作者自動設定</li>
<li>AuditorAware で Spring Security 連携</li>
</ul>
<h3 id="mybatis">MyBatis 版との比較<a class="headerlink" href="#mybatis" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>MyBatis 版</th>
<th>JPA 版</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査カラム設定</td>
<td>手動 / Interceptor</td>
<td>@EnableJpaAuditing</td>
</tr>
<tr>
<td>マスタ変更ログ</td>
<td>DB トリガー</td>
<td>@EntityListeners</td>
</tr>
<tr>
<td>ENUM 変換</td>
<td>TypeHandler</td>
<td>AttributeConverter</td>
</tr>
<tr>
<td>動的クエリ</td>
<td>XML <code>&lt;if&gt;</code> タグ</td>
<td>Specification パターン</td>
</tr>
<tr>
<td>自動採番</td>
<td>useGeneratedKeys</td>
<td>@GeneratedValue</td>
</tr>
<tr>
<td>テスト</td>
<td>@MybatisTest</td>
<td>@DataJpaTest</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_7">次章予告<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p><a href="../chapter20-orm/">第20章</a>では、D社（化粧品製造販売）の事例に基づいて、Seedデータを作成します。JPA 版では CommandLineRunner と @Transactional を使用したデータ投入を実装します。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works/practical-database-design" target="_blank" rel="noopener" title="GitHub Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>