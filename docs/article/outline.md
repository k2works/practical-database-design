# 実践データベース設計：基幹業務システム編

## 記事の目的

基幹業務システム（販売管理・財務会計・生産管理）のデータベース設計を、業務フローとデータモデルの観点から体系的に解説する。

## 対象読者

- データベース設計の基礎を学びたいエンジニア
- 基幹業務システムの全体像を理解したい開発者
- 販売管理・財務会計・生産管理の業務知識を習得したい方

## 執筆方針

- ダイアグラムには PlantUML を使用
- 業務フローと ER 図を中心に解説
- 日本語テーブル・日本語カラムでデータベースを定義
- 実装はコード部分は``<details>``タグを使って表示を切り替えられるようにする

---

# 第1部：基幹業務システムの全体像

## 第1章：基幹業務システムとは

### 1.1 ドメイン駆動設計と基幹業務システム

- 戦略的設計と戦術的設計
- 基幹業務システムへの適用

### 1.2 基幹業務システムを構成するサブシステム

- 販売管理システム
- 財務会計システム
- 生産管理システム
- 人事システム

---

## 第2章：基幹業務システムの業務領域

### 2.1 販売管理領域

- 受注・出荷・売上
- 得意先との関係

### 2.2 購買管理領域

- 発注・入荷/受入・仕入（検収）
- 仕入先・委託先との関係

### 2.3 在庫管理領域

- 在庫の受払
- 販売管理・購買管理・生産管理との連携

### 2.4 生産管理領域

- 生産計画・品質管理・工程管理・製造原価管理
- 購買管理・在庫管理との連携

### 2.5 債権管理領域

- 請求・入金
- 販売管理との連携

### 2.6 債務管理領域

- 支払・出金
- 購買管理との連携

### 2.7 会計領域

- 仕訳・決算
- 債権・債務・生産管理からの仕訳連携

### 2.8 人事領域

- 給与計算・人事管理
- 会計との連携

---

## 第3章：業務フローの全体像

### 3.1 販売管理システムの業務フロー

- 得意先 → 営業部門 → 販売管理
- 販売管理 → 調達管理 / 在庫管理 / 債権管理
- 調達管理 → 仕入先 / 在庫管理 / 債務管理

### 3.2 財務会計システムの業務フロー

- 会計部門 → 財務会計 / 管理会計
- 財務会計：債権・債務・手形・資産・経理
- 管理会計：経営分析・損益分岐点分析・投資の経済性計算・キャッシュフロー計算

### 3.3 生産管理システムの業務フロー

- 得意先 → 営業部門 → 生産計画
- 生産計画 → 購買管理 / 工程管理
- 購買管理 → 仕入先 / 委託先 / 在庫管理
- 工程管理 → 在庫管理 / 製造原価管理 / 品質管理
- 基準情報との連携

---

# 第2部：販売管理システム

## 第4章：販売管理システムの全体像

### 4.1 販売管理システムのスコープ

- 見積
- 受注
- 出荷
- 売上

### 4.2 販売組織の役割分担

- 営業部門・調達部門・倉庫部門・経理部門・財務部門
- 業務フローと各部門の責務

---

## 第5章：マスタ情報の設計

### 5.1 部門マスタの設計

- 組織階層と部門パス
- 最下層区分の管理
- 組織改正に強いマスタ設計（履歴管理）
- 複数組織図と所在地の対応

### 5.2 社員マスタの設計

- 部門との関連付け
- 適用期間を持つ履歴管理

### 5.3 商品マスタの設計

- 商品コード・商品名・単価
- 商品区分と税区分
- 商品分類の階層構造（商品分類パス）
- 顧客別販売単価の管理

### 5.4 原価管理の設計

- 8種類の原価法の理解
  - 個別原価法
  - 先入先出法
  - 後入先出法
  - 総平均法
  - 移動平均法
  - 単純平均法
  - 最終仕入原価法
  - 売価還元法

### 5.5 消費税の設計

- 外税・内税・非課税の区分
- 消費税計算の考え方

### 5.6 顧客マスタの設計

- 取引先コードと顧客枝番
- 請求先・回収先の概念
- 出荷先マスタとの連携
- 地域マスタによる分類

### 5.7 取引条件の設計

- 締日・支払月・支払日の管理
- 都度請求と締め請求の違い
- 与信管理（与信限度額・一時増加枠）

---

## 第6章：受注・出荷・売上の設計

### 6.1 受注業務の DB 設計

- 受注業務フローの理解
- 受注データ・受注明細データの構造
- 顧客マスタ・商品マスタとの連携

### 6.2 出荷業務の DB 設計

- 出荷業務の流れ
- 出荷指示データ・出荷明細データ
- 在庫との連携

### 6.3 売上業務の DB 設計

- 売上データ・売上明細データの構造
- 出荷完了から売上計上への流れ
- 返品処理の設計
- 赤黒処理の考え方

---

## 第7章：債権管理の設計

### 7.1 請求業務の DB 設計

- 都度請求と締め請求
- 請求データ・請求明細の構造
- 締処理の設計

### 7.2 回収業務の DB 設計

- 入金方法の種類（現金・振込・手形等）
- 入金データ・入金明細の構造
- 入金消込の処理
- 債権残高管理

---

## 第8章：調達管理の設計

### 8.1 発注業務の DB 設計

- 調達の4つのパターン
- 発注データ・発注明細データの構造
- 仕入先マスタとの連携

### 8.2 入荷・検収業務の DB 設計

- 入荷データの構造
- 検収（仕入計上）処理
- 諸口品目の扱い

---

## 第9章：在庫管理の設計

### 9.1 在庫情報の DB 設計

- 倉庫コード × 商品コードの在庫管理
- 在庫数量・引当数量の管理
- 倉庫マスタの設計

### 9.2 在庫移動・棚卸の DB 設計

- 入出庫履歴の管理
- 棚卸業務の設計
- 在庫調整処理

---

## 第10章：債務管理の設計

### 10.1 支払業務の DB 設計

- 支払締処理
- 支払方法の種類
- 支払データ・支払明細の構造
- 買掛金残高管理

---

# 第3部：財務会計システム

## 第11章：財務会計システムの全体像

### 11.1 財務会計システムのスコープ

- 債権管理（請求・入金）
- 債務管理（支払・出金）
- 経理（仕訳・決算）

### 11.2 財務会計と管理会計の違い

- 財務会計：外部報告目的
- 管理会計：内部意思決定目的

---

## 第12章：勘定科目の設計

### 12.1 勘定科目マスタの設計

- 勘定科目コード・勘定科目名
- BSPL 区分（貸借対照表 / 損益計算書）
- 貸借区分（借方 / 貸方）
- 取引要素区分（資産・負債・資本・収益・費用）
- 集計区分（見出科目・集計科目・明細科目）
- 管理会計区分・費用区分
- 補助科目種別
- 消費税計算区分・課税取引コード
- 期日管理区分

### 12.2 勘定科目構成マスタの設計

- チルダ連結方式による階層構造
- 貸借対照表の科目ツリー構造
- 科目残高集計の考え方

### 12.3 課税取引マスタの設計

- 課税取引コード・税率の管理

---

## 第13章：仕訳の設計

### 13.1 仕訳テーブルの設計

- 仕訳伝票番号・起票日・入力日
- 決算仕訳フラグ・単複フラグ
- 仕訳伝票区分
- 部門コード・社員コード
- 赤伝フラグ・赤黒伝票番号

### 13.2 仕訳明細の設計

- 仕訳行番号・行摘要

### 13.3 仕訳貸借明細の設計

- 貸借区分（借方 / 貸方）
- 勘定科目コード・補助科目コード
- 仕訳金額・基軸換算仕訳金額
- 通貨コード・為替レート
- 部門コード・プロジェクトコード・セグメントコード
- 消費税区分・消費税率・消費税計算区分
- 期日・資金繰フラグ
- 相手勘定科目・相手補助科目
- 付箋コード・付箋内容

---

## 第14章：自動仕訳の設計

### 14.1 自動仕訳の概要

- 販売管理システムと会計システムの連携
- 手入力による非連携（アナログ連携）の課題
- 自動仕訳処理のデータフロー

### 14.2 自動仕訳パターンマスタの設計

- 商品グループ × 顧客グループによる条件分岐
- 借方科目・貸方科目の自動判定
- 売上返品時の科目設定

### 14.3 自動仕訳処理の設計

- フラグ管理方式と日付管理方式
- セット中心のアプリケーション設計
- ループ処理との比較

### 14.4 売上伝票から仕訳伝票への転記ロジック

- 明細行の分解と集約
- 借方（売掛金）と貸方（売上）の展開
- 消費税の按分計算
- 貸借一致の原則

---

## 第15章：勘定科目残高の設計

### 15.1 日次勘定科目残高の設計

- 起票日 × 勘定科目 × 補助科目 × 部門 × プロジェクト
- 借方金額・貸方金額
- 日計表の出力

### 15.2 月次勘定科目残高の設計

- 決算期 × 月度による管理
- 月初残高・月末残高
- 合計残高試算表の出力

### 15.3 残高更新のタイミング

- 仕訳入力時の即時更新
- バッチ処理による集計

---

## 第16章：赤黒とログの設計

### 16.1 3つのアプローチ

- データ自体にログ情報を持つ方式
- 赤黒処理・論理削除方式
- ログテーブルにログ情報を保存する方式

### 16.2 業務システムでの使い分け

- 会計絡みは赤黒処理
- マスタ関連はログテーブル
- それ以外はデータ自体にログ

---

# 第4部：生産管理システム

## 第17章：生産管理システムの全体像

### 17.1 生産管理システムのスコープ

- 生産計画（MPS・MRP）
- 購買管理（発注・入荷・検収）
- 工程管理（製造指示・製造実績）
- 在庫管理（受払・在庫状態）
- 品質管理（受入検査・出荷検査・トレーサビリティ）
- 製造原価管理（標準原価・実際原価・配賦）

### 17.2 生産組織の役割分担

- 営業部・生産管理部・製造部・購買部・外注部
- 資材倉庫・製品倉庫
- 業務フローと各部門の責務

---

## 第18章：生産管理のマスタ情報（モノ）

### 18.1 品目マスタの設計

- 品目コード・品名
- 品目区分（製品・半製品・中間品・部品・材料・原料・資材）
- 品目グループコード
- 単位コード・場所コード
- リードタイム・安全リードタイム・安全在庫数
- 歩留率・最小ロット数・刻みロット数・最大ロット数
- 有効期間

### 18.2 BOM（部品表）の設計

- 親品目コード × 子品目コード
- 基準量・必要量・不良率
- 工順
- 適用期間（開始日・停止日）

### 18.3 工程表の設計

- 品目コード × 工順
- 工程コードとの紐付け

### 18.4 工程マスタの設計

- 工程コード・工程名

### 18.5 単価マスタの設計

- 品目コード × 取引先コード × ロット単位数
- 単価・適用期間

---

## 第19章：生産管理のマスタ情報（時・人・場所）

### 19.1 カレンダーの設計

- 就業日マスタ（日付・就業区分・シフトコード）
- 就業時間マスタ（シフト・時刻FROM/TO・種別）

### 19.2 担当者マスタの設計

- 担当者コード・担当者名
- 部門コード・メールアドレス
- 適用期間

### 19.3 場所マスタの設計

- 場所コード・場所名・場所種類コード
- 取引先コード・部門コード

### 19.4 倉庫マスタの設計

- 倉庫コード・倉庫区分・倉庫名
- 部門コード

### 19.5 部門マスタの設計

- 部門コード・部門名
- 上位部門・部門階層
- 適用期間

### 19.6 資源マスタの設計

- 資源コード・資源名
- 資源と部門の多対多関係

### 19.7 取引先マスタの設計

- 取引先コード・取引先名
- 連絡先情報
- 就業日パターンコード

---

## 第20章：生産計画の設計

### 20.1 生産計画の特徴

- 計画系と実績系の違い
- バリエーションの豊富さ

### 20.2 計画系の流れ

1. ビジネスプラン（中期経営計画）
2. 年間販売計画
3. 月次販売／生産計画
4. 基準生産計画（MPS）
5. 所要量展開（MRP）/ スケジューラ
6. 購買オーダ
7. 製造オーダ

### 20.3 所要量展開（MRP）処理の概要

- オーダ情報の構造
- 所要情報の構造
- 引当情報の構造
- 在庫推移・発注残・製造残との連携

---

## 第21章：購買管理の設計（発注・入荷・検収）

### 21.1 発注業務の DB 設計

- 発注データ・発注明細データの構造
- オーダ情報・場所マスタ・単価マスタとの連携
- 諸口品目の扱い

### 21.2 入荷・受入業務の DB 設計

- 入荷受入データの構造
- 発注明細との紐付け
- 入荷受入区分（入荷 / 受入返品）

### 21.3 受入検査業務の DB 設計

- 受入検査データの構造
- 受入検査結果データ（欠点コード・数量）
- 欠点マスタの設計

### 21.4 検収業務の DB 設計

- 検収データの構造
- 検収単価・検収金額・消費税

### 21.5 検収返品の DB 設計

- 検収返品データの構造
- 発注明細との紐付け

---

## 第22章：購買管理の設計（外注委託）

### 22.1 外部委託業務の流れ

- 有償支給と無償支給
- 外注委託の業務フロー

### 22.2 支給品の DB 設計

- 支給データ・支給明細データの構造
- 発注データとの紐付け

### 22.3 消費の DB 設計

- 消費データ・消費明細データの構造
- 入荷受入データとの紐付け

---

## 第23章：工程管理の設計（製造指示・製造実績）

### 23.1 工程管理業務の流れ

- 製造指示から製造実績への流れ
- 作業指示書とピッキングリスト

### 23.2 作業指示の DB 設計

- 作業指示データの構造
- 作業指示明細データ（工順・工程コード）
- オーダ情報・工程表との連携

### 23.3 完成実績の DB 設計

- 完成実績データの構造
- 完成数量・良品数・不良品数
- 完成検査結果データ（欠点コード）

### 23.4 消費実績の DB 設計

- 完成実績消費データ・消費明細データ
- 場所コードとの紐付け

### 23.5 工数実績の DB 設計

- 工数実績データの構造
- 作業指示明細との紐付け
- 担当者・部門・工数の記録

---

## 第24章：在庫管理の設計（受払・在庫状態）

### 24.1 在庫情報の DB 設計

- 場所コード × 品目コード
- 在庫数・合格数・不良数・未検査数

### 24.2 払出業務の DB 設計

- 払出指示データ・払出指示明細データ
- オーダ情報・BOM との連携
- 払出データ・払出明細データの構造

### 24.3 支給データとの統合

- 払出区分（自社 / 外注）
- 計画区分（計画 / 計画外）

### 24.4 棚卸業務の DB 設計

- 棚卸表発行・実棚入力
- 帳簿在庫と実棚在庫の差異分析
- 在庫調整データの構造

---

## 第25章：品質管理の設計

### 25.1 品質管理の概要

- 受入検査・出荷検査
- トレーサビリティ

---

## 第26章：製造原価管理の設計

### 26.1 製造原価管理の概要

- 標準原価と実際原価
- 製造原価配賦の考え方

---

# 第5部：エンタープライズインテグレーション

## 第27章：システム統合の概要

### 27.1 なぜシステム統合が必要か

- サイロ化した基幹業務システムの課題
- データの一貫性と整合性の確保
- リアルタイム連携とバッチ連携

### 27.2 境界付けられたコンテキスト

- 境界付けられたコンテキスト（Bounded Context）とは
- 基幹業務システムにおけるコンテキストの識別
  - 販売コンテキスト
  - 会計コンテキスト
  - 生産コンテキスト
- コンテキストマップの作成
- コンテキスト間の関係パターン
  - 共有カーネル（Shared Kernel）
  - 顧客/供給者（Customer/Supplier）
  - 適合者（Conformist）
  - 腐敗防止層（Anti-Corruption Layer）
  - 公開ホストサービス（Open Host Service）
  - 公表された言語（Published Language）

### 27.3 統合パターンの選択基準

- 同期 vs 非同期
- ポイントツーポイント vs ハブ&スポーク
- データ統合 vs プロセス統合

---

## 第28章：メッセージングパターン

### 28.1 メッセージングの基礎

- メッセージチャネル（Message Channel）
- メッセージ（Message）の構造
- パイプとフィルター（Pipes and Filters）

### 28.2 メッセージルーティング

- Content-Based Router（内容ベースルーター）
- Message Filter（メッセージフィルター）
- Splitter / Aggregator（分割 / 集約）
- Resequencer（再順序付け）

### 28.3 メッセージ変換

- Message Translator（メッセージ変換）
- Envelope Wrapper（エンベロープラッパー）
- Content Enricher（コンテンツエンリッチャー）
- Canonical Data Model（標準データモデル）

---

## 第29章：システム間連携パターン

### 29.1 販売管理と財務会計の連携

- 売上データから仕訳データへの変換
- 自動仕訳パターンの適用
- イベント駆動による仕訳生成

### 29.2 販売管理と生産管理の連携

- 受注情報から生産計画への連携
- 需要予測データの共有
- 在庫情報の同期

### 29.3 生産管理と財務会計の連携

- 製造原価から仕訳への変換
- 検収データの会計連携
- 棚卸差異の会計処理

---

## 第30章：マスタデータ管理（MDM）

### 30.1 マスタデータ統合の課題

- 各システムでのマスタ重複
- コード体系の不一致
- 更新タイミングの同期

### 30.2 MDM パターン

- Registry Style（参照型）
- Consolidation Style（統合型）
- Coexistence Style（共存型）
- Transaction Hub Style（トランザクションハブ型）

### 30.3 共通マスタの設計

- 取引先マスタの統合
- 商品/品目マスタの統合
- 部門・組織マスタの統合

---

## 第31章：イベント駆動アーキテクチャ

### 31.1 イベント駆動の基礎

- ドメインイベントとは
- イベントソーシング
- CQRS（コマンドクエリ責務分離）

### 31.2 基幹業務システムのイベント設計

- 販売管理イベント（受注確定・出荷完了・売上計上）
- 財務会計イベント（仕訳登録・月次締め・決算確定）
- 生産管理イベント（製造指示・完成報告・検収完了）

### 31.3 イベントストアの設計

- イベントテーブルの構造
- スナップショットの管理
- イベントの再生とリプレイ

---

## 第32章：API 設計とサービス連携

### 32.1 API 設計の原則

- RESTful API の設計
- リソース指向設計
- バージョニング戦略

### 32.2 サービス間通信

- 同期通信（REST / gRPC）
- 非同期通信（メッセージキュー）
- サーキットブレーカーパターン

### 32.3 API ゲートウェイ

- 認証・認可の一元化
- レート制限とスロットリング
- ログ集約とモニタリング

---

## 第33章：データ連携の実装パターン

### 33.1 バッチ連携

- ファイル連携（CSV / XML / JSON）
- ETL 処理の設計
- 差分抽出と全件抽出

### 33.2 リアルタイム連携

- Change Data Capture（CDC）
- データベーストリガーの活用
- メッセージキューによる非同期連携

### 33.3 連携テーブルの設計

- 連携ステータス管理
- エラーハンドリングとリトライ
- 冪等性の確保

---

# 付録

## A：全体 ER 図

### A.1 基幹業務システム全体図

- 各サブシステム間の連携

### A.2 販売管理システム ER 図

- マスタ系テーブルの関連
- トランザクション系テーブルの関連

### A.3 財務会計システム ER 図

- 勘定科目系テーブルの関連
- 仕訳系テーブルの関連

### A.4 生産管理システム ER 図

- 品目・BOM・工程系テーブルの関連
- 購買・工程管理・在庫系テーブルの関連

## B：テーブル定義一覧

- 各テーブルのカラム定義
- 主キー・外部キー一覧

## C：用語集

- 基幹業務システム用語
- 販売管理用語
- 財務会計用語
- 生産管理用語
